<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Pokemon Scaling Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Space Mono', monospace;
            background: #0c1119;
            color: #c8d8e8;
            padding: 2rem 3rem;
            max-width: 1100px;
            margin: 0 auto;
        }
        h1 {
            color: #4a9eff;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(74,158,255,0.5);
        }
        .subtitle {
            text-align: center;
            color: #6a8aaa;
            font-size: 0.7rem;
            margin-bottom: 1.5rem;
            letter-spacing: 2px;
        }

        /* Level Finder */
        .level-finder {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.8rem 1.2rem;
            background: #132438;
            border: 1px solid #1e3a5f;
            border-radius: 8px;
        }
        .level-finder label {
            color: #6a8aaa;
            font-size: 0.7rem;
            letter-spacing: 1px;
        }
        .level-finder input {
            background: #0c1119;
            border: 1px solid #1e3a5f;
            color: #4a9eff;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 0.3rem 0.6rem;
            width: 100px;
            border-radius: 4px;
            outline: none;
        }
        .level-finder input:focus { border-color: #4a9eff; }
        .level-finder .finder-result {
            font-size: 0.7rem;
            color: #4dd0c4;
            min-width: 300px;
        }
        .finder-result img {
            width: 32px; height: 32px;
            image-rendering: pixelated;
            vertical-align: middle;
            margin-right: 0.3rem;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: #132438;
            border-radius: 3px;
            margin-bottom: 2rem;
            overflow: hidden;
            border: 1px solid #1e3a5f;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #4dd0c4);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Gen Divider Banner */
        .gen-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            padding: 1.2rem 1.5rem;
            margin: 1.5rem 0;
            background: linear-gradient(135deg, #1a3a2a, #0f2a3a, #1a2a3a);
            border: 1px solid #2a5a4a;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .gen-divider::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(74,200,160,0.08), transparent);
        }
        .gen-divider .gen-starters {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        .gen-divider .gen-starters img {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
        }
        .gen-divider .gen-text {
            text-align: center;
        }
        .gen-divider .gen-title {
            font-size: 1rem;
            color: #4dd0c4;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(77,208,196,0.4);
            font-weight: 700;
        }
        .gen-divider .gen-sub {
            font-size: 0.55rem;
            color: #6a9a8a;
            letter-spacing: 2px;
            margin-top: 0.2rem;
        }

        /* Phases */
        .phase { margin-bottom: 0.5rem; }
        .phase-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #1e3a5f;
            user-select: none;
            position: relative;
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        .phase-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--bg-url);
            background-size: cover;
            background-position: center;
            image-rendering: pixelated;
            z-index: -2;
            opacity: 0.9;
        }
        .phase-header::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(12,17,25,0.6), rgba(12,17,25,0.75));
            z-index: -1;
        }
        .phase-header:hover::after {
            background: linear-gradient(90deg, rgba(12,17,25,0.5), rgba(12,17,25,0.65));
        }
        .phase-title {
            font-size: 0.8rem;
            color: #4a9eff;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
        }
        .phase-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .phase-count {
            font-size: 0.55rem;
            color: #c8d8e8;
            letter-spacing: 1px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .phase-toggle {
            font-size: 0.7rem;
            color: #c8d8e8;
            transition: transform 0.2s;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .phase.collapsed .phase-toggle { transform: rotate(-90deg); }
        .phase-body {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .phase.collapsed .phase-body {
            max-height: 0 !important;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5rem 0 1rem;
        }
        th {
            text-align: left;
            font-size: 0.55rem;
            color: #6a8aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #1e3a5f;
        }
        td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #132438;
            font-size: 0.68rem;
        }
        tr:hover { background: #132438; }
        tr.highlight {
            background: rgba(74,158,255,0.12) !important;
            box-shadow: inset 0 0 0 1px rgba(74,158,255,0.3);
        }
        tr.highlight td { border-bottom-color: rgba(74,158,255,0.2); }
        .pokemon-name { color: #e8f0f8; font-weight: 700; }
        .profit { color: #4dd0c4; }
        .lv { color: #6a8aaa; font-size: 0.65rem; }
        .gap { color: #6a8aaa; font-size: 0.6rem; }
        .sprite { width: 40px; height: 40px; image-rendering: pixelated; vertical-align: middle; }
        .size-t1 { color: #4a9eff; font-weight: 700; }
        .size-mid { color: #6ab4ff; }
        .size-t5 { color: #6a8aaa; }
        .total-risk { color: #4dd0c4; font-weight: 700; font-size: 0.6rem; }
        .est { color: #6a8aaa; font-size: 0.58rem; }
        .est-active { color: #4dd0c4; font-weight: 700; font-size: 0.58rem; }
        .est-past { color: #3a5a3a; font-size: 0.58rem; }

        /* Notes */
        .notes {
            margin-top: 2rem;
            padding: 1rem 1.5rem;
            background: #132438;
            border: 1px solid #1e3a5f;
            border-radius: 8px;
            font-size: 0.65rem;
            color: #6a8aaa;
            line-height: 1.8;
        }
        .notes h3 {
            color: #4a9eff;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        .notes code {
            background: #0c1119;
            color: #4dd0c4;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            h1 { font-size: 1.4rem; }
            .level-finder { flex-wrap: wrap; }
            .finder-result { min-width: auto; }
            td, th { padding: 0.3rem 0.3rem; font-size: 0.58rem; }
            .sprite { width: 32px; height: 32px; }
        }
    </style>
</head>
<body>
    <h1>Crypto Pokemon Scaling Guide</h1>
    <div class="subtitle">151 LEVELS &middot; 5 TRADES PER SESSION &middot; $0 &mdash; $30,000 PROFIT</div>

    <div class="level-finder" style="flex-wrap:wrap;">
        <div class="finder-result" id="finderResult" style="width:100%;text-align:center;">Loading stats...</div>
        <div id="statsInfo" style="width:100%;text-align:center;font-size:0.6rem;color:#6a8aaa;margin-top:0.3rem;"></div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>

    <div id="phases"></div>

    <div class="notes">
        <h3>How It Works</h3>
        <p>Your <strong>overall crypto P&L</strong> determines your Pokemon level and trade sizes.</p>
        <p>Each level unlocks 5 position sizes: <code>T1</code> (lead trade, biggest) through <code>T5</code> (smallest, ~half of T1).</p>
        <p><strong>Total Risk</strong> = sum of all 5 trade sizes. Stays around 0.5-1% of profit at higher levels.</p>
        <p>Early levels ($0-$500): fine-grained $25-$50 steps with graduated sizing.</p>
        <p>Later levels: smooth power curve — sizes grow steadily but with diminishing increments.</p>
        <p style="margin-top:0.8rem">
            <strong>Regions map to crypto phases:</strong><br>
            Pallet Town → Proving &middot;
            Pewter → Early Scaling &middot;
            Cerulean/Vermilion → Building &middot;
            Celadon/Fuchsia → Ramping &middot;
            Cinnabar → Peak &middot;
            Indigo Plateau → Tapering
        </p>
    </div>

<script>
    const POKE_SPRITE = id => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

    // Location backgrounds from FireRed/LeafGreen
    const LOCATION_BG = {
        pallet:   'https://archives.bulbagarden.net/media/upload/7/77/Pallet_Town_FRLG.png',
        pewter:   'https://archives.bulbagarden.net/media/upload/c/cf/Pewter_City_FRLG.png',
        cerulean: 'https://archives.bulbagarden.net/media/upload/0/0b/Cerulean_City_FRLG.png',
        vermilion:'https://archives.bulbagarden.net/media/upload/8/8d/Vermilion_City_FRLG.png',
        celadon:  'https://archives.bulbagarden.net/media/upload/e/ee/Celadon_City_FRLG.png',
        fuchsia:  'https://archives.bulbagarden.net/media/upload/d/d0/Fuchsia_City_FRLG.png',
        cinnabar: 'https://archives.bulbagarden.net/media/upload/6/65/Cinnabar_Island_FRLG.png',
        indigo:   'https://archives.bulbagarden.net/media/upload/2/26/Indigo_Plateau_FRLG.png',
        // Johto locations
        johto_newbark:   'https://archives.bulbagarden.net/media/upload/d/dd/New_Bark_Town_HGSS.png',
        johto_violet:    'https://archives.bulbagarden.net/media/upload/5/55/Violet_City_HGSS.png',
        johto_azalea:    'https://archives.bulbagarden.net/media/upload/0/0f/Azalea_Town_HGSS.png',
        johto_goldenrod: 'https://archives.bulbagarden.net/media/upload/6/65/Goldenrod_City_HGSS.png',
        johto_ecruteak:  'https://archives.bulbagarden.net/media/upload/7/77/Ecruteak_City_HGSS.png',
        johto_olivine:   'https://archives.bulbagarden.net/media/upload/f/f6/Olivine_City_HGSS.png',
        johto_mahogany:  'https://archives.bulbagarden.net/media/upload/9/9f/Mahogany_Town_HGSS.png',
        johto_indigo:    'https://archives.bulbagarden.net/media/upload/2/26/Indigo_Plateau_FRLG.png'
    };

    // 151 Pokemon levels — same thresholds as SPX ($0-$30k)
    const POKEMON_LEVELS = [
        { min:     0, pokemon: 'Bulbasaur',   pokeId:   1, location: 'pallet' },
        { min:     4, pokemon: 'Ivysaur',     pokeId:   2, location: 'pallet' },
        { min:     7, pokemon: 'Venusaur',    pokeId:   3, location: 'pallet' },
        { min:    11, pokemon: 'Charmander',  pokeId:   4, location: 'pallet' },
        { min:    14, pokemon: 'Charmeleon',  pokeId:   5, location: 'pallet' },
        { min:    20, pokemon: 'Charizard',   pokeId:   6, location: 'pallet' },
        { min:    27, pokemon: 'Squirtle',    pokeId:   7, location: 'pallet' },
        { min:    35, pokemon: 'Wartortle',   pokeId:   8, location: 'pallet' },
        { min:    45, pokemon: 'Blastoise',   pokeId:   9, location: 'pallet' },
        { min:    57, pokemon: 'Caterpie',    pokeId:  10, location: 'pewter' },
        { min:    69, pokemon: 'Metapod',     pokeId:  11, location: 'pewter' },
        { min:    78, pokemon: 'Butterfree',  pokeId:  12, location: 'pewter' },
        { min:    96, pokemon: 'Weedle',      pokeId:  13, location: 'pewter' },
        { min:   106, pokemon: 'Kakuna',      pokeId:  14, location: 'pewter' },
        { min:   128, pokemon: 'Beedrill',    pokeId:  15, location: 'pewter' },
        { min:   142, pokemon: 'Pidgey',      pokeId:  16, location: 'pewter' },
        { min:   156, pokemon: 'Pidgeotto',   pokeId:  17, location: 'pewter' },
        { min:   186, pokemon: 'Pidgeot',     pokeId:  18, location: 'pewter' },
        { min:   204, pokemon: 'Rattata',     pokeId:  19, location: 'pewter' },
        { min:   234, pokemon: 'Raticate',    pokeId:  20, location: 'pewter' },
        { min:   252, pokemon: 'Spearow',     pokeId:  21, location: 'pewter' },
        { min:   278, pokemon: 'Fearow',      pokeId:  22, location: 'pewter' },
        { min:   318, pokemon: 'Ekans',       pokeId:  23, location: 'pewter' },
        { min:   344, pokemon: 'Arbok',       pokeId:  24, location: 'pewter' },
        { min:   379, pokemon: 'Pikachu',     pokeId:  25, location: 'pewter' },
        { min:   419, pokemon: 'Raichu',      pokeId:  26, location: 'pewter' },
        { min:   459, pokemon: 'Sandshrew',   pokeId:  27, location: 'pewter' },
        { min:   485, pokemon: 'Sandslash',   pokeId:  28, location: 'pewter' },
        { min:   513, pokemon: 'Nidoran\u2640', pokeId: 29, location: 'pewter' },
        { min:   548, pokemon: 'Nidorina',    pokeId:  30, location: 'pewter' },
        { min:   598, pokemon: 'Nidoqueen',   pokeId:  31, location: 'pewter' },
        { min:   628, pokemon: 'Nidoran\u2642', pokeId: 32, location: 'pewter' },
        { min:   673, pokemon: 'Nidorino',    pokeId:  33, location: 'pewter' },
        { min:   738, pokemon: 'Nidoking',    pokeId:  34, location: 'pewter' },
        { min:   773, pokemon: 'Clefairy',    pokeId:  35, location: 'cerulean' },
        { min:   853, pokemon: 'Clefable',    pokeId:  36, location: 'cerulean' },
        { min:   893, pokemon: 'Vulpix',      pokeId:  37, location: 'cerulean' },
        { min:   943, pokemon: 'Ninetales',   pokeId:  38, location: 'cerulean' },
        { min:  1028, pokemon: 'Jigglypuff',  pokeId:  39, location: 'cerulean' },
        { min:  1073, pokemon: 'Wigglytuff',  pokeId:  40, location: 'cerulean' },
        { min:  1143, pokemon: 'Zubat',       pokeId:  41, location: 'vermilion' },
        { min:  1203, pokemon: 'Golbat',      pokeId:  42, location: 'vermilion' },
        { min:  1278, pokemon: 'Oddish',      pokeId:  43, location: 'vermilion' },
        { min:  1353, pokemon: 'Gloom',       pokeId:  44, location: 'vermilion' },
        { min:  1443, pokemon: 'Vileplume',   pokeId:  45, location: 'vermilion' },
        { min:  1533, pokemon: 'Paras',       pokeId:  46, location: 'vermilion' },
        { min:  1613, pokemon: 'Parasect',    pokeId:  47, location: 'vermilion' },
        { min:  1678, pokemon: 'Venonat',     pokeId:  48, location: 'vermilion' },
        { min:  1773, pokemon: 'Venomoth',    pokeId:  49, location: 'vermilion' },
        { min:  1828, pokemon: 'Diglett',     pokeId:  50, location: 'vermilion' },
        { min:  1918, pokemon: 'Dugtrio',     pokeId:  51, location: 'vermilion' },
        { min:  1973, pokemon: 'Meowth',      pokeId:  52, location: 'vermilion' },
        { min:  2053, pokemon: 'Persian',     pokeId:  53, location: 'vermilion' },
        { min:  2183, pokemon: 'Psyduck',     pokeId:  54, location: 'vermilion' },
        { min:  2258, pokemon: 'Golduck',     pokeId:  55, location: 'vermilion' },
        { min:  2323, pokemon: 'Mankey',      pokeId:  56, location: 'vermilion' },
        { min:  2423, pokemon: 'Primeape',    pokeId:  57, location: 'vermilion' },
        { min:  2523, pokemon: 'Growlithe',   pokeId:  58, location: 'vermilion' },
        { min:  2663, pokemon: 'Arcanine',    pokeId:  59, location: 'vermilion' },
        { min:  2783, pokemon: 'Poliwag',     pokeId:  60, location: 'vermilion' },
        { min:  2923, pokemon: 'Poliwhirl',   pokeId:  61, location: 'vermilion' },
        { min:  3008, pokemon: 'Poliwrath',   pokeId:  62, location: 'vermilion' },
        { min:  3158, pokemon: 'Abra',        pokeId:  63, location: 'vermilion' },
        { min:  3298, pokemon: 'Kadabra',     pokeId:  64, location: 'vermilion' },
        { min:  3448, pokemon: 'Alakazam',    pokeId:  65, location: 'vermilion' },
        { min:  3618, pokemon: 'Machop',      pokeId:  66, location: 'celadon' },
        { min:  3768, pokemon: 'Machoke',     pokeId:  67, location: 'celadon' },
        { min:  3863, pokemon: 'Machamp',     pokeId:  68, location: 'celadon' },
        { min:  4003, pokemon: 'Bellsprout',  pokeId:  69, location: 'celadon' },
        { min:  4183, pokemon: 'Weepinbell',  pokeId:  70, location: 'celadon' },
        { min:  4353, pokemon: 'Victreebel',  pokeId:  71, location: 'celadon' },
        { min:  4543, pokemon: 'Tentacool',   pokeId:  72, location: 'celadon' },
        { min:  4633, pokemon: 'Tentacruel',  pokeId:  73, location: 'celadon' },
        { min:  4743, pokemon: 'Geodude',     pokeId:  74, location: 'celadon' },
        { min:  4923, pokemon: 'Graveler',    pokeId:  75, location: 'celadon' },
        { min:  5053, pokemon: 'Golem',       pokeId:  76, location: 'celadon' },
        { min:  5233, pokemon: 'Ponyta',      pokeId:  77, location: 'celadon' },
        { min:  5443, pokemon: 'Rapidash',    pokeId:  78, location: 'celadon' },
        { min:  5653, pokemon: 'Slowpoke',    pokeId:  79, location: 'celadon' },
        { min:  5793, pokemon: 'Slowbro',     pokeId:  80, location: 'celadon' },
        { min:  6013, pokemon: 'Magnemite',   pokeId:  81, location: 'fuchsia' },
        { min:  6233, pokemon: 'Magneton',    pokeId:  82, location: 'fuchsia' },
        { min:  6473, pokemon: "Farfetch\u2019d", pokeId: 83, location: 'fuchsia' },
        { min:  6583, pokemon: 'Doduo',       pokeId:  84, location: 'fuchsia' },
        { min:  6693, pokemon: 'Dodrio',      pokeId:  85, location: 'fuchsia' },
        { min:  6913, pokemon: 'Seel',        pokeId:  86, location: 'fuchsia' },
        { min:  7163, pokemon: 'Dewgong',     pokeId:  87, location: 'fuchsia' },
        { min:  7383, pokemon: 'Grimer',      pokeId:  88, location: 'fuchsia' },
        { min:  7503, pokemon: 'Muk',         pokeId:  89, location: 'fuchsia' },
        { min:  7733, pokemon: 'Shellder',    pokeId:  90, location: 'fuchsia' },
        { min:  7923, pokemon: 'Cloyster',    pokeId:  91, location: 'fuchsia' },
        { min:  8083, pokemon: 'Gastly',      pokeId:  92, location: 'fuchsia' },
        { min:  8323, pokemon: 'Haunter',     pokeId:  93, location: 'fuchsia' },
        { min:  8603, pokemon: 'Gengar',      pokeId:  94, location: 'fuchsia' },
        { min:  8833, pokemon: 'Onix',        pokeId:  95, location: 'fuchsia' },
        { min:  8993, pokemon: 'Drowzee',     pokeId:  96, location: 'fuchsia' },
        { min:  9263, pokemon: 'Hypno',       pokeId:  97, location: 'fuchsia' },
        { min:  9483, pokemon: 'Krabby',      pokeId:  98, location: 'fuchsia' },
        { min:  9653, pokemon: 'Kingler',     pokeId:  99, location: 'fuchsia' },
        { min:  9943, pokemon: 'Voltorb',     pokeId: 100, location: 'cinnabar' },
        { min: 10103, pokemon: 'Electrode',   pokeId: 101, location: 'cinnabar' },
        { min: 10373, pokemon: 'Exeggcute',   pokeId: 102, location: 'cinnabar' },
        { min: 10523, pokemon: 'Exeggutor',   pokeId: 103, location: 'cinnabar' },
        { min: 10773, pokemon: 'Cubone',      pokeId: 104, location: 'cinnabar' },
        { min: 10993, pokemon: 'Marowak',     pokeId: 105, location: 'cinnabar' },
        { min: 11203, pokemon: 'Hitmonlee',   pokeId: 106, location: 'cinnabar' },
        { min: 11413, pokemon: 'Hitmonchan',  pokeId: 107, location: 'cinnabar' },
        { min: 11713, pokemon: 'Lickitung',   pokeId: 108, location: 'cinnabar' },
        { min: 11973, pokemon: 'Koffing',     pokeId: 109, location: 'cinnabar' },
        { min: 12183, pokemon: 'Weezing',     pokeId: 110, location: 'cinnabar' },
        { min: 12353, pokemon: 'Rhyhorn',     pokeId: 111, location: 'cinnabar' },
        { min: 12533, pokemon: 'Rhydon',      pokeId: 112, location: 'cinnabar' },
        { min: 12883, pokemon: 'Chansey',     pokeId: 113, location: 'cinnabar' },
        { min: 13073, pokemon: 'Tangela',     pokeId: 114, location: 'cinnabar' },
        { min: 13343, pokemon: 'Kangaskhan',  pokeId: 115, location: 'cinnabar' },
        { min: 13613, pokemon: 'Horsea',      pokeId: 116, location: 'cinnabar' },
        { min: 13893, pokemon: 'Seadra',      pokeId: 117, location: 'cinnabar' },
        { min: 14123, pokemon: 'Goldeen',     pokeId: 118, location: 'cinnabar' },
        { min: 14373, pokemon: 'Seaking',     pokeId: 119, location: 'cinnabar' },
        { min: 14723, pokemon: 'Staryu',      pokeId: 120, location: 'cinnabar' },
        { min: 14903, pokemon: 'Starmie',     pokeId: 121, location: 'cinnabar' },
        { min: 15278, pokemon: 'Mr. Mime',    pokeId: 122, location: 'cinnabar' },
        { min: 15468, pokemon: 'Scyther',     pokeId: 123, location: 'cinnabar' },
        { min: 15728, pokemon: 'Jynx',        pokeId: 124, location: 'cinnabar' },
        { min: 15998, pokemon: 'Electabuzz',  pokeId: 125, location: 'cinnabar' },
        { min: 16268, pokemon: 'Magmar',      pokeId: 126, location: 'cinnabar' },
        { min: 16668, pokemon: 'Pinsir',      pokeId: 127, location: 'cinnabar' },
        { min: 17043, pokemon: 'Tauros',      pokeId: 128, location: 'cinnabar' },
        { min: 17343, pokemon: 'Magikarp',    pokeId: 129, location: 'cinnabar' },
        { min: 17743, pokemon: 'Gyarados',    pokeId: 130, location: 'cinnabar' },
        { min: 18193, pokemon: 'Lapras',      pokeId: 131, location: 'indigo' },
        { min: 18523, pokemon: 'Ditto',       pokeId: 132, location: 'indigo' },
        { min: 18787, pokemon: 'Eevee',       pokeId: 133, location: 'indigo' },
        { min: 19227, pokemon: 'Vaporeon',    pokeId: 134, location: 'indigo' },
        { min: 19694, pokemon: 'Jolteon',     pokeId: 135, location: 'indigo' },
        { min: 20002, pokemon: 'Flareon',     pokeId: 136, location: 'indigo' },
        { min: 20310, pokemon: 'Porygon',     pokeId: 137, location: 'indigo' },
        { min: 20596, pokemon: 'Omanyte',     pokeId: 138, location: 'indigo' },
        { min: 20827, pokemon: 'Omastar',     pokeId: 139, location: 'indigo' },
        { min: 21212, pokemon: 'Kabuto',      pokeId: 140, location: 'indigo' },
        { min: 21679, pokemon: 'Kabutops',    pokeId: 141, location: 'indigo' },
        { min: 22009, pokemon: 'Aerodactyl',  pokeId: 142, location: 'indigo' },
        { min: 22421, pokemon: 'Snorlax',     pokeId: 143, location: 'indigo' },
        { min: 22696, pokemon: 'Articuno',    pokeId: 144, location: 'indigo' },
        { min: 23219, pokemon: 'Zapdos',      pokeId: 145, location: 'indigo' },
        { min: 23460, pokemon: 'Moltres',     pokeId: 146, location: 'indigo' },
        { min: 23873, pokemon: 'Dratini',     pokeId: 147, location: 'indigo' },
        { min: 24285, pokemon: 'Dragonair',   pokeId: 148, location: 'indigo' },
        { min: 24643, pokemon: 'Dragonite',   pokeId: 149, location: 'indigo' },
        { min: 25000, pokemon: 'Mewtwo',      pokeId: 150, location: 'indigo' },
        { min: 30000, pokemon: 'Mew',         pokeId: 151, location: 'indigo' },
        // ===== GEN 2 — JOHTO (Levels 152-251) =====
        // New Bark Town — Johto Starters (152-160)
        { min: 30800, pokemon: 'Chikorita',   pokeId: 152, location: 'johto_newbark' },
        { min: 31600, pokemon: 'Bayleef',     pokeId: 153, location: 'johto_newbark' },
        { min: 32500, pokemon: 'Meganium',    pokeId: 154, location: 'johto_newbark' },
        { min: 33500, pokemon: 'Cyndaquil',   pokeId: 155, location: 'johto_newbark' },
        { min: 34600, pokemon: 'Quilava',     pokeId: 156, location: 'johto_newbark' },
        { min: 35800, pokemon: 'Typhlosion',  pokeId: 157, location: 'johto_newbark' },
        { min: 37100, pokemon: 'Totodile',    pokeId: 158, location: 'johto_newbark' },
        { min: 38500, pokemon: 'Croconaw',    pokeId: 159, location: 'johto_newbark' },
        { min: 40000, pokemon: 'Feraligatr',  pokeId: 160, location: 'johto_newbark' },
        // Route 29 to Violet City (161-175)
        { min: 41500, pokemon: 'Sentret',     pokeId: 161, location: 'johto_violet' },
        { min: 43100, pokemon: 'Furret',      pokeId: 162, location: 'johto_violet' },
        { min: 44800, pokemon: 'Hoothoot',    pokeId: 163, location: 'johto_violet' },
        { min: 46600, pokemon: 'Noctowl',     pokeId: 164, location: 'johto_violet' },
        { min: 48500, pokemon: 'Ledyba',      pokeId: 165, location: 'johto_violet' },
        { min: 50500, pokemon: 'Ledian',      pokeId: 166, location: 'johto_violet' },
        { min: 52600, pokemon: 'Spinarak',    pokeId: 167, location: 'johto_violet' },
        { min: 54800, pokemon: 'Ariados',     pokeId: 168, location: 'johto_violet' },
        { min: 57100, pokemon: 'Crobat',      pokeId: 169, location: 'johto_violet' },
        { min: 59500, pokemon: 'Chinchou',    pokeId: 170, location: 'johto_violet' },
        { min: 62000, pokemon: 'Lanturn',     pokeId: 171, location: 'johto_violet' },
        { min: 64000, pokemon: 'Pichu',       pokeId: 172, location: 'johto_violet' },
        { min: 66000, pokemon: 'Cleffa',      pokeId: 173, location: 'johto_violet' },
        { min: 68000, pokemon: 'Igglybuff',   pokeId: 174, location: 'johto_violet' },
        { min: 70000, pokemon: 'Togepi',      pokeId: 175, location: 'johto_violet' },
        // Azalea Town — Slowpoke Well (176-190)
        { min: 72000, pokemon: 'Togetic',     pokeId: 176, location: 'johto_azalea' },
        { min: 74200, pokemon: 'Natu',        pokeId: 177, location: 'johto_azalea' },
        { min: 76500, pokemon: 'Xatu',        pokeId: 178, location: 'johto_azalea' },
        { min: 79000, pokemon: 'Mareep',      pokeId: 179, location: 'johto_azalea' },
        { min: 81500, pokemon: 'Flaaffy',     pokeId: 180, location: 'johto_azalea' },
        { min: 84200, pokemon: 'Ampharos',    pokeId: 181, location: 'johto_azalea' },
        { min: 87000, pokemon: 'Bellossom',   pokeId: 182, location: 'johto_azalea' },
        { min: 89000, pokemon: 'Marill',      pokeId: 183, location: 'johto_azalea' },
        { min: 91200, pokemon: 'Azumarill',   pokeId: 184, location: 'johto_azalea' },
        { min: 93500, pokemon: 'Sudowoodo',   pokeId: 185, location: 'johto_azalea' },
        { min: 95000, pokemon: 'Politoed',    pokeId: 186, location: 'johto_azalea' },
        { min: 96500, pokemon: 'Hoppip',      pokeId: 187, location: 'johto_azalea' },
        { min: 98000, pokemon: 'Skiploom',    pokeId: 188, location: 'johto_azalea' },
        { min: 99500, pokemon: 'Jumpluff',    pokeId: 189, location: 'johto_azalea' },
        { min: 101000, pokemon: 'Aipom',      pokeId: 190, location: 'johto_azalea' },
        // Goldenrod City — Department Store (191-205)
        { min: 103000, pokemon: 'Sunkern',    pokeId: 191, location: 'johto_goldenrod' },
        { min: 105500, pokemon: 'Sunflora',   pokeId: 192, location: 'johto_goldenrod' },
        { min: 108500, pokemon: 'Yanma',      pokeId: 193, location: 'johto_goldenrod' },
        { min: 111500, pokemon: 'Wooper',     pokeId: 194, location: 'johto_goldenrod' },
        { min: 115000, pokemon: 'Quagsire',   pokeId: 195, location: 'johto_goldenrod' },
        { min: 118500, pokemon: 'Espeon',     pokeId: 196, location: 'johto_goldenrod' },
        { min: 122000, pokemon: 'Umbreon',    pokeId: 197, location: 'johto_goldenrod' },
        { min: 126000, pokemon: 'Murkrow',    pokeId: 198, location: 'johto_goldenrod' },
        { min: 130000, pokemon: 'Slowking',   pokeId: 199, location: 'johto_goldenrod' },
        { min: 134000, pokemon: 'Misdreavus', pokeId: 200, location: 'johto_goldenrod' },
        { min: 138500, pokemon: 'Unown',      pokeId: 201, location: 'johto_goldenrod' },
        { min: 143000, pokemon: 'Wobbuffet',  pokeId: 202, location: 'johto_goldenrod' },
        { min: 148000, pokemon: 'Girafarig',  pokeId: 203, location: 'johto_goldenrod' },
        { min: 153000, pokemon: 'Pineco',     pokeId: 204, location: 'johto_goldenrod' },
        { min: 158000, pokemon: 'Forretress', pokeId: 205, location: 'johto_goldenrod' },
        // Ecruteak City — Burned Tower (206-220)
        { min: 163500, pokemon: 'Dunsparce',  pokeId: 206, location: 'johto_ecruteak' },
        { min: 169000, pokemon: 'Gligar',     pokeId: 207, location: 'johto_ecruteak' },
        { min: 175000, pokemon: 'Steelix',    pokeId: 208, location: 'johto_ecruteak' },
        { min: 181000, pokemon: 'Snubbull',   pokeId: 209, location: 'johto_ecruteak' },
        { min: 187500, pokemon: 'Granbull',   pokeId: 210, location: 'johto_ecruteak' },
        { min: 194000, pokemon: 'Qwilfish',   pokeId: 211, location: 'johto_ecruteak' },
        { min: 201000, pokemon: 'Scizor',     pokeId: 212, location: 'johto_ecruteak' },
        { min: 208000, pokemon: 'Shuckle',    pokeId: 213, location: 'johto_ecruteak' },
        { min: 215500, pokemon: 'Heracross',  pokeId: 214, location: 'johto_ecruteak' },
        { min: 223000, pokemon: 'Sneasel',    pokeId: 215, location: 'johto_ecruteak' },
        { min: 231000, pokemon: 'Teddiursa',  pokeId: 216, location: 'johto_ecruteak' },
        { min: 239000, pokemon: 'Ursaring',   pokeId: 217, location: 'johto_ecruteak' },
        { min: 243000, pokemon: 'Slugma',     pokeId: 218, location: 'johto_ecruteak' },
        { min: 247000, pokemon: 'Magcargo',   pokeId: 219, location: 'johto_ecruteak' },
        { min: 251000, pokemon: 'Swinub',     pokeId: 220, location: 'johto_ecruteak' },
        // Olivine & Cianwood (221-235)
        { min: 258000, pokemon: 'Piloswine',  pokeId: 221, location: 'johto_olivine' },
        { min: 265000, pokemon: 'Corsola',    pokeId: 222, location: 'johto_olivine' },
        { min: 273000, pokemon: 'Remoraid',   pokeId: 223, location: 'johto_olivine' },
        { min: 281000, pokemon: 'Octillery',  pokeId: 224, location: 'johto_olivine' },
        { min: 290000, pokemon: 'Delibird',   pokeId: 225, location: 'johto_olivine' },
        { min: 299000, pokemon: 'Mantine',    pokeId: 226, location: 'johto_olivine' },
        { min: 308000, pokemon: 'Skarmory',   pokeId: 227, location: 'johto_olivine' },
        { min: 318000, pokemon: 'Houndour',   pokeId: 228, location: 'johto_olivine' },
        { min: 328000, pokemon: 'Houndoom',   pokeId: 229, location: 'johto_olivine' },
        { min: 339000, pokemon: 'Kingdra',    pokeId: 230, location: 'johto_olivine' },
        { min: 350000, pokemon: 'Phanpy',     pokeId: 231, location: 'johto_olivine' },
        { min: 356000, pokemon: 'Donphan',    pokeId: 232, location: 'johto_olivine' },
        { min: 362000, pokemon: 'Porygon2',   pokeId: 233, location: 'johto_olivine' },
        { min: 370000, pokemon: 'Stantler',   pokeId: 234, location: 'johto_olivine' },
        { min: 378000, pokemon: 'Smeargle',   pokeId: 235, location: 'johto_olivine' },
        // Mahogany & Lake of Rage (236-245)
        { min: 390000, pokemon: 'Tyrogue',    pokeId: 236, location: 'johto_mahogany' },
        { min: 402000, pokemon: 'Hitmontop',  pokeId: 237, location: 'johto_mahogany' },
        { min: 415000, pokemon: 'Smoochum',   pokeId: 238, location: 'johto_mahogany' },
        { min: 428000, pokemon: 'Elekid',     pokeId: 239, location: 'johto_mahogany' },
        { min: 442000, pokemon: 'Magby',      pokeId: 240, location: 'johto_mahogany' },
        { min: 456000, pokemon: 'Miltank',    pokeId: 241, location: 'johto_mahogany' },
        { min: 470000, pokemon: 'Blissey',    pokeId: 242, location: 'johto_mahogany' },
        { min: 484000, pokemon: 'Raikou',     pokeId: 243, location: 'johto_mahogany' },
        { min: 492000, pokemon: 'Entei',      pokeId: 244, location: 'johto_mahogany' },
        { min: 500000, pokemon: 'Suicune',    pokeId: 245, location: 'johto_mahogany' },
        // Indigo Plateau — Johto League (246-251)
        { min: 520000, pokemon: 'Larvitar',   pokeId: 246, location: 'johto_indigo' },
        { min: 545000, pokemon: 'Pupitar',    pokeId: 247, location: 'johto_indigo' },
        { min: 570000, pokemon: 'Tyranitar',  pokeId: 248, location: 'johto_indigo' },
        { min: 590000, pokemon: 'Lugia',      pokeId: 249, location: 'johto_indigo' },
        { min: 600000, pokemon: 'Ho-Oh',      pokeId: 250, location: 'johto_indigo' },
        { min: 610000, pokemon: 'Celebi',     pokeId: 251, location: 'johto_indigo' }
    ];

    // Sizing lookup for $0-$500 (proven fine-grained progression)
    const SIZE_TABLE = [
        [0,   [1,1,1,1,1]],
        [4,   [2,1,1,1,1]],
        [8,   [2,2,1,1,1]],
        [12,  [2,2,2,1,1]],
        [16,  [2,2,2,2,1]],
        [20,  [2,2,2,2,2]],
        [28,  [3,2,2,2,2]],
        [35,  [3,3,2,2,2]],
        [45,  [3,3,3,2,2]],
        [55,  [3,3,3,3,2]],
        [65,  [3,3,3,3,3]],
        [72,  [4,3,3,3,3]],
        [78,  [4,4,3,3,3]],
        [84,  [4,4,4,3,3]],
        [92,  [4,4,4,4,3]],
        [100, [4,4,4,4,4]],
        [105, [5,4,4,4,4]],
        [110, [5,5,4,4,4]],
        [115, [5,5,5,4,4]],
        [120, [5,5,5,5,4]],
        [125, [5,5,5,5,5]]
    ];

    // Scout trade size — power curve: $1 early, $3-5 mid, $14-16 at Mewtwo/Mew
    function getScoutSize(profit) {
        if (profit <= 0) return 1;
        return Math.max(1, Math.floor(1 + Math.pow(profit / 1200, 0.85)));
    }

    // Diminishing cap: 25% → 20% by Mew ($30k), then 20% → 10% by Celebi ($610k)
    function getCapPercent(profit) {
        if (profit <= 0) return 0.25;
        if (profit <= 30000) return 0.25 - (profit / 30000) * 0.05;
        return Math.max(0.10, 0.20 - (profit - 30000) / 580000 * 0.10);
    }

    // Compute 5 trade sizes for any profit level
    function getCryptoSizes(profit) {
        const p = Math.max(0, profit);

        // $0-$500: use lookup table
        if (p <= 125) {
            let sizes = SIZE_TABLE[0][1];
            for (const [min, s] of SIZE_TABLE) {
                if (p >= min) sizes = s;
            }
            return sizes.slice();
        }

        // $125+: smooth formula
        // base=5 at $125, scales with P&L growth
        const base = Math.round(5 + Math.pow((p - 125) / 47, 0.87));
        const spread = Math.max(1, Math.round(base * 0.05));
        const t1 = Math.min(500, base + spread);
        const t2 = Math.min(500, base);
        const t3 = Math.min(500, base);
        const t4 = Math.min(500, Math.max(1, base - spread));
        const t5 = Math.min(250, Math.max(1, Math.ceil(base / 2)));
        return [t1, t2, t3, t4, t5];
    }

    // Phase groupings
    const PHASES = [
        { name: 'Pallet Town \u2014 Starters', location: 'pallet', start: 1, end: 9 },
        { name: 'Viridian to Pewter \u2014 Early Routes', location: 'pewter', start: 10, end: 25 },
        { name: 'Cerulean \u2014 Gym Challenge', location: 'cerulean', start: 26, end: 45 },
        { name: 'Vermilion \u2014 Building Momentum', location: 'vermilion', start: 46, end: 65 },
        { name: 'Celadon \u2014 Ramping Up', location: 'celadon', start: 66, end: 85 },
        { name: 'Fuchsia \u2014 Safari Zone', location: 'fuchsia', start: 86, end: 105 },
        { name: 'Cinnabar Island \u2014 Peak Power', location: 'cinnabar', start: 106, end: 130 },
        { name: 'Indigo Plateau \u2014 Pokemon League', location: 'indigo', start: 131, end: 151 },
        // ===== GEN 2 — JOHTO PHASES =====
        { name: 'New Bark Town \u2014 Johto Starters', location: 'johto_newbark', start: 152, end: 160 },
        { name: 'Route 29 to Violet City \u2014 Early Johto', location: 'johto_violet', start: 161, end: 175 },
        { name: 'Azalea Town \u2014 Slowpoke Well', location: 'johto_azalea', start: 176, end: 190 },
        { name: 'Goldenrod City \u2014 Department Store', location: 'johto_goldenrod', start: 191, end: 205 },
        { name: 'Ecruteak City \u2014 Burned Tower', location: 'johto_ecruteak', start: 206, end: 220 },
        { name: 'Olivine & Cianwood \u2014 Coastal Power', location: 'johto_olivine', start: 221, end: 235 },
        { name: 'Mahogany & Lake of Rage \u2014 Legendary Beasts', location: 'johto_mahogany', start: 236, end: 245 },
        { name: 'Indigo Plateau \u2014 Johto League', location: 'johto_indigo', start: 246, end: 251 }
    ];

    function buildGuide() {
        const container = document.getElementById('phases');
        let html = '';
        let lockedAt300 = false;
        let lockProfit = 0;
        const endProfit = POKEMON_LEVELS[POKEMON_LEVELS.length - 1].min;

        for (let pi = 0; pi < PHASES.length; pi++) {
            const phase = PHASES[pi];

            // Insert Gen 2 divider banner before first Johto phase
            if (phase.start === 152) {
                html += `<div class="gen-divider">`;
                html += `<div class="gen-starters">`;
                html += `<img src="${POKE_SPRITE(152)}" alt="Chikorita">`;
                html += `<img src="${POKE_SPRITE(155)}" alt="Cyndaquil">`;
                html += `<img src="${POKE_SPRITE(158)}" alt="Totodile">`;
                html += `</div>`;
                html += `<div class="gen-text">`;
                html += `<div class="gen-title">Generation II — Johto</div>`;
                html += `<div class="gen-sub">$30,000+ Profit · 100 New Pokemon</div>`;
                html += `</div>`;
                html += `<div class="gen-starters">`;
                html += `<img src="${POKE_SPRITE(183)}" alt="Marill">`;
                html += `<img src="${POKE_SPRITE(197)}" alt="Umbreon">`;
                html += `<img src="${POKE_SPRITE(250)}" alt="Ho-Oh">`;
                html += `</div>`;
                html += `</div>`;
            }

            const pokemonInPhase = POKEMON_LEVELS.filter((_, i) => (i + 1) >= phase.start && (i + 1) <= phase.end);
            const profitRange = pokemonInPhase.length > 0
                ? '$' + pokemonInPhase[0].min.toLocaleString() + ' \u2014 $' + pokemonInPhase[pokemonInPhase.length - 1].min.toLocaleString()
                : '';

            html += `<div class="phase collapsed" id="phase-${phase.location}">`;
            html += `<div class="phase-header" style="--bg-url: url('${LOCATION_BG[phase.location]}')" onclick="togglePhase(this)">`;
            html += `<span class="phase-title">${phase.name}</span>`;
            html += `<div class="phase-meta">`;
            html += `<span class="phase-count">${pokemonInPhase.length} Pokemon &middot; ${profitRange}</span>`;
            html += `<span class="phase-toggle">\u25BC</span>`;
            html += `</div></div>`;
            html += `<div class="phase-body">`;
            html += `<table><thead><tr>`;
            html += `<th>Lv</th><th></th><th>Pokemon</th><th>Profit</th>`;
            html += `<th>T1</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th>`;
            html += `<th>Total</th><th>Cap %</th><th>Budget</th><th>Scout $</th><th>Max Scouts</th><th>Gap</th>`;
            html += `<th>Avg $/tr</th><th>Trades</th><th>Est.</th>`;
            html += `</tr></thead><tbody>`;

            for (let i = phase.start - 1; i <= phase.end - 1 && i < POKEMON_LEVELS.length; i++) {
                const lvl = POKEMON_LEVELS[i];
                const sizes = getCryptoSizes(lvl.min);
                let total = sizes.reduce((a, b) => a + b, 0);
                const gap = i > 0 ? lvl.min - POKEMON_LEVELS[i - 1].min : 0;
                const lv = i + 1;
                const capPct = getCapPercent(lvl.min);
                const buffer = Math.floor(lvl.min * capPct);
                const scoutSz = getScoutSize(lvl.min);

                // Check if 300 scouts is first reached
                const rawScoutBudget = Math.max(0, buffer - total);
                const rawBudgetScouts = scoutSz > 0 ? Math.floor(rawScoutBudget / scoutSz) : 0;
                if (!lockedAt300 && rawBudgetScouts >= 300) {
                    lockedAt300 = true;
                    lockProfit = lvl.min;
                }

                let maxScouts, effectiveScout;
                if (lockedAt300) {
                    // T5 grows from 250 toward 500 after lock
                    const t5Progress = lockProfit < endProfit
                        ? Math.min(1, (lvl.min - lockProfit) / (endProfit - lockProfit)) : 0;
                    sizes[4] = Math.min(500, Math.round(250 + t5Progress * 250));
                    total = sizes.reduce((a, b) => a + b, 0);
                    // Lock at 300 scouts, scout $ = remaining budget / 300
                    maxScouts = 300;
                    const scoutBudget = Math.max(0, buffer - total);
                    effectiveScout = Math.min(500, Math.floor(scoutBudget / 300));
                } else {
                    const scoutBudget = Math.max(0, buffer - total);
                    const budgetScouts = scoutSz > 0 ? Math.floor(scoutBudget / scoutSz) : 0;
                    maxScouts = budgetScouts;
                    effectiveScout = scoutSz;
                }

                html += `<tr id="row-${lv}">`;
                html += `<td class="lv">${lv}</td>`;
                html += `<td><img class="sprite" src="${POKE_SPRITE(lvl.pokeId)}" alt="${lvl.pokemon}" loading="lazy"></td>`;
                html += `<td class="pokemon-name">${lvl.pokemon}</td>`;
                html += `<td class="profit">$${lvl.min.toLocaleString()}</td>`;
                html += `<td class="size-t1">$${sizes[0]}</td>`;
                html += `<td class="size-mid">$${sizes[1]}</td>`;
                html += `<td class="size-mid">$${sizes[2]}</td>`;
                html += `<td class="size-mid">$${sizes[3]}</td>`;
                html += `<td class="size-t5">$${sizes[4]}</td>`;
                html += `<td class="total-risk">$${total}</td>`;
                html += `<td class="profit">${(capPct * 100).toFixed(1)}%</td>`;
                html += `<td class="profit">$${buffer.toLocaleString()}</td>`;
                html += `<td class="size-mid">$${effectiveScout}</td>`;
                html += `<td class="size-t1">${lvl.min === 0 ? '—' : maxScouts.toLocaleString()}</td>`;
                html += `<td class="gap">${gap > 0 ? '+$' + gap.toLocaleString() : '\u2014'}</td>`;
                html += `<td class="est" id="est-avg-${lv}">-</td>`;
                html += `<td class="est" id="est-trades-${lv}">-</td>`;
                html += `<td class="est" id="est-time-${lv}">-</td>`;
                html += `</tr>`;
            }

            html += `</tbody></table></div></div>`;
        }

        container.innerHTML = html;
    }

    function togglePhase(header) {
        header.parentElement.classList.toggle('collapsed');
    }

    const API_URL = 'https://script.google.com/macros/s/AKfycbywWcasm7wwI14tUc64XpTscePJlgiU3Q7sZ4uY-TmqjqVZzuxJOhf6T8fO2ZpSaKwV/exec?action=dashboard';

    async function fetchAndEstimate() {
        const result = document.getElementById('finderResult');
        const statsInfo = document.getElementById('statsInfo');
        try {
            const resp = await fetch(API_URL);
            const data = await resp.json();
            const stats = data.stats || {};
            const pnl = parseFloat(stats.netPnl) || 0;
            const totalTrades = parseInt(stats.totalTrades) || 1;
            const wins = parseInt(stats.wins) || 0;
            const losses = parseInt(stats.losses) || 0;
            const winRate = stats.winRate || '0%';

            // Calculate edge from win rate (early tiny-trade data skews raw edge too low)
            // Assumes ~18% avg win and ~10% avg loss (typical crypto TP/SL ratios)
            const winRateNum = wins / Math.max(1, totalTrades);
            const edgeRate = Math.max(0.05, winRateNum * 0.18 - (1 - winRateNum) * 0.10);

            // Estimate trades per day from data
            // Use first signal timestamp to calculate days active
            let tradesPerDay = 4; // fallback
            if (data.signals && data.signals.length > 0) {
                const timestamps = data.signals.map(s => new Date(s.timestamp).getTime()).filter(t => t > 0);
                if (timestamps.length > 1) {
                    const earliest = Math.min(...timestamps);
                    const daysActive = Math.max(1, (Date.now() - earliest) / (1000 * 60 * 60 * 24));
                    tradesPerDay = Math.max(1, Math.round(totalTrades / daysActive * 10) / 10);
                }
            }

            updateEstimates(pnl, tradesPerDay, edgeRate);

            // Show stats summary
            statsInfo.innerHTML = `${wins}W / ${losses}L (${winRate}) &middot; $${pnl.toFixed(2)} P&L &middot; ${totalTrades} trades &middot; ~${tradesPerDay}/day &middot; ${(edgeRate * 100).toFixed(1)}% edge`;
        } catch (e) {
            result.innerHTML = 'Could not load stats \u2014 enter P&L manually below';
            statsInfo.innerHTML = '';
        }
    }

    function updateEstimates(val, tradesPerDay, edgeRate) {
        const result = document.getElementById('finderResult');
        const progress = document.getElementById('progressFill');

        // Find current level
        let level = POKEMON_LEVELS[0];
        let levelIdx = 0;
        for (let i = 0; i < POKEMON_LEVELS.length; i++) {
            if (val >= POKEMON_LEVELS[i].min) {
                level = POKEMON_LEVELS[i];
                levelIdx = i;
            }
        }

        const sizes = getCryptoSizes(level.min);
        const total = sizes.reduce((a, b) => a + b, 0);
        const sizesStr = sizes.map(s => '$' + s).join(' / ');
        const next = levelIdx < POKEMON_LEVELS.length - 1 ? POKEMON_LEVELS[levelIdx + 1] : null;
        const nextStr = next ? ` \u2014 $${(next.min - val).toFixed(0)} to ${next.pokemon}` : ' \u2014 MAX LEVEL!';
        const capPct = getCapPercent(val);
        const buffer = Math.floor(val * capPct);
        const scoutSz = getScoutSize(val);
        const scoutBudget = Math.max(0, buffer - total);
        const budgetScouts2 = scoutSz > 0 ? Math.floor(scoutBudget / scoutSz) : 0;
        const maxScouts = Math.min(300, budgetScouts2);
        const effectiveScout = maxScouts === 300 && budgetScouts2 > 300
            ? Math.min(Math.floor(scoutBudget / 300), 500) : scoutSz;
        result.innerHTML = `<img src="${POKE_SPRITE(level.pokeId)}" alt="${level.pokemon}"> Lv.${levelIdx + 1} <strong>${level.pokemon}</strong> \u2014 ${sizesStr} = $${total} total${nextStr}<br><span style="font-size:0.6rem;color:#6a8aaa;">${(capPct*100).toFixed(0)}% Budget: $${buffer} \u2014 Scout: $${effectiveScout} \u2014 Max ${maxScouts} scouts</span>`;

        // Progress bar
        const maxLevel = POKEMON_LEVELS[POKEMON_LEVELS.length - 1].min;
        const pct = Math.min(100, (val / maxLevel) * 100);
        progress.style.width = pct + '%';

        // Highlight row
        document.querySelectorAll('tr.highlight').forEach(tr => tr.classList.remove('highlight'));
        const row = document.getElementById('row-' + (levelIdx + 1));
        if (row) {
            row.classList.add('highlight');
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const phase = row.closest('.phase');
            if (phase && phase.classList.contains('collapsed')) {
                phase.classList.remove('collapsed');
            }
        }

        // Simulate progression from current P&L through all levels
        let cumTrades = 0;
        let estLockedAt300 = false;
        let estLockProfit = 0;
        const estEndProfit = POKEMON_LEVELS[POKEMON_LEVELS.length - 1].min;

        for (let i = 0; i < POKEMON_LEVELS.length; i++) {
            const lv = i + 1;
            const avgEl = document.getElementById('est-avg-' + lv);
            const trEl = document.getElementById('est-trades-' + lv);
            const timeEl = document.getElementById('est-time-' + lv);
            if (!avgEl) continue;

            const lvlMin = POKEMON_LEVELS[i].min;
            const lvlSizes = getCryptoSizes(lvlMin);

            if (lvlMin <= val) {
                avgEl.className = 'est-past';
                trEl.className = 'est-past';
                timeEl.className = 'est-past';
                avgEl.textContent = '\u2713';
                trEl.textContent = '\u2713';
                timeEl.textContent = '\u2713';
                // Track 300-lock for past levels too
                const pastCapPct = getCapPercent(lvlMin);
                const pastBuffer = Math.floor(lvlMin * pastCapPct);
                const pastTotal = lvlSizes.reduce((a, b) => a + b, 0);
                const pastScoutSz = getScoutSize(lvlMin);
                const pastScoutBudget = Math.max(0, pastBuffer - pastTotal);
                const pastBudgetScouts = pastScoutSz > 0 ? Math.floor(pastScoutBudget / pastScoutSz) : 0;
                if (!estLockedAt300 && pastBudgetScouts >= 300) {
                    estLockedAt300 = true;
                    estLockProfit = lvlMin;
                }
            } else {
                const gap = i > 0 ? lvlMin - POKEMON_LEVELS[i - 1].min : lvlMin;
                const prevMin = i > 0 ? POKEMON_LEVELS[i - 1].min : 0;
                const prevSizes = getCryptoSizes(prevMin);
                let prevTotal = prevSizes.reduce((a, b) => a + b, 0);
                const prevScoutSz = getScoutSize(prevMin);
                const prevCapPct = getCapPercent(prevMin);
                const prevBuffer = Math.floor(prevMin * prevCapPct);

                // Check 300 lock
                const rawScoutBudget = Math.max(0, prevBuffer - prevTotal);
                const rawBudgetScouts = prevScoutSz > 0 ? Math.floor(rawScoutBudget / prevScoutSz) : 0;
                if (!estLockedAt300 && rawBudgetScouts >= 300) {
                    estLockedAt300 = true;
                    estLockProfit = prevMin;
                }

                let maxScouts, effectiveScoutSz;
                if (estLockedAt300) {
                    // T5 grows after lock
                    const t5Prog = estLockProfit < estEndProfit
                        ? Math.min(1, (prevMin - estLockProfit) / (estEndProfit - estLockProfit)) : 0;
                    prevSizes[4] = Math.min(500, Math.round(250 + t5Prog * 250));
                    prevTotal = prevSizes.reduce((a, b) => a + b, 0);
                    maxScouts = 300;
                    const scoutBudget = Math.max(0, prevBuffer - prevTotal);
                    effectiveScoutSz = Math.min(500, scoutBudget / 300);
                } else {
                    const scoutBudget = Math.max(0, prevBuffer - prevTotal);
                    const budgetScouts = prevScoutSz > 0 ? Math.floor(scoutBudget / prevScoutSz) : 0;
                    maxScouts = budgetScouts;
                    effectiveScoutSz = prevScoutSz;
                }

                const sessionProfit = (prevTotal + maxScouts * effectiveScoutSz) * edgeRate;
                const avgPerTrade = sessionProfit / 5;
                const sessionsNeeded = sessionProfit > 0 ? Math.ceil(gap / sessionProfit) : 9999;
                cumTrades += sessionsNeeded * 5;
                const days = cumTrades / tradesPerDay;

                avgEl.textContent = '$' + avgPerTrade.toFixed(2);
                avgEl.className = i === levelIdx + 1 ? 'est-active' : 'est';
                trEl.className = i === levelIdx + 1 ? 'est-active' : 'est';
                timeEl.className = i === levelIdx + 1 ? 'est-active' : 'est';
                trEl.textContent = cumTrades.toLocaleString();
                timeEl.textContent = formatTime(days);
            }
        }
    }

    function formatTime(days) {
        if (days < 1) return '<1d';
        if (days < 7) return Math.round(days) + 'd';
        const weeks = days / 7;
        if (weeks < 52) return weeks.toFixed(1) + 'w';
        return (weeks / 52).toFixed(1) + 'y';
    }

    // Build on load, then fetch live data
    buildGuide();
    fetchAndEstimate();
</script>
</body>
</html>
