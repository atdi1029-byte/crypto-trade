<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Crypto Trade Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #000 !important; }

        :root {
            --bg-deep: #0c1119;
            --bg-dark: #132438;
            --bg-card: #1a2d45;
            --bg-card-hover: #213754;
            --border: #1e3a5f;
            --border-light: #2a4a70;
            --text: #c8d8e8;
            --text-dim: #6a8aaa;
            --text-bright: #e8f0f8;
            --accent: #4a9eff;
            --accent-glow: #6ab4ff;
            --accent-deep: #2a7edf;
            --green-candle: #26a69a;
            --green-bright: #4dd0c4;
            --green-dim: #1a3a36;
            --red-candle: #ef5350;
            --red-bright: #ff6b6b;
            --red-dim: #3a1a1a;
        }

        body {
            font-family: 'Space Mono', 'Noto Serif JP', monospace;
            background: #000;
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Wave background */
        body::before {
            content: '';
            position: fixed;
            top: -100px; left: -20px; right: -20px; bottom: -100px;
            background: url('wave-bg.jpg') center center/cover no-repeat;
            filter: brightness(0.65);
            z-index: 0;
            pointer-events: none;
        }
        /* Dark gradient overlay — darkens the light sky at top and bottom */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.6) 100%);
            z-index: 0;
            pointer-events: none;
        }

        /* ============ MAIN CONTENT ============ */
        .content {
            position: relative;
            z-index: 1;
            padding: 1.5rem 2rem 4rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ============ HEADER ============ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            border-image: linear-gradient(90deg, transparent, var(--accent-deep), var(--border), transparent) 1;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-logo {
            width: 180px;
            height: 180px;
            border-radius: 18px;
            border: 2px solid var(--accent-deep);
            box-shadow: 0 0 25px #4a9eff44;
        }
        .header h1 {
            font-family: 'Noto Serif JP', serif;
            font-size: 5rem;
            font-weight: 900;
            color: var(--text-bright);
            letter-spacing: 8px;
            line-height: 1;
        }
        .header h1 span {
            font-family: 'Space Mono', monospace;
            font-size: 4.5rem;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 0 25px #4a9eff44, 0 3px 6px #00000066;
            letter-spacing: 12px;
            display: block;
            margin-top: 4px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .refresh-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--accent-glow);
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: var(--border);
            border-color: var(--accent-deep);
            box-shadow: 0 0 10px #4a9eff22;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--green-candle);
            display: inline-block;
            margin-right: 4px;
            box-shadow: 0 0 6px #26a69a66;
        }
        .status-dot.error { background: var(--red-candle); box-shadow: 0 0 6px #ef535066; }
        .status-dot.loading { background: var(--accent); animation: pulse 1s infinite; box-shadow: 0 0 6px #4a9eff66; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ============ SECTION HEADERS ============ */
        .section-header {
            font-family: 'Noto Serif JP', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-left: 12px;
            border-left: 3px solid var(--accent);
        }
        .section-header .count {
            background: var(--accent-deep);
            color: var(--text-bright);
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 700;
        }

        /* ============ QUOTE BANNER ============ */
        .quote-banner {
            text-align: center;
            padding: 0.8rem 2rem;
            margin-bottom: 1.25rem;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            border-image: linear-gradient(90deg, transparent, var(--border-light), transparent) 1;
            animation: fadeIn 1s ease;
            background: rgba(10, 15, 25, 0.7);
            border-radius: 8px;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .quote-text {
            font-family: 'Noto Serif JP', serif;
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-bright);
            opacity: 0.9;
            line-height: 1.5;
        }
        .quote-author {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--accent);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-top: 0.3rem;
            opacity: 0.6;
        }

        /* ============ COMMAND BAR ============ */
        .command-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            position: relative;
        }
        .command-input {
            flex: 1;
            background: rgba(10, 15, 25, 0.7);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-bright);
            outline: none;
            transition: border-color 0.2s;
        }
        .command-input::placeholder { color: var(--text-dim); }
        .command-input:focus { border-color: var(--accent); }
        .command-result {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-top: 0.4rem;
            display: none;
        }
        .command-result.success { display: block; background: var(--green-dim); color: var(--green-bright); }
        .command-result.error { display: block; background: var(--red-dim); color: var(--red-bright); }

        /* ============ QUICK STATS BAR ============ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-deep), transparent);
        }
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-bright);
            line-height: 1.2;
        }
        .stat-value.green { color: var(--green-bright); text-shadow: 0 0 10px #26a69a33; }
        .stat-value.red { color: var(--red-bright); text-shadow: 0 0 10px #ef535033; }
        .stat-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 6px;
        }

        /* ============ TOP PICKS ============ */
        .picks-actions-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .picks-col, .actions-col { min-width: 0; }
        .open-trades-section { margin-bottom: 1.5rem; }
        .open-trades-filter {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .open-trades-filter input {
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            padding: 0.35rem 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-bright);
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
        }
        .open-trades-filter input::placeholder { color: var(--text-dim); }
        .open-trades-filter input:focus { outline: none; border-color: var(--accent); }
        .ot-filter-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 3px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-dim);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .ot-filter-btn:hover { border-color: var(--accent); color: var(--text-bright); }
        .ot-filter-btn.active {
            background: var(--accent-deep);
            border-color: var(--accent);
            color: var(--text-bright);
        }
        .open-trades-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .open-trade-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--green-candle);
            border-radius: 4px;
            padding: 0.75rem 1rem;
        }
        .open-trade-item.needs-attention {
            border-left-color: var(--red-candle);
            box-shadow: 0 0 8px rgba(239, 83, 80, 0.15);
        }
        .open-trade-item .ticker-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .open-trade-item .ticker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .open-trade-item .ticker-icon-fallback {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-deep);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .open-trade-item .ticker-badge {
            font-family: 'Noto Serif JP', serif;
            font-weight: 900;
            font-size: 1rem;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .top-picks-section { margin-bottom: 1.5rem; }
        .top-picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }
        .top-pick-card {
            background: var(--bg-card);
            border: 1px solid var(--accent-glow);
            border-radius: 6px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.25s;
            box-shadow: 0 0 12px rgba(74, 158, 255, 0.25), 0 0 30px rgba(74, 158, 255, 0.1);
            animation: pickGlow 2s ease-in-out infinite alternate;
        }
        @keyframes pickGlow {
            from { box-shadow: 0 0 12px rgba(74, 158, 255, 0.2), 0 0 30px rgba(74, 158, 255, 0.08); }
            to { box-shadow: 0 0 18px rgba(74, 158, 255, 0.35), 0 0 40px rgba(74, 158, 255, 0.15); }
        }
        .top-pick-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-deep), var(--accent-glow), var(--accent-deep));
        }
        .top-pick-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 20px #0008, 0 0 20px #4a9eff15;
            transform: translateY(-2px);
        }
        .top-pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
        }
        .top-pick-symbol {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .top-pick-score {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 3px;
            background: var(--accent-deep);
            color: var(--accent-glow);
            border: 1px solid var(--accent);
        }
        .top-pick-direction {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .top-pick-direction.long { background: var(--green-dim); color: var(--green-bright); }
        .top-pick-direction.short { background: var(--red-dim); color: var(--red-bright); }
        .top-pick-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.3rem 1rem;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        .top-pick-details dt { color: var(--text-dim); font-size: 0.6rem; }
        .top-pick-details dd { color: var(--text); font-weight: 700; text-align: right; }
        .claude-analysis {
            font-size: 0.75rem;
            color: var(--text-dim);
            padding: 0.4rem 0.6rem;
            background: rgba(74,158,255,0.08);
            border-left: 2px solid var(--accent);
            border-radius: 4px;
            margin: 0.4rem 0;
            line-height: 1.4;
        }
        .claude-rec {
            font-size: 0.7rem;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 0.3rem;
        }
        .top-pick-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
        }
        .no-picks {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1.5rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            font-style: italic;
        }

        /* ============ ACTION NEEDED ============ */
        .action-section { margin-bottom: 1.5rem; }
        .action-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .action-item {
            background: var(--bg-card);
            border: 1px solid var(--accent-deep);
            border-left: 4px solid var(--accent);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-item .ticker-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .action-item .ticker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .action-item .ticker-icon-fallback {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-deep);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .action-item .ticker-badge {
            font-family: 'Noto Serif JP', serif;
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .action-item .signal-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            letter-spacing: 1px;
        }
        .action-item .signal-tag.buy { background: var(--green-dim); color: var(--green-bright); }
        .action-item .signal-tag.sell { background: var(--red-dim); color: var(--red-bright); }
        .action-item .score-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            background: rgba(74,158,255,0.15);
            color: var(--accent);
            margin-left: auto;
        }
        .action-item.pick-glow,
        .action-item.pick-glow.action-item {
            border-top: 3px solid var(--accent-glow);
            border-right: 3px solid var(--accent-glow);
            border-bottom: 3px solid var(--accent-glow);
            border-left: 3px solid var(--accent-glow);
            animation: pickGlowLive 2.5s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        .action-item.pick-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(74, 158, 255, 0.7), 0 0 80px rgba(74, 158, 255, 0.3);
        }
        .action-item.pick-glow::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(74, 158, 255, 0.08) 50%, transparent 60%);
            animation: pickShimmer 3s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes pickGlowLive {
            0%, 100% { box-shadow: 0 0 12px rgba(74, 158, 255, 0.3), 0 0 30px rgba(74, 158, 255, 0.12), inset 0 0 10px rgba(74, 158, 255, 0.03); border-color: var(--accent-glow); }
            50% { box-shadow: 0 0 25px rgba(74, 158, 255, 0.5), 0 0 60px rgba(74, 158, 255, 0.2), inset 0 0 20px rgba(74, 158, 255, 0.06); border-color: #8cc8ff; }
        }
        @keyframes pickShimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        .action-item.pick-demo,
        .action-item.pick-demo.action-item {
            border-top: 3px solid var(--accent-glow);
            border-right: 3px solid var(--accent-glow);
            border-bottom: 3px solid var(--accent-glow);
            border-left: 3px solid var(--accent-glow);
            background: var(--bg-card);
            animation: demoPulse 2s ease-in-out infinite alternate;
        }
        .action-item.pick-demo:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(74, 158, 255, 0.7), 0 0 80px rgba(74, 158, 255, 0.3);
        }
        @keyframes demoPulse {
            0% {
                border-top-color: var(--border);
                border-right-color: var(--border);
                border-bottom-color: var(--border);
                border-left-color: var(--border);
                box-shadow: 0 0 5px rgba(74, 158, 255, 0.05);
            }
            100% {
                border-top-color: #ffffff;
                border-right-color: #ffffff;
                border-bottom-color: #ffffff;
                border-left-color: #ffffff;
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 50px rgba(74, 158, 255, 0.6), 0 0 100px rgba(74, 158, 255, 0.3);
            }
        }
        .action-item .message { display: none; }
        .action-item .meta { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem; }
        .action-buttons {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }
        .action-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 3px;
            border: 1px solid var(--border);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .action-btn:hover { transform: translateY(-1px); }
        .action-btn.entered {
            background: var(--green-dim);
            color: var(--green-bright);
            border-color: var(--green-candle);
        }
        .action-btn.entered:hover { background: var(--green-candle); color: var(--text-bright); }
        .action-btn.skipped {
            background: var(--bg-dark);
            color: var(--text-dim);
            border-color: var(--border);
        }
        .action-btn.skipped:hover { background: var(--border); color: var(--text); }
        .action-btn.won {
            background: var(--green-dim);
            color: var(--green-bright);
            border-color: var(--green-candle);
        }
        .action-btn.won:hover { background: var(--green-candle); color: var(--text-bright); }
        .action-btn.lost {
            background: var(--red-dim);
            color: var(--red-bright);
            border-color: var(--red-candle);
        }
        .action-btn.lost:hover { background: var(--red-candle); color: var(--text-bright); }
        .action-btn.open-pos {
            background: #4a9eff22;
            color: var(--accent-glow);
            border-color: #4a9eff44;
        }
        .action-btn.open-pos:hover { background: #4a9eff44; color: var(--text-bright); }
        .action-btn:disabled {
            opacity: 0.4;
            cursor: default;
            transform: none;
        }
        .entry-input {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-bright);
            padding: 4px 8px;
            border-radius: 3px;
            width: 60px;
            text-align: center;
        }
        .entry-input::placeholder { color: var(--text-dim); }
        .entry-input:focus { outline: none; border-color: var(--accent); }
        .no-actions {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1.5rem;
            text-align: center;
            color: var(--green-candle);
            font-size: 0.8rem;
        }

        /* ============ TICKER GRID ============ */
        .ticker-search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        .ticker-search-bar input {
            flex: 1;
            max-width: 300px;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-bright);
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }
        .ticker-search-bar input::placeholder { color: var(--text-dim); }
        .ticker-search-bar input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .ticker-search-bar button {
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ticker-search-bar button:hover { border-color: var(--accent); color: var(--text-bright); }
        .ticker-search-bar button.active {
            background: var(--accent-deep);
            border-color: var(--accent);
            color: var(--text-bright);
        }
        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .ticker-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }
        .ticker-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 40px;
            background: linear-gradient(transparent, #0a162808);
            pointer-events: none;
        }
        .ticker-card:hover {
            border-color: var(--accent-deep);
            box-shadow: 0 4px 20px #0008, 0 0 15px #4a9eff11;
            transform: translateY(-2px);
        }
        .ticker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .ticker-coin-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .ticker-coin-fallback {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-deep);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .ticker-name {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .ticker-direction {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ticker-direction.long { background: var(--green-dim); color: var(--green-bright); border: 1px solid var(--green-candle); }
        .ticker-direction.short { background: var(--red-dim); color: var(--red-bright); border: 1px solid var(--red-candle); }
        .ticker-direction.idle { background: var(--bg-dark); color: var(--text-dim); border: 1px solid var(--border); }

        .ticker-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.35rem 1rem;
            font-size: 0.75rem;
        }
        .ticker-detail dt { color: var(--text-dim); font-size: 0.65rem; letter-spacing: 0.5px; }
        .ticker-detail dd { color: var(--text); font-weight: 700; text-align: right; }
        .ticker-detail dd.green { color: var(--green-bright); }
        .ticker-detail dd.red { color: var(--red-bright); }
        .ticker-last-signal {
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
            font-size: 0.65rem;
            color: var(--text-dim);
            font-style: italic;
        }
        .ticker-links {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
        }
        .ticker-link {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 3px;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-dim);
        }
        .ticker-link:hover {
            border-color: var(--accent-deep);
            color: var(--text-bright);
            background: var(--border);
        }
        .ticker-link.tv { color: #2196F3; border-color: #2196F322; }
        .ticker-link.tv:hover { background: #2196F322; border-color: #2196F3; color: #64B5F6; }
        .ticker-link.bx { color: var(--accent-glow); border-color: #4a9eff22; }
        .ticker-link.bx:hover { background: #4a9eff22; border-color: var(--accent); color: var(--accent-glow); }

        /* ============ ALL SIGNALS TABLE ============ */
        .signals-section { margin-bottom: 1.5rem; }
        .section-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
        }
        .signals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .signals-table th {
            text-align: left;
            padding: 0.5rem 0.5rem;
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .signals-table td {
            padding: 0.45rem 0.5rem;
            border-bottom: 1px solid #14223644;
            white-space: nowrap;
        }
        .signals-table tr:hover td { background: #1a2d4544; }
        .signal-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .signal-badge.long { background: var(--green-dim); color: var(--green-bright); }
        .signal-badge.short { background: var(--red-dim); color: var(--red-bright); }
        .score-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            display: inline-block;
        }
        .score-badge.high { background: #26a69a33; color: var(--green-bright); border: 1px solid var(--green-candle); }
        .score-badge.mid { background: #f9a82533; color: #f9c846; border: 1px solid #f9a825; }
        .score-badge.low { background: #ef535033; color: var(--red-bright); border: 1px solid var(--red-candle); }

        /* ============ PERFORMANCE GRID ============ */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .perf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.6rem;
        }
        .perf-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            text-align: center;
        }
        .perf-item .perf-val {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .perf-item .perf-label {
            font-size: 0.55rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 3px;
        }

        /* ============ LOADING / ERROR ============ */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0a1628ee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-banner {
            background: #ef535018;
            border: 1px solid var(--red-candle);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            color: var(--red-bright);
            font-size: 0.8rem;
            display: none;
        }
        .error-banner.show { display: block; }

        /* ============ ZEN FOOTER ============ */
        .zen-footer {
            text-align: center;
            padding: 2rem 0 1rem;
            position: relative;
        }
        .zen-scene {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 2rem;
            margin-bottom: 1rem;
        }
        .zen-capybara {
            font-size: 5rem;
            line-height: 1;
            animation: capyFloat 4s ease-in-out infinite;
            cursor: pointer;
            user-select: none;
            position: relative;
            filter: drop-shadow(0 0 20px rgba(74, 158, 255, 0.6)) drop-shadow(0 0 50px rgba(74, 158, 255, 0.3)) drop-shadow(0 0 80px rgba(74, 158, 255, 0.15));
            transition: filter 0.3s;
        }
        .zen-capybara:hover {
            filter: drop-shadow(0 0 25px rgba(74, 158, 255, 0.8)) drop-shadow(0 0 60px rgba(74, 158, 255, 0.5)) drop-shadow(0 0 100px rgba(74, 158, 255, 0.25));
        }
        .zen-capybara::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 140px; height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(74, 158, 255, 0.15) 0%, rgba(74, 158, 255, 0.05) 40%, transparent 70%);
            animation: auraGlow 3s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes capyFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.03); }
        }
        @keyframes auraGlow {
            0% { width: 140px; height: 140px; opacity: 0.6; }
            100% { width: 180px; height: 180px; opacity: 1; }
        }
        .zen-credit {
            font-size: 0.55rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 1rem;
            text-shadow: 0 1px 4px rgba(0,0,0,0.7);
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .content { padding: 0.25rem 1rem 1rem; }
            .header { flex-direction: column; gap: 0.5rem; text-align: center; }
            .header-left { flex-direction: row; align-items: center; justify-content: center; gap: 1rem; }
            .header-logo { width: 80px; height: 80px; }
            .header h1 { font-size: 2rem; }
            .header h1 span { font-size: 1.8rem; }
            .picks-actions-row { grid-template-columns: 1fr; }
            .ticker-grid { grid-template-columns: 1fr; }
            .top-picks-grid { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .ticker-grid { max-height: 500px; overflow-y: auto; }
            .command-bar { display: none; }
            body::before { top: 0; left: 0; right: 0; bottom: 0; background: url('wave-bg-mobile.png') center center / cover no-repeat; filter: brightness(0.65); }
            .quote-banner { display: none; }
            .mobile-capybara-top { display: block !important; }
            .zen-capybara { display: none; }
            #zenWisdomText { display: none; }
            .mobile-footer-quote { display: block !important; }
        }
    </style>
</head>
<body>

<!-- ============ LOADING ============ -->
<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="color: var(--text-dim); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;">Loading dashboard...</div>
</div>

<!-- ============ MAIN CONTENT ============ -->
<div class="content">
    <div class="error-banner" id="errorBanner"></div>

    <div class="header">
        <div class="header-left">
            <div>
                <h1>トレード<span>TRADE!</span></h1>
            </div>
            <div class="mobile-capybara-top" style="display:none">
                <svg viewBox="150 380 550 580" width="70" height="70">
                    <g fill="none" stroke="var(--accent-glow)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M180 750 Q150 650 200 580 Q220 550 250 540 Q280 530 320 540 L340 545"/>
                        <path d="M340 545 Q380 500 420 480 Q480 450 540 460 Q600 470 640 510 Q680 550 690 600 Q695 640 680 680 Q660 720 620 740 Q560 770 480 760 Q400 750 340 720 Q300 700 280 680"/>
                        <path d="M380 480 Q370 440 390 410 Q410 385 440 390 Q460 400 455 430 Q450 455 430 470"/>
                        <path d="M540 455 Q550 420 580 400 Q610 385 635 400 Q655 420 645 455 Q635 480 610 490"/>
                        <circle cx="480" cy="540" r="18" fill="var(--accent-deep)"/>
                        <circle cx="485" cy="535" r="6" fill="var(--accent-glow)"/>
                        <ellipse cx="580" cy="580" rx="25" ry="18" fill="var(--accent-deep)"/>
                        <circle cx="570" cy="575" r="4" fill="var(--accent-glow)"/>
                        <circle cx="590" cy="575" r="4" fill="var(--accent-glow)"/>
                        <path d="M560 610 Q580 625 600 610"/>
                        <path d="M620 570 L680 550"/><path d="M625 590 L690 590"/><path d="M620 610 L680 630"/>
                        <path d="M320 700 Q310 750 320 800 Q325 830 350 840 Q380 845 390 820 Q400 790 395 750"/>
                        <path d="M450 750 Q445 800 455 840 Q465 870 495 870 Q525 865 530 835 Q535 800 520 760"/>
                        <path d="M280 680 Q240 720 220 780 Q200 850 230 900 Q260 940 320 940 Q370 935 380 890 Q390 840 370 800"/>
                    </g>
                </svg>
            </div>
        </div>
        <div class="header-right">
            <span><span class="status-dot loading" id="statusDot"></span><span id="statusText">Connecting...</span></span>
            <span id="lastUpdate"></span>
            <button class="refresh-btn" onclick="fetchData()">Refresh</button>
        </div>
    </div>

    <!-- Quote Banner -->
    <div class="quote-banner" id="quoteBanner">
        <div class="quote-text" id="quoteText"></div>
        <div class="quote-author" id="quoteAuthor"></div>
    </div>

    <!-- Command Bar -->
    <div class="command-bar">
        <input type="text" class="command-input" id="commandInput" placeholder="e.g. &quot;$5 ZRO&quot; or &quot;chart BTC&quot;" autocomplete="off">
    </div>
    <div class="command-result" id="commandResult"></div>

    <!-- Quick Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-card">
            <div class="stat-value" id="statOpen">-</div>
            <div class="stat-label">Open Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statWinRate">-</div>
            <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statTotal">-</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statToday">-</div>
            <div class="stat-label">Today's Signals</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statPnL">-</div>
            <div class="stat-label">Total P&L</div>
        </div>
    </div>

    <!-- Top Picks + Action Needed (two columns) -->
    <div class="picks-actions-row">
        <div class="picks-col">
            <div class="section-header">Top Picks <span class="count" id="topPicksCount">0</span></div>
            <div class="top-picks-grid" id="topPicksGrid" style="max-height: 480px; overflow-y: auto;"></div>
        </div>
        <div class="actions-col">
            <div class="section-header">Action Needed <span class="count" id="actionCount">0</span></div>
            <div class="action-list" id="actionList" style="max-height: 480px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Open Trades -->
    <div class="open-trades-section" id="openTradesSection">
        <div class="section-header">Open Trades <span class="count" id="openTradesCount">0</span></div>
        <div class="open-trades-filter">
            <input type="text" id="otSearch" placeholder="Search ticker..." oninput="filterOpenTrades()">
            <button class="ot-filter-btn active" data-filter="all" onclick="setOTFilter(this,'all')">All</button>
            <button class="ot-filter-btn" data-filter="no-0x0" onclick="setOTFilter(this,'no-0x0')">No 0x0</button>
            <button class="ot-filter-btn" data-filter="no-tp" onclick="setOTFilter(this,'no-tp')">No TP</button>
        </div>
        <div class="open-trades-list" id="openTradesList" style="max-height: 480px; overflow-y: auto;"></div>
    </div>

    <!-- Ticker Grid -->
    <div class="section-header">Tickers</div>
    <div class="ticker-search-bar">
        <input type="text" id="tickerSearch" placeholder="Search tickers..." oninput="filterTickers()">
        <button id="tickerShowAll" onclick="toggleShowAll()">Show All</button>
    </div>
    <div class="ticker-grid" id="tickerGrid"></div>

    <!-- All Signals Table -->
    <div class="signals-section">
        <div class="section-header">All Signals</div>
        <div class="section-box" style="max-height: 250px; overflow-y: auto;">
            <table class="signals-table" id="signalsTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>Entry</th>
                        <th>SL</th>
                        <th>TP1</th>
                        <th>Score</th>
                        <th>MACD</th>
                        <th>Volume</th>
                        <th>RSI</th>
                    </tr>
                </thead>
                <tbody id="signalsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Performance Summary -->
    <div class="bottom-grid">
        <div>
            <div class="section-header">Performance Summary</div>
            <div class="section-box">
                <div class="perf-grid" id="perfGrid"></div>
            </div>
        </div>
    </div>

    <!-- Zen Footer -->
    <div class="zen-footer">
        <div class="zen-scene">
            <div class="zen-capybara" id="zenCapybara" title="Click me!">
                <svg viewBox="150 380 550 580" width="140" height="140">
                    <g fill="none" stroke="var(--accent-glow)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M180 750 Q150 650 200 580 Q220 550 250 540 Q280 530 320 540 L340 545"/>
                        <path d="M340 545 Q380 500 420 480 Q480 450 540 460 Q600 470 640 510 Q680 550 690 600 Q695 640 680 680 Q660 720 620 740 Q560 770 480 760 Q400 750 340 720 Q300 700 280 680"/>
                        <path d="M380 480 Q370 440 390 410 Q410 385 440 390 Q460 400 455 430 Q450 455 430 470"/>
                        <path d="M540 455 Q550 420 580 400 Q610 385 635 400 Q655 420 645 455 Q635 480 610 490"/>
                        <circle cx="480" cy="540" r="18" fill="var(--accent-deep)"/>
                        <circle cx="485" cy="535" r="6" fill="var(--accent-glow)"/>
                        <ellipse cx="580" cy="580" rx="25" ry="18" fill="var(--accent-deep)"/>
                        <circle cx="570" cy="575" r="4" fill="var(--accent-glow)"/>
                        <circle cx="590" cy="575" r="4" fill="var(--accent-glow)"/>
                        <path d="M560 610 Q580 625 600 610"/>
                        <path d="M620 570 L680 550"/>
                        <path d="M625 590 L690 590"/>
                        <path d="M620 610 L680 630"/>
                        <path d="M320 700 Q310 750 320 800 Q325 830 350 840 Q380 845 390 820 Q400 790 395 750"/>
                        <path d="M450 750 Q445 800 455 840 Q465 870 495 870 Q525 865 530 835 Q535 800 520 760"/>
                        <path d="M280 680 Q240 720 220 780 Q200 850 230 900 Q260 940 320 940 Q370 935 380 890 Q390 840 370 800"/>
                        <path d="M350 680 Q360 700 350 720"/>
                        <path d="M380 690 Q390 710 380 730"/>
                        <path d="M410 695 Q420 715 410 735"/>
                    </g>
                </svg>
            </div>
        </div>
        <div id="zenWisdomText" style="font-family:'Noto Serif JP',serif;font-size:0.85rem;font-style:italic;color:white;margin-top:0.5rem;cursor:pointer;max-width:520px;margin-left:auto;margin-right:auto;line-height:1.6;background:rgba(8,12,18,0.92);padding:0.8rem 1.4rem;border-radius:8px;border:1px solid var(--accent-deep);box-shadow:0 0 15px rgba(0,0,0,0.5);transition:opacity 0.3s;text-shadow:0 1px 3px rgba(0,0,0,0.5)" onclick="showZenWisdom()">click the capybara</div>
        <div class="mobile-footer-quote" id="mobileFooterQuote" style="display:none;font-family:'Noto Serif JP',serif;font-size:0.85rem;font-style:italic;color:white;margin-top:0.5rem;max-width:520px;margin-left:auto;margin-right:auto;line-height:1.6;background:rgba(8,12,18,0.92);padding:0.8rem 1.4rem;border-radius:8px;border:1px solid var(--accent-deep);box-shadow:0 0 15px rgba(0,0,0,0.5);text-shadow:0 1px 3px rgba(0,0,0,0.5);text-align:center"></div>
        <div class="zen-credit">Crypto Trade Dashboard</div>
    </div>
</div>

<script>
    // ====== CONFIG ======
    const API_URL = 'https://script.google.com/macros/s/AKfycbywWcasm7wwI14tUc64XpTscePJlgiU3Q7sZ4uY-TmqjqVZzuxJOhf6T8fO2ZpSaKwV/exec?action=dashboard';
    const POST_URL = 'https://script.google.com/macros/s/AKfycbywWcasm7wwI14tUc64XpTscePJlgiU3Q7sZ4uY-TmqjqVZzuxJOhf6T8fO2ZpSaKwV/exec';
    const REFRESH_INTERVAL = 60000;

    let refreshTimer = null;
    let allTickers = [];
    let allSignals = [];
    let showAllTickers = false;
    const TICKER_LIMIT = 8;

    // ====== SCORING LOGIC ======
    function scoreSignal(s) {
        let score = 0;
        if (s.macd === 'rising' || s.macd === 'falling') score += 2;
        if (Number(s.cross) >= 0 && Number(s.cross) <= 5) score += 2;
        if (s.in_zone === true || s.in_zone === 'true') score += 1;
        if (s.volume === 'above') score += 1;
        return score;
    }

    function getScoreClass(score) {
        if (score >= 5) return 'high';
        if (score >= 3) return 'mid';
        return 'low';
    }

    // ====== FETCH DATA ======
    async function fetchData() {
        const dot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        dot.className = 'status-dot loading';
        statusText.textContent = 'Fetching...';

        try {
            const resp = await fetch(API_URL);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            if (data.status !== 'ok') throw new Error(data.message || 'Bad response');

            renderDashboard(data);

            dot.className = 'status-dot';
            statusText.textContent = 'Live';
            document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
            document.getElementById('errorBanner').className = 'error-banner';
            document.getElementById('loading').className = 'loading-overlay hidden';
        } catch (err) {
            renderDashboard(EMPTY_DATA);
            dot.className = 'status-dot';
            statusText.textContent = 'Preview';
            document.getElementById('lastUpdate').textContent = 'No data';
            document.getElementById('errorBanner').className = 'error-banner';
            document.getElementById('loading').className = 'loading-overlay hidden';
        }

        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(fetchData, REFRESH_INTERVAL);
    }

    // ====== RENDER ======
    function renderDashboard(data) {
        const { tickers, recentSignals, actionNeeded, stats, claudePicks } = data;

        // Score all signals
        const scoredSignals = (recentSignals || []).map(s => {
            s._score = scoreSignal(s);
            return s;
        });
        allSignals = scoredSignals;

        // --- Quick Stats ---
        document.getElementById('statOpen').textContent = stats.openPositions || 0;

        const wrEl = document.getElementById('statWinRate');
        wrEl.textContent = stats.winRate || '0%';
        wrEl.className = 'stat-value' + (parseFloat(stats.winRate) >= 50 ? ' green' : parseFloat(stats.winRate) > 0 ? ' red' : '');

        document.getElementById('statTotal').textContent = stats.totalTrades || 0;
        document.getElementById('statToday').textContent = stats.todaySignals || 0;

        const pnlEl = document.getElementById('statPnL');
        const pnl = stats.totalPnL || '-';
        pnlEl.textContent = typeof pnl === 'number' ? (pnl >= 0 ? '+$' + pnl : '-$' + Math.abs(pnl)) : pnl;
        pnlEl.className = 'stat-value' + (typeof pnl === 'number' && pnl > 0 ? ' green' : typeof pnl === 'number' && pnl < 0 ? ' red' : '');

        // --- Top Picks (Claude's recommendations) ---
        renderTopPicks(claudePicks || [], scoredSignals);

        // --- Split actions: new signals vs open trades ---
        const allActions = actionNeeded || [];
        const newSignals = allActions.filter(a => a.type === 'mark_action');
        const openTrades = allActions.filter(a => a.type === 'mark_outcome');
        renderActions(newSignals, scoredSignals);
        renderOpenTrades(openTrades);

        // --- Ticker Grid (sorted by most recent signal first) ---
        // Sort tickers by most recent signal (use lastSignalTime from API, fall back to signals data)
        const latestByTicker = {};
        (scoredSignals || []).forEach((s, i) => {
            const sym = (s.symbol || s.ticker || '').toUpperCase();
            if (!sym) return;
            const t = s.timestamp ? new Date(s.timestamp).getTime() : 0;
            if (!latestByTicker[sym] || t > latestByTicker[sym]) {
                latestByTicker[sym] = t || (i + 1);
            }
        });
        allTickers = (tickers || []).slice().sort((a, b) => {
            const aKey = (a.ticker || '').toUpperCase();
            const bKey = (b.ticker || '').toUpperCase();
            const aTime = (a.lastSignalTime ? new Date(a.lastSignalTime).getTime() : 0) || latestByTicker[aKey] || 0;
            const bTime = (b.lastSignalTime ? new Date(b.lastSignalTime).getTime() : 0) || latestByTicker[bKey] || 0;
            return bTime - aTime;
        });
        renderTickerGrid();

        // --- All Signals Table ---
        renderSignalsTable(scoredSignals);

        // --- Performance Summary ---
        renderPerformance(stats);
    }

    // ====== TOP PICKS (Claude's Recommendations) ======
    function renderTopPicks(claudePicks, signals) {
        const grid = document.getElementById('topPicksGrid');
        const countEl = document.getElementById('topPicksCount');

        // Use Claude picks if available, otherwise fall back to auto-scored
        const hasClaude = claudePicks && claudePicks.length > 0;
        const picks = hasClaude ? claudePicks : signals.filter(s => s._score >= 5);
        countEl.textContent = picks.length;

        if (picks.length === 0) {
            grid.innerHTML = '<div class="no-picks">No top picks right now — waiting for high-score signals</div>';
            return;
        }

        grid.innerHTML = picks.map((s, i) => renderPickCard(s, i, false)).join('');
    }

    function renderPickCard(s, i, isDemo) {
            const tkr = s.symbol || s.ticker || '';
            const prc = s.entry || s.price || 0;
            const sym = getCoinSymbol(tkr);
            const iconUrl = sym ? `https://assets.coincap.io/assets/icons/${sym}@2x.png` : '';
            const fallbackText = sym ? sym.slice(0,2).toUpperCase() : '?';
            const geckoFallback = sym ? `fetchCoinGeckoIcon('${esc(tkr)}',this,this.nextElementSibling)` : '';
            const onerrorAttr = `this.style.display='none';this.nextElementSibling.style.display='flex';${geckoFallback}`;
            const dir = (s.signal || s.direction || '').toLowerCase();
            const signalClass = dir === 'short' || dir === 'sell' ? 'sell' : 'buy';
            const score = s.score || s._score || 0;
            const analysis = s.analysis || '';
            const pickId = 'pick-' + i;

            return `
                <div class="action-item ${isDemo ? 'pick-demo' : 'pick-glow'}" id="${pickId}">
                    <div>
                        <div class="ticker-header">
                            <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                            <div class="ticker-icon-fallback">${fallbackText}</div>
                            <span class="ticker-badge">${esc(tkr)}</span>
                            <span class="signal-tag ${signalClass}">${dir.toUpperCase() || 'BUY'}</span>
                            <span class="score-tag">Score: ${score}/7</span>
                        </div>
                        ${analysis ? `<div class="meta" style="margin-top:0.3rem;color:var(--text)">${esc(analysis)}</div>` : ''}
                        <div class="meta">@ $${prc}${s.sl ? ' &middot; SL: $' + s.sl : ''}${s.tp1 ? ' &middot; TP: $' + s.tp1 : ''}</div>
                        <div class="action-buttons">
                            <input type="text" class="entry-input" placeholder="Size $" id="${pickId}-size" onkeydown="if(event.key==='Enter'){navigator.clipboard.writeText(this.value);openBitunix('${esc(tkr)}')}">
                            <button class="action-btn entered" onclick="markPickAction('${esc(tkr)}','${esc(s.signal || s.direction)}',${prc},'Entered','${pickId}')">Entered</button>
                            <button class="action-btn skipped" onclick="markPickAction('${esc(tkr)}','${esc(s.signal || s.direction)}',${prc},'Skipped','${pickId}')">Skipped</button>
                        </div>
                    </div>
                </div>
            `;
    }

    // ====== ACTION NEEDED ======
    function renderActions(actionNeeded, allSignals) {
        const actionList = document.getElementById('actionList');
        const actionCount = document.getElementById('actionCount');
        actionCount.textContent = actionNeeded.length;

        if (actionNeeded.length === 0) {
            actionList.innerHTML = '<div class="no-actions">All caught up - no actions needed</div>';
            return;
        }

        actionList.innerHTML = actionNeeded.map((a, i) => {
            const id = 'action-' + i;
            const tkr = a.ticker || a.symbol || '';
            const prc = a.price || a.entry || 0;
            const sym = getCoinSymbol(tkr);
            const iconUrl = sym ? `https://assets.coincap.io/assets/icons/${sym}@2x.png` : '';
            const fallbackText = sym ? sym.slice(0,2).toUpperCase() : '?';

            const geckoFallback = sym ? `fetchCoinGeckoIcon('${esc(tkr)}',this,this.nextElementSibling)` : '';
            const onerrorAttr = `this.style.display='none';this.nextElementSibling.style.display='flex';${geckoFallback}`;

            const signalType = (a.signal || 'buy').toLowerCase();
            const signalClass = signalType.includes('sell') || signalType.includes('short') ? 'sell' : 'buy';
            const score = a.score || a._score || '-';

            // Find matching signal for extra details (match by symbol, prefer exact price, fall back to any)
            const matched = (allSignals || []).find(s => (s.symbol || s.ticker || '').toUpperCase() === tkr.toUpperCase() && Math.abs(Number(s.entry || s.price || 0) - prc) < 0.001)
                || (allSignals || []).find(s => (s.symbol || s.ticker || '').toUpperCase() === tkr.toUpperCase());
            const rsi = matched ? matched.rsi : '';
            const macd = matched ? matched.macd : '';
            const vol = matched ? matched.volume : '';
            const sl = matched ? matched.sl : '';
            const tp1 = matched ? matched.tp1 : '';

            const detailParts = [];
            if (rsi) detailParts.push('RSI: ' + Number(rsi).toFixed(1));
            if (macd) detailParts.push('MACD: ' + macd);
            if (vol) detailParts.push('Vol: ' + vol);
            const detailStr = detailParts.join(' · ');
            const levelsStr = (sl ? 'SL: $' + sl : '') + (tp1 ? ' · TP: $' + tp1 : '');

            if (a.type === 'mark_action') {
                return `
                    <div class="action-item" id="${id}">
                        <div style="display:flex;justify-content:space-between;gap:1rem;width:100%">
                            <div style="flex:1">
                                <div class="ticker-header">
                                    <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                                    <div class="ticker-icon-fallback">${fallbackText}</div>
                                    <span class="ticker-badge">${esc(tkr)}</span>
                                    <span class="signal-tag ${signalClass}">${signalType.toUpperCase()}</span>
                                    <span class="score-tag">Score: ${score}</span>
                                </div>
                                <div class="meta">@ $${prc}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                                <div class="action-buttons">
                                    <input type="text" class="entry-input" placeholder="Size $" id="${id}-size" onkeydown="if(event.key==='Enter'){navigator.clipboard.writeText(this.value);openBitunix('${esc(tkr)}')}">
                                    <button class="action-btn entered" onclick="markAction('${esc(tkr)}','${esc(a.signal)}',${prc},'Entered','${id}')">Entered</button>
                                    <button class="action-btn skipped" onclick="markAction('${esc(tkr)}','${esc(a.signal)}',${prc},'Skipped','${id}')">Skipped</button>
                                </div>
                            </div>
                            <div style="text-align:right;font-size:0.75rem;color:var(--text-dim);display:flex;flex-direction:column;align-items:flex-end;justify-content:center;gap:0.3rem">
                                ${rsi ? '<div>RSI: <span style="color:' + (rsi < 30 ? 'var(--green-bright)' : rsi > 70 ? 'var(--red-bright)' : 'var(--text)') + '">' + Number(rsi).toFixed(1) + '</span></div>' : ''}
                                ${macd ? '<div>MACD: <span style="color:' + (macd === 'rising' ? 'var(--green-bright)' : 'var(--red-bright)') + '">' + macd + '</span></div>' : ''}
                                ${vol ? '<div>Vol: <span style="color:' + (vol === 'above' ? 'var(--green-bright)' : 'var(--text-dim)') + '">' + vol + '</span></div>' : ''}
                                <canvas class="sparkline" data-ticker="${esc(tkr)}" width="100" height="30" style="margin-top:0.2rem"></canvas>
                            </div>
                        </div>
                    </div>`;
            } else {
                return `
                    <div class="action-item" id="${id}">
                        <div>
                            <div class="ticker-header">
                                <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                                <div class="ticker-icon-fallback">${fallbackText}</div>
                                <span class="ticker-badge">${esc(tkr)}</span>
                                <span class="signal-tag ${signalClass}">${signalType.toUpperCase()}</span>
                                <span class="score-tag">Score: ${score}</span>
                            </div>
                            <div class="meta">@ $${prc}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                            <div class="action-buttons">
                                <input type="text" class="entry-input" placeholder="Profit $" id="${id}-profit">
                                <button class="action-btn won" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Won','${id}')">Won</button>
                                <button class="action-btn lost" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Lost','${id}')">Lost</button>
                                <button class="action-btn open-pos" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Open','${id}')">Open</button>
                            </div>
                        </div>
                    </div>`;
            }
        }).join('');
    }

    // ====== OPEN TRADES ======
    function renderOpenTrades(trades) {
        const list = document.getElementById('openTradesList');
        const countEl = document.getElementById('openTradesCount');
        countEl.textContent = trades.length;

        if (trades.length === 0) {
            list.innerHTML = '<div class="no-actions">No open trades</div>';
            return;
        }

        list.innerHTML = trades.map((a, i) => renderOpenTradeCard(a, i)).join('');
    }

    function renderOpenTradeCard(a, i) {
            const id = 'open-' + i;
            const tkr = a.ticker || a.symbol || '';
            const prc = a.price || a.entry || 0;
            const sym = getCoinSymbol(tkr);
            const iconUrl = sym ? `https://assets.coincap.io/assets/icons/${sym}@2x.png` : '';
            const fallbackText = sym ? sym.slice(0,2).toUpperCase() : '?';
            const geckoFallback = sym ? `fetchCoinGeckoIcon('${esc(tkr)}',this,this.nextElementSibling)` : '';
            const onerrorAttr = `this.style.display='none';this.nextElementSibling.style.display='flex';${geckoFallback}`;
            const signalType = (a.signal || 'buy').toLowerCase();
            const signalClass = signalType.includes('sell') || signalType.includes('short') ? 'sell' : 'buy';

            return `
                <div class="open-trade-item needs-attention" id="${id}" data-status="active" data-ticker="${esc(tkr).toUpperCase()}" data-pnl="0">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
                        <div style="flex:1">
                            <div class="ticker-header">
                                <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                                <div class="ticker-icon-fallback">${fallbackText}</div>
                                <span class="ticker-badge">${esc(tkr)}</span>
                                <span class="signal-tag ${signalClass}">${signalType.toUpperCase()}</span>
                            </div>
                            <div class="meta" style="font-size:0.6rem">@ $${prc}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                            <div class="action-buttons">
                                <input type="text" class="entry-input" placeholder="P&L $" id="${id}-profit" style="width:55px">
                                <button class="action-btn entered" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'0x0','${id}')">0x0</button>
                                <button class="action-btn won" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Won','${id}')">Hit TP</button>
                                <button class="action-btn lost" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Lost','${id}')">Stopped Out</button>
                                <button class="action-btn skipped" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Closed','${id}')">Closed</button>
                            </div>
                        </div>
                        <div class="pnl-display" id="${id}-pnl-display" style="text-align:center;min-width:70px">
                            <div style="font-size:0.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">P&L</div>
                            <div class="pnl-amount" style="font-family:'Space Mono',monospace;font-size:1.2rem;font-weight:700;color:var(--text-dim)">$0</div>
                        </div>
                    </div>
                </div>`;
    }

    // ====== OPEN TRADES FILTER ======
    let otFilterMode = 'all';
    function setOTFilter(btn, mode) {
        otFilterMode = mode;
        document.querySelectorAll('.ot-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterOpenTrades();
    }
    function filterOpenTrades() {
        const search = (document.getElementById('otSearch').value || '').toUpperCase().trim();
        document.querySelectorAll('.open-trade-item').forEach(card => {
            const ticker = (card.dataset.ticker || '').toUpperCase();
            const status = card.dataset.status || 'active';
            const matchSearch = !search || ticker.includes(search);
            let matchFilter = true;
            if (otFilterMode === 'no-0x0') matchFilter = status !== '0x0';
            else if (otFilterMode === 'no-tp') matchFilter = status !== 'tp';
            else if (otFilterMode === 'done') matchFilter = status === '0x0' || status === 'tp';
            card.style.display = (matchSearch && matchFilter) ? '' : 'none';
        });
    }

    // ====== SIGNALS TABLE ======
    function renderSignalsTable(signals) {
        // signalCount removed from UI
        const tbody = document.getElementById('signalsBody');

        tbody.innerHTML = signals.map(s => {
            const dir = (s.direction || s.signal || '').toLowerCase();
            const dirClass = dir === 'short' ? 'short' : 'long';
            const scoreClass = getScoreClass(s._score);
            const entry = Number(s.entry || s.price || 0);
            const sl = Number(s.sl || 0);
            const tp1 = Number(s.tp1 || 0);

            return `
                <tr>
                    <td>${esc(s.timestamp || '-')}</td>
                    <td style="font-weight:700;color:var(--text-bright)">${esc(s.symbol || s.ticker || '-')}</td>
                    <td><span class="signal-badge ${dirClass}">${dirClass.toUpperCase()}</span></td>
                    <td>${entry ? '$' + entry.toFixed(2) : '-'}</td>
                    <td>${sl ? '$' + sl.toFixed(2) : '-'}</td>
                    <td>${tp1 ? '$' + tp1.toFixed(2) : '-'}</td>
                    <td><span class="score-badge ${scoreClass}">${s._score}/7</span></td>
                    <td>${esc(s.macd || '-')}</td>
                    <td>${esc(s.volume || '-')}</td>
                    <td>${s.rsi != null ? Number(s.rsi).toFixed(1) : '-'}</td>
                </tr>
            `;
        }).join('');
    }

    // ====== PERFORMANCE ======
    function renderPerformance(stats) {
        const perfGrid = document.getElementById('perfGrid');

        // Calculate win rate by score range from available data
        const wrByScore = stats.winRateByScore || {};

        perfGrid.innerHTML = `
            <div class="perf-item">
                <div class="perf-val">${stats.totalTrades || 0}</div>
                <div class="perf-label">Total Trades</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:${parseFloat(stats.winRate) >= 50 ? 'var(--green-bright)' : 'var(--red-bright)'}">${stats.winRate || '0%'}</div>
                <div class="perf-label">Win Rate</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--green-bright)">${stats.bestTicker || '-'}</div>
                <div class="perf-label">Best Ticker</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--red-bright)">${stats.worstTicker || '-'}</div>
                <div class="perf-label">Worst Ticker</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--green-bright)">${wrByScore.high || '-'}</div>
                <div class="perf-label">WR Score 5-7</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:#f9c846">${wrByScore.mid || '-'}</div>
                <div class="perf-label">WR Score 3-4</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--red-bright)">${wrByScore.low || '-'}</div>
                <div class="perf-label">WR Score 0-2</div>
            </div>
            <div class="perf-item">
                <div class="perf-val">${stats.bestWinStreak || 0}W</div>
                <div class="perf-label">Best Win Streak</div>
            </div>
        `;
    }

    // ====== TICKER GRID ======
    function getCoinSymbol(ticker) {
        if (!ticker) return '';
        let t = ticker.toUpperCase();
        // Strip .P suffix (Bitunix perpetual contracts)
        if (t.endsWith('.P')) t = t.slice(0, -2);
        if (t.endsWith('USDT')) return t.slice(0, -4).toLowerCase();
        if (t.endsWith('USDC')) return t.slice(0, -4).toLowerCase();
        if (t.endsWith('USD')) return t.slice(0, -3).toLowerCase();
        if (t.endsWith('BTC')) return t.slice(0, -3).toLowerCase();
        return t.toLowerCase();
    }

    const coinIconCache = {};

    function getCoinIconUrl(ticker) {
        const sym = getCoinSymbol(ticker);
        if (coinIconCache[sym]) return coinIconCache[sym];
        return `https://assets.coincap.io/assets/icons/${sym}@2x.png`;
    }

    async function fetchCoinGeckoIcon(ticker, imgEl, fallbackEl) {
        const sym = getCoinSymbol(ticker);
        if (coinIconCache[sym]) {
            imgEl.src = coinIconCache[sym];
            imgEl.style.display = '';
            fallbackEl.style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`https://api.coingecko.com/api/v3/search?query=${sym}`);
            const data = await res.json();
            const match = data.coins?.find(c => c.symbol.toLowerCase() === sym);
            if (match && match.large) {
                coinIconCache[sym] = match.large;
                imgEl.src = match.large;
                imgEl.style.display = '';
                fallbackEl.style.display = 'none';
            }
        } catch(e) {}
    }

    function renderTickerCard(t, i) {
        const dir = (t.lastDirection || t.lastSignal || 'idle').toLowerCase();
        const dirClass = dir === 'short' ? 'short' : dir === 'long' ? 'long' : 'idle';
        const wrClass = (parseFloat(t.winRate) || 0) >= 50 ? 'green' : (parseFloat(t.winRate) || 0) > 0 ? 'red' : '';
        const tid = 'ticker-' + i;

        return `
            <div class="ticker-card" id="${tid}">
                <div class="ticker-card-header">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <img class="ticker-coin-icon" src="${getCoinIconUrl(t.ticker)}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';fetchCoinGeckoIcon('${esc(t.ticker)}',this,this.nextElementSibling)">
                        <div class="ticker-coin-fallback">${getCoinSymbol(t.ticker).slice(0,2).toUpperCase()}</div>
                        <span class="ticker-name">${esc(t.ticker)}</span>
                        <span class="ticker-direction ${dirClass}">${dirClass.toUpperCase()}</span>
                    </div>
                </div>
                <dl class="ticker-detail">
                    <dt>Win Rate</dt><dd class="${wrClass}">${t.winRate || '0%'}</dd>
                    <dt>Total Trades</dt><dd>${t.totalTrades || 0}</dd>
                    <dt>Last Signal</dt><dd>${esc((t.lastSignal || '-').toUpperCase())}</dd>
                    <dt>Direction</dt><dd>${esc((t.lastDirection || '-').toUpperCase())}</dd>
                    <dt>Avg R:R</dt><dd>${t.avgRR ? Number(t.avgRR).toFixed(2) : '-'}</dd>
                </dl>
                <div class="ticker-last-signal">${(t.lastTimestamp || t.lastSignalTime) ? 'Last: ' + esc(t.lastTimestamp || t.lastSignalTime) : 'No signals yet'}</div>
                <div class="ticker-links">
                    <a class="ticker-link tv" href="${getTickerLink(t.ticker, 'tv')}" target="_blank">TradingView</a>
                    <button class="ticker-link bx" onclick="openBitunix('${esc(t.ticker)}')">Bitunix</button>
                    <button class="ticker-link" onclick="editLinks('${esc(t.ticker)}')" title="Edit links">&#9998;</button>
                </div>
            </div>
        `;
    }

    function renderTickerGrid(filtered) {
        const grid = document.getElementById('tickerGrid');
        const btn = document.getElementById('tickerShowAll');
        const search = document.getElementById('tickerSearch').value.trim().toUpperCase();
        let tickers = filtered || allTickers;

        if (search) {
            tickers = allTickers.filter(t => t.ticker.toUpperCase().includes(search));
            btn.textContent = `${tickers.length} match${tickers.length !== 1 ? 'es' : ''}`;
            btn.classList.remove('active');
        } else if (!showAllTickers && tickers.length > TICKER_LIMIT) {
            tickers = tickers.slice(0, TICKER_LIMIT);
            btn.textContent = 'Show All';
            btn.classList.remove('active');
        } else {
            btn.textContent = 'Show Recent';
            btn.classList.add('active');
        }

        grid.innerHTML = tickers.map((t, i) => renderTickerCard(t, i)).join('');
    }

    function filterTickers() {
        showAllTickers = false;
        renderTickerGrid();
    }

    function toggleShowAll() {
        const search = document.getElementById('tickerSearch');
        if (search.value.trim()) {
            search.value = '';
        }
        showAllTickers = !showAllTickers;
        renderTickerGrid();
    }

    // ====== HELPERS ======
    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    // ====== TICKER LINKS ======
    const TV_EXCHANGE_MAP = {
        '0G':'BINANCE','1000CAT':'BINANCE','1INCH':'BINANCE','2Z':'BINANCE','4':'BINANCE',
        'A':'OKX','A2Z':'BINANCE','AAVE':'BINANCE','ACE':'BINANCE','ACH':'BINANCE',
        'ACT':'BINANCE','ACU':'BINANCE','ACX':'COINBASE','ADA':'BINANCE','AERGO':'OKX',
        'AERO':'COINBASE','AEVO':'BINANCE','AGLD':'OKX','AI':'HTX','AIA':'MEXC',
        'AIN':'BINANCE','AIO':'BINANCE','AIOT':'BINANCE','AIOZ':'BYBIT','AIXBT':'BINANCE',
        'AKE':'KRAKEN','AKT':'KRAKEN','ALCH':'KRAKEN','ALEO':'GATE','ALGO':'BINANCE',
        'ALICE':'BINANCE','ALLO':'BINANCE','ALPINE':'BINGX','ALT':'BINANCE','AMP':'COINBASE',
        'ANIME':'BINANCE','ANKR':'CAPITALCOM','APE':'BINANCE','APEX':'BYBIT','API3':'BINANCE',
        'APR':'BINANCE','APT':'COINBASE','AR':'BINANCE','ARB':'BINANCE','ARIA':'BYBIT',
        'ARK':'BINANCE','ARKM':'BINANCE','ARPA':'BINANCE','ASR':'BINANCE','ASTER':'BINANCE',
        'ASTR':'BINANCE','AT':'OKX','ATH':'COINBASE','ATOM':'BINANCE','AUCTION':'BINANCE',
        'AVA':'BINANCE','AVAAI':'BINANCE','AVAX':'BINANCE','AVNT':'BINANCE','AWE':'BINANCE',
        'AXL':'BINANCE','AXS':'BINANCE','B':'BINANCE','B2':'KRAKEN','B3':'BINANCE',
        'BABY':'OKX','BAN':'BINANCE','BANANA':'BINANCE','BANANAS31':'BINANCE','BAND':'BINANCE',
        'BANK':'BINANCE','BARD':'BINANCE','BAS':'BINANCE','BAT':'KRAKEN','BB':'BINANCE',
        'BCH':'BINANCE','BDXN':'BYBIT','BEAMX':'BINANCE','BEAT':'BINANCE','BERA':'BINANCE',
        'BIANRENSHENG':'BINANCE','BICO':'BINANCE','BIGTIME':'BINANCE','BIO':'BINANCE',
        'BLESS':'BINGX','BLUAI':'BINANCE','BLUR':'BINANCE','BMT':'BINANCE','BNB':'BINANCE',
        'BNT':'BINANCE','BOBBOB':'COINBASE','BOME':'BINANCE','BONK':'BINANCE','BR':'BINANCE',
        'BRETT':'BYBIT','BREV':'OKX','BROCCOLI714':'BINANCE','BSV':'MEXC','BTC':'OKX',
        'BTR':'BINANCE','BTT':'KRAKEN','C':'BINANCE','C98':'BINANCE','CAKE':'BINANCE',
        'CARV':'KRAKEN','CATI':'COINBASE','CC':'KUCOIN','CELO':'BINANCE','CELR':'CAPITALCOM',
        'CETUS':'BINANCE','CFX':'BINANCE','CGPT':'BINANCE','CHEEMS':'BITGET','CHESS':'BINANCE',
        'CHILLGUY':'BINANCE','CHR':'BINANCE','CHZ':'GEMINI','CKB':'BINANCE','CLANKER':'BYBIT',
        'CLO':'BINANCE','COAI':'MEXC','COLLECT':'BINANCE','COMMON':'BITUNIX','COMP':'COINBASE',
        'COOKIE':'COINBASE','CORE':'OKX','COS':'BINANCE','COTI':'BINANCE','COW':'COINBASE',
        'CRO':'COINBASE','CROSS':'BINANCE','CRV':'BINANCE','CSPR':'BYBIT','CTC':'BYBIT',
        'CTK':'BINANCE','CTSI':'CAPITALCOM','CUDIS':'MEXC','CVC':'CAPITALCOM','CVX':'BINANCE',
        'CYBER':'BINANCE','CYS':'MEXC','DASH':'BINANCE','DBR':'BYBIT','DCR':'BINANCE',
        'DEEP':'KRAKEN','DEGO':'BINANCE','DENT':'BINANCE','DEXE':'BINANCE','DF':'BINANCE',
        'DGB':'BINANCE','DIA':'COINBASE','DN':'MEXC','DOG':'GATE','DOGE':'BINANCE',
        'DOGS':'BINANCE','DOLO':'BINANCE','DOOD':'BINANCE','DOT':'BINANCE','DRIFT':'KRAKEN',
        'DUSK':'BINANCE','DYDX':'BINANCE','DYM':'BINANCE','EDEN':'BINANCE','EDU':'BINANCE',
        'EGLD':'BINANCE','EIGEN':'BINANCE','ELSA':'BINANCE','ENA':'BINANCE','ENJ':'BINANCE',
        'ENS':'BINANCE','ENSO':'BINANCE','EPIC':'BINANCE','EPT':'MEXC','ERA':'BINANCE',
        'ESPORTS':'KRAKEN','ETC':'BINANCE','ETH':'BINANCE','ETHFI':'BINANCE','ETHW':'BINANCE',
        'EUL':'COINBASE','EVAA':'MEXC','F':'BINANCE','FARTCOIN':'MEXC','FET':'BINANCE',
        'FF':'BINANCE','FHE':'BYBIT','FIDA':'BINANCE','FIL':'BINANCE','FIO':'BINANCE',
        'FLOCK':'COINBASE','FLOKI':'BINANCE','FLOW':'BINANCE','FLR':'KRAKEN','FLUID':'OKX',
        'FOGO':'BINANCE','FOLKS':'BINANCE','FORM':'BINANCE','FORTH':'CAPITALCOM','FUN':'BINANCE',
        'G':'BINANCE','GALA':'BINANCE','GAS':'BINANCE','GHST':'COINBASE','GIGGLE':'BINANCE',
        'GLM':'OKX','GMT':'BINANCE','GMX':'BINANCE','GNO':'BINANCE','GOAT':'BINANCE',
        'GPS':'KUCOIN','GRASS':'BINANCE','GRIFFAIN':'BINANCE','GRT':'BINANCE','GT':'GATE',
        'GTC':'BINANCE','GUA':'GATE','GUN':'BINANCE','GWEI':'MEXC','H':'KRAKEN',
        'HAEDAL':'BINANCE','HANA':'BINANCE','HBAR':'BINANCE','HEI':'BINANCE','HEMI':'BINANCE',
        'HFT':'BINANCE','HIGH':'BINANCE','HIPPO':'BINANCE','HIVE':'BINANCE','HMSTR':'COINBASE',
        'HNT':'BYBIT','HOLO':'BINANCE','HOME':'COINBASE','HOOK':'BINANCE','HOT':'BINANCE',
        'HUMA':'BINANCE','HYPE':'BINANCE','HYPER':'COINBASE','ICNT':'BINANCE','ICP':'BINANCE',
        'ICX':'BINANCEUS','ID':'BINANCE','IDOL':'BINANCE','ILV':'BINANCE','IMX':'BINANCE',
        'IN':'BINANCE','INI':'MEXC','INIT':'KRAKEN','INJ':'BINANCE','INX':'COINBASE',
        'IO':'BINANCE','IOST':'BINANCE','IOTA':'BINANCE','IOTX':'BYBIT','IP':'COINBASE',
        'IR':'BINANCE','IRYS':'COINBASE','JASMY':'BINANCE','JCT':'BINANCE','JELLYJELLY':'OKX',
        'JOE':'BINANCE','JST':'BINANCE','JTO':'BINANCE','JUP':'BINANCE','KAIA':'BINANCE',
        'KAITO':'BINANCE','KAS':'MEXC','KAVA':'BINANCE','KERNEL':'BINANCE','KGEN':'BINANCE',
        'KITE':'BINANCE','KMNO':'BINANCE','KNC':'CAPITALCOM','KOMA':'MEXC','KSM':'BINANCE',
        'LA':'COINBASE','LAB':'BINGX','LAYER':'COINBASE','LDO':'COINBASE','LIGHT':'MEXC',
        'LINEA':'BINANCE','LINK':'BINANCE','LISTA':'BINANCE','LIT':'MEXC','LPT':'BINANCE',
        'LQTY':'BINANCE','LRC':'COINBASE','LSK':'BYBIT','LTC':'BYBIT','LUMIA':'BINANCE',
        'LUNA':'BYBIT','LUNA2':'KRAKEN','LUNC':'BINANCE','LYN':'KUCOIN','M':'MEXC',
        'MAGIC':'BINANCE','MAGMA':'BYBIT','MANA':'BINANCE','MANTA':'BINANCE','MASK':'BINANCE',
        'MAV':'BINANCE','MAVIA':'BINANCE','ME':'BINANCE','MELANIA':'BINANCE','MEME':'BINANCE',
        'MERL':'BINANCE','MET':'COINBASE','METIS':'COINBASE','MEW':'BYBIT','MINA':'KRAKEN',
        'MIRA':'BINANCE','MITO':'BINANCE','MLN':'BINANCE','MMT':'OKX','MNT':'BYBIT',
        'MOCA':'HTX','MOG':'BYBIT','MON':'COINBASE','MOODENG':'BINANCE','MORPHO':'OKX',
        'MOSS':'KCEX','MOVE':'KRAKEN','MOVR':'BINANCE','MTL':'BYBIT','MUBARAK':'BINANCE',
        'MYX':'BINANCE','NANO':'KRAKEN','NAORIS':'BYBIT','NEAR':'BINANCE','NEIRO':'BINANCE',
        'NEO':'BITFINEX','NEWT':'COINBASE','NEXO':'BINANCE','NFP':'BINANCE','NIGHT':'KRAKEN',
        'NIL':'COINBASE','NKN':'BINANCE','NMR':'BINANCE','NOM':'BINANCE','NOT':'BINANCE',
        'NPC':'BITGET','NTRN':'CRYPTOCOM','NXPC':'BINANCE','OG':'BINANCE','OGN':'KRAKEN',
        'OKB':'OKX','OL':'BINANCE','OM':'BINANCE','ON':'MEXC','ONDO':'BYBIT','ONE':'BINANCE',
        'ONG':'BINANCE','ONT':'BINANCE','OP':'BINANCE','OPEN':'KRAKEN','ORBS':'OKX',
        'ORCA':'BINANCE','ORDER':'KRAKEN','ORDI':'BINANCE','ORE':'MEXC','OXT':'BYBIT',
        'PARTI':'OKX','PEAQ':'GATE','PENDLE':'BINANCE','PENGU':'BINANCE','PENGUIN':'MEXC',
        'PEOPLE':'BINANCE','PEPE':'BINANCE','PHB':'BINANCE','PI':'OKX','PIEVERSE':'BYBIT',
        'PIPPIN':'BINANCE','PIXEL':'BINANCE','PLUME':'BYBIT','PNUT':'BINANCE','POL':'BINANCE',
        'POLYX':'BINANCE','POPCAT':'BYBIT','PORTAL':'BINANCE','POWER':'MEXC','POWR':'KRAKEN',
        'PROM':'BINANCE','PROMPT':'BYBIT','PROVE':'BINANCE','PTB':'BINANCE','PUFFER':'KRAKEN',
        'PUMP':'BINANCE','PUMPBTC':'BINANCE','PUNDIX':'BINANCE','PYTH':'BINANCE','Q':'KRAKEN',
        'QNT':'BINANCE','QTUM':'BINANCE','QUBIC':'GATE','RARE':'COINBASE','RATS':'HTX',
        'RAVE':'KRAKEN','RAY':'BINANCE','RDNT':'BINANCE','RECALL':'BINANCE','RED':'BINANCE',
        'RENDER':'BINANCE','REQ':'COINBASE','RESOLV':'BINANCE','REZ':'BINANCE','RIF':'BINANCE',
        'RIVER':'BINANCE','RLC':'KRAKEN','RLS':'COINBASE','RONIN':'COINBASE','ROSE':'BINANCE',
        'RPL':'BINANCE','RSC':'COINBASE','RSR':'BINANCE','RUNE':'BINANCE','RVN':'BINANCE',
        'RVV':'BINANCE','S':'BINANCE','SAFE':'COINBASE','SAGA':'BINANCE','SAHARA':'BINANCE',
        'SAND':'BINANCE','SAPIEN':'COINBASE','SC':'BINANCE','SCR':'OKX','SEI':'BINANCE',
        'SENT':'COINBASE','SFP':'BINANCE','SHELL':'BINANCE','SHIB':'COINBASE','SIGN':'BINANCE',
        'SIREN':'BINANCE','SKL':'BINANCE','SKR':'COINBASE','SKY':'BINANCE','SKYAI':'BINANCE',
        'SLP':'BINANCE','SNX':'BINANCE','SOL':'COINBASE','SOLV':'BINANCE','SOMI':'BINANCE',
        'SONIC':'BYBIT','SOON':'KRAKEN','SOPH':'OKX','SPACE':'BINANCE','SPELL':'COINBASE',
        'SPK':'BINANCE','SPORTFUN':'BINANCE','SPX':'MEXC','SQD':'BINANCE','SSV':'BINANCE',
        'STABLE':'BITGET','STBL':'BINANCE','STEEM':'BINANCE','STG':'BINANCE','STO':'BINANCE',
        'STORJ':'BINANCE','STRK':'BINANCE','STX':'BINANCE','SUI':'BINANCE','SUN':'BINANCE',
        'SUPER':'COINBASE','SUSHI':'BINANCE','SWARMS':'BINANCE','SXT':'BINANCE','SYN':'BINANCE',
        'SYRUP':'BINANCE','T':'BINANCE','TA':'BINANCE','TAC':'MEXC','TAG':'BINANCE',
        'TAIKO':'BINANCE','TAKE':'BITMART','TAO':'BINANCE','TEL':'BINGX','TFUEL':'MEXC',
        'THE':'BINANCE','THETA':'BINANCE','TIA':'COINBASE','TIBBIR':'LBANK','TLM':'BINANCE',
        'TNSR':'BINANCE','TON':'BINANCE','TOSHI':'COINBASE','TOWNS':'COINBASE','TRAC':'COINBASE',
        'TRADOOR':'BINANCE','TRB':'OKX','TREE':'BINANCE','TRIA':'COINBASE','TRU':'BINANCE',
        'TRUMP':'BINANCE','TRUST':'KRAKEN','TRUTH':'OKX','TRX':'BINANCE','TST':'BINANCE',
        'TURBO':'COINBASE','TURTLE':'BINANCE','TUT':'BINANCE','TWT':'BINANCE','UAI':'BINANCE',
        'UB':'BYBIT','ULTIMA':'HTX','UMA':'CAPITALCOM','UNI':'BINANCE','USELESS':'MEXC',
        'USTC':'BINANCE','USUAL':'BINANCE','US':'KRAKEN','VANA':'BINANCE','VANRY':'BINANCE',
        'VELO':'COINBASE','VELVET':'BINANCE','VET':'BINANCE','VFY':'BINANCE','VIC':'BINANCE',
        'VINE':'KRAKEN','VIRTUAL':'BINANCE','VTHO':'BINANCE','VVV':'COINBASE','W':'BINANCE',
        'WAL':'BINANCE','WAVES':'HTX','WAXP':'BINANCE','WCT':'BINANCE','WET':'BINANCE',
        'WHITEWHALE':'BYBIT','WIF':'BINANCE','WLD':'BINANCE','WLFI':'BINANCE','WMTX':'KRAKEN',
        'WOO':'BINANCE','XAI':'BYBIT','XAN':'KRAKEN','XAUT':'BITFINEX','XCH':'BYBIT',
        'XCN':'MEXC','XDC':'BITSTAMP','XEC':'MEXC','XLM':'BINANCE','XMR':'BYBIT',
        'XNO':'BINANCE','XNY':'BINANCE','XPIN':'BINANCE','XPL':'BINANCE','XPR':'MEXC',
        'XPT':'XTCOM','XRP':'BINANCE','XTZ':'BITFINEX','XVG':'BYBIT','XVS':'BINANCE',
        'YALA':'BINANCE','YB':'BYBIT','YFI':'BINANCE','YGG':'OKX','YZY':'BYBIT',
        'ZAMA':'BINANCE','ZBCN':'HTX','ZBT':'BINANCE','ZEC':'MEXC','ZEN':'BINANCE',
        'ZEREBRO':'BINANCE','ZETA':'BINANCE','ZIL':'BINANCE','ZK':'COINBASE','ZKC':'BINANCE',
        'ZKJ':'BINANCE','ZKP':'BINANCE','ZORA':'COINBASE','ZRO':'BINANCE','ZRX':'KRAKEN',
        'ZTC':'MEXC'
    };

    const DEFAULT_TV = ticker => {
        const sym = ticker.toUpperCase().replace(/USDT$|USD$|USDC$/,'');
        const exchange = TV_EXCHANGE_MAP[sym] || 'BINANCE';
        return `https://www.tradingview.com/chart/xF34dN3g/?symbol=${exchange}:${encodeURIComponent(sym)}USDT`;
    };
    const isAndroid = /Android/i.test(navigator.userAgent);
    const DEFAULT_BX = ticker => {
        const pair = ticker.toUpperCase().replace(/USDT$|USD$|USDC$/,'') + 'USDT';
        if (isAndroid) {
            return `https://www.unixcrypto.net/contract-trade/${pair}`;
        }
        return `https://www.bitunix.com/contract-trade/${pair}`;
    };

    function getTickerLinks() {
        try { return JSON.parse(localStorage.getItem('crypto_ticker_links') || '{}'); }
        catch { return {}; }
    }

    function saveTickerLinks(links) {
        localStorage.setItem('crypto_ticker_links', JSON.stringify(links));
    }

    function getTickerLink(ticker, platform) {
        const links = getTickerLinks();
        const key = ticker.toUpperCase();
        if (links[key] && links[key][platform]) return links[key][platform];
        return platform === 'tv' ? DEFAULT_TV(ticker) : DEFAULT_BX(ticker);
    }

    function openBitunix(ticker) {
        const pair = ticker.toUpperCase().replace(/USDT$|USD$|USDC$/,'') + 'USDT';
        navigator.clipboard.writeText(pair).catch(() => {});
        setTimeout(() => {
            window.open(getTickerLink(ticker, 'bx'), '_blank');
        }, 300);
    }

    function editLinks(ticker) {
        const key = ticker.toUpperCase();
        const links = getTickerLinks();
        const current = links[key] || {};

        const tvUrl = prompt(
            `TradingView URL for ${key}:\n(Leave empty for default)`,
            current.tv || DEFAULT_TV(ticker)
        );
        if (tvUrl === null) return;

        const bxUrl = prompt(
            `Bitunix URL for ${key}:\n(Leave empty for default)`,
            current.bx || DEFAULT_BX(ticker)
        );
        if (bxUrl === null) return;

        if (!links[key]) links[key] = {};
        links[key].tv = tvUrl || '';
        links[key].bx = bxUrl || '';

        if (!links[key].tv) delete links[key].tv;
        if (!links[key].bx) delete links[key].bx;
        if (Object.keys(links[key]).length === 0) delete links[key];

        saveTickerLinks(links);
        renderTickerGrid();
    }

    // ====== API WRITE FUNCTIONS ======
    async function markAction(ticker, signal, price, value, elemId) {
        const sizeInput = document.getElementById(elemId + '-size');
        const entrySize = sizeInput ? sizeInput.value : '';
        const el = document.getElementById(elemId);

        el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);

        try {
            await fetch(POST_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_position',
                    ticker: ticker,
                    signal: signal,
                    price: price,
                    field: 'action',
                    value: value,
                    entrySize: entrySize
                })
            });
            el.style.borderColor = value === 'Entered' ? 'var(--green-candle)' : 'var(--text-dim)';
            el.style.opacity = '0.5';
            el.innerHTML = '<div><span class="ticker-badge">' + esc(ticker) + '</span><span class="message">' + value.toUpperCase() + (entrySize ? ' ($' + entrySize + ')' : '') + '</span></div>';
            setTimeout(fetchData, 2000);
        } catch (err) {
            el.querySelectorAll('.action-btn').forEach(b => b.disabled = false);
            alert('Failed to update: ' + err.message);
        }
    }

    async function markOutcome(ticker, signal, price, value, elemId) {
        const profitInput = document.getElementById(elemId + '-profit');
        const inputVal = parseFloat(profitInput ? profitInput.value : '') || 0;
        const el = document.getElementById(elemId);

        // Running P&L total stored on the element
        const prevTotal = parseFloat(el.dataset.pnl || '0');

        if (value === 'Won') {
            // Hit TP — add to running total, keep card open
            const newTotal = prevTotal + inputVal;
            el.dataset.pnl = newTotal;
            el.dataset.status = 'tp';
            el.style.borderLeftColor = 'var(--green-candle)';

            // Update or create the P&L badge
            let badge = el.querySelector('.pnl-badge');
            if (!badge) {
                const header = el.querySelector('.ticker-header');
                if (header) {
                    header.insertAdjacentHTML('beforeend', '<span class="pnl-badge" style="font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:3px;margin-left:auto;background:var(--green-dim);color:var(--green-bright)"></span>');
                    badge = el.querySelector('.pnl-badge');
                }
            }
            if (badge) badge.textContent = 'TP ' + (newTotal >= 0 ? '+$' + newTotal.toFixed(2) : '-$' + Math.abs(newTotal).toFixed(2));

            // Update right-side P&L display
            const pnlDisplay = el.querySelector('.pnl-amount');
            if (pnlDisplay) {
                pnlDisplay.textContent = (newTotal >= 0 ? '+$' : '-$') + Math.abs(newTotal).toFixed(2);
                pnlDisplay.style.color = newTotal >= 0 ? 'var(--green-bright)' : 'var(--red-bright)';
            }

            // Clear input for next partial
            if (profitInput) profitInput.value = '';
            return; // Don't send to sheet yet — wait for Closed

        } else if (value === '0x0') {
            // Breakeven — keep card open
            el.dataset.status = '0x0';
            el.style.borderLeftColor = 'var(--accent)';

            let badge = el.querySelector('.pnl-badge');
            if (!badge) {
                const header = el.querySelector('.ticker-header');
                if (header) {
                    header.insertAdjacentHTML('beforeend', '<span class="pnl-badge" style="font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:3px;margin-left:auto;background:#4a9eff22;color:var(--accent-glow)"></span>');
                    badge = el.querySelector('.pnl-badge');
                }
            }
            if (badge) badge.textContent = '0x0';
            if (profitInput) profitInput.value = '';
            return;

        } else {
            // Closed or Stopped Out — finalize and send total to sheet
            const grandTotal = prevTotal + inputVal;
            const finalValue = value === 'Lost' ? 'Lost' : 'Closed';

            el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);

            try {
                await fetch(POST_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_position',
                        ticker: ticker,
                        signal: signal,
                        price: price,
                        field: 'outcome',
                        value: finalValue,
                        profitLocked: grandTotal.toFixed(2)
                    })
                });

                // Flash the total before fading
                const header = el.querySelector('.ticker-header');
                let badge = el.querySelector('.pnl-badge');
                if (!badge && header) {
                    header.insertAdjacentHTML('beforeend', '<span class="pnl-badge" style="font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:3px;margin-left:auto"></span>');
                    badge = el.querySelector('.pnl-badge');
                }
                if (badge) {
                    badge.style.background = grandTotal >= 0 ? 'var(--green-dim)' : 'var(--red-dim)';
                    badge.style.color = grandTotal >= 0 ? 'var(--green-bright)' : 'var(--red-bright)';
                    badge.textContent = grandTotal >= 0 ? '+$' + grandTotal.toFixed(2) : '-$' + Math.abs(grandTotal).toFixed(2);
                }

                // Fade out after a brief moment
                setTimeout(() => {
                    el.style.transition = 'opacity 0.5s, max-height 0.5s';
                    el.style.opacity = '0';
                    el.style.maxHeight = '0';
                    el.style.overflow = 'hidden';
                    el.style.padding = '0';
                    el.style.margin = '0';
                    setTimeout(() => el.remove(), 600);
                }, 1200);

                setTimeout(fetchData, 3000);
            } catch (err) {
                el.querySelectorAll('.action-btn').forEach(b => b.disabled = false);
                alert('Failed to update: ' + err.message);
            }
        }
    }

    async function markPickAction(ticker, signal, price, value, elemId) {
        const el = document.getElementById(elemId);
        el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);

        try {
            await fetch(POST_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_position',
                    ticker: ticker,
                    signal: signal,
                    price: price,
                    field: 'action',
                    value: value
                })
            });
            const btns = el.querySelector('.top-pick-actions');
            btns.innerHTML = '<span style="font-size:0.7rem;color:' + (value === 'Entered' ? 'var(--green-bright)' : 'var(--text-dim)') + ';font-weight:700;letter-spacing:1px;text-transform:uppercase">' + value + '</span>';
            setTimeout(fetchData, 2000);
        } catch (err) {
            el.querySelectorAll('.action-btn').forEach(b => b.disabled = false);
            alert('Failed to update: ' + err.message);
        }
    }

    // ====== EMPTY FALLBACK ======
    const EMPTY_DATA = {
        status: 'ok',
        tickers: [],
        recentSignals: [],
        claudePicks: [],
        actionNeeded: [],
        stats: {
            totalTrades: 0, wins: 0, losses: 0, winRate: '0%',
            openPositions: 0, todaySignals: 0, bestWinStreak: 0,
            worstLossStreak: 0, currentStreak: '0',
            bestTicker: 'N/A', worstTicker: 'N/A',
            winRateByScore: {}
        }
    };

    // ====== COMMAND BAR ======
    // Common name → ticker symbol mapping
    const COIN_NAMES = {
        'bitcoin':'BTC','btc':'BTC','ethereum':'ETH','eth':'ETH','solana':'SOL','sol':'SOL',
        'cardano':'ADA','ada':'ADA','dogecoin':'DOGE','doge':'DOGE','ripple':'XRP','xrp':'XRP',
        'polkadot':'DOT','dot':'DOT','chainlink':'LINK','link':'LINK','avalanche':'AVAX','avax':'AVAX',
        'polygon':'POL','pol':'POL','matic':'POL','litecoin':'LTC','ltc':'LTC',
        'uniswap':'UNI','uni':'UNI','aave':'AAVE','pepe':'PEPE',
        'layerzero':'ZRO','zro':'ZRO','stargate':'STG','stg':'STG',
        'aether':'GHST','ghst':'GHST','baby':'BABY','babydoge':'BABY',
        'home':'HOME','shiba':'SHIB','shib':'SHIB','bonk':'BONK',
        'sui':'SUI','sei':'SEI','apt':'APT','aptos':'APT','arb':'ARB','arbitrum':'ARB',
        'op':'OP','optimism':'OP','near':'NEAR','ton':'TON','toncoin':'TON',
        'render':'RENDER','fet':'FET','fetchai':'FET','wif':'WIF','floki':'FLOKI',
        'injective':'INJ','inj':'INJ','jup':'JUP','jupiter':'JUP',
    };

    // Also match any raw symbol from TV_EXCHANGE_MAP
    Object.keys(TV_EXCHANGE_MAP).forEach(sym => {
        COIN_NAMES[sym.toLowerCase()] = sym;
    });

    function parseCommand(input) {
        const text = input.trim().toLowerCase();
        if (!text) return null;

        // Extract dollar amount
        const amountMatch = text.match(/\$\s*(\d+(?:\.\d+)?)/);
        const amount = amountMatch ? amountMatch[1] : null;

        // Detect action
        const isChart = /\bchart\b|\bview\b|\blook\b|\bcheck\b/.test(text);

        // Find ticker - try each word/phrase against COIN_NAMES
        const words = text.replace(/\$\s*\d+(?:\.\d+)?/g, '').replace(/[^a-z0-9\s]/g, '').trim().split(/\s+/);
        let ticker = null;

        // Try multi-word matches first (e.g. "baby doge")
        for (let i = 0; i < words.length; i++) {
            for (let j = Math.min(words.length, i + 3); j > i; j--) {
                const phrase = words.slice(i, j).join('');
                if (COIN_NAMES[phrase]) {
                    ticker = COIN_NAMES[phrase];
                    break;
                }
            }
            if (ticker) break;
            // Try single word
            if (COIN_NAMES[words[i]]) {
                ticker = COIN_NAMES[words[i]];
                break;
            }
        }

        if (!ticker) return null;
        return { ticker, amount, isChart };
    }

    function executeCommand(input) {
        const result = document.getElementById('commandResult');
        const cmd = parseCommand(input);

        if (!cmd) {
            result.className = 'command-result error';
            result.textContent = "Couldn't find a ticker. Try something like \"$5 ZRO\" or \"chart BTC\"";
            setTimeout(() => result.className = 'command-result', 3000);
            return;
        }

        if (cmd.isChart) {
            window.open(DEFAULT_TV(cmd.ticker), '_blank');
            result.className = 'command-result success';
            result.textContent = `Opening ${cmd.ticker} chart on TradingView`;
        } else {
            if (cmd.amount) {
                navigator.clipboard.writeText(cmd.amount).then(() => {
                    result.className = 'command-result success';
                    result.textContent = `Opening ${cmd.ticker} on Bitunix — $${cmd.amount} copied to clipboard`;
                });
            } else {
                result.className = 'command-result success';
                result.textContent = `Opening ${cmd.ticker} on Bitunix`;
            }
            setTimeout(() => {
                window.open(DEFAULT_BX(cmd.ticker), '_blank');
            }, 300);
        }

        setTimeout(() => result.className = 'command-result', 4000);
    }

    document.getElementById('commandInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            executeCommand(this.value);
            this.value = '';
        }
    });


    // ====== QUOTES ======
    const QUOTES = [
        { text: "The trend is your friend until the end when it bends.", author: "Ed Seykota" },
        { text: "In crypto, the impossible happens about twice a week.", author: "Crypto Wisdom" },
        { text: "Not your keys, not your coins. Not your plan, not your profits.", author: "Crypto Proverb" },
        { text: "The market is never wrong -- opinions often are.", author: "Jesse Livermore" },
        { text: "Cut your losses short and let your profits run.", author: "Jesse Livermore" },
        { text: "Plan your trade and trade your plan.", author: "Richard Dennis" },
        { text: "Risk comes from not knowing what you are doing.", author: "Warren Buffett" },
        { text: "The goal of a successful trader is to make the best trades. Money is secondary.", author: "Alexander Elder" },
        { text: "Markets can remain irrational longer than you can remain solvent.", author: "John Maynard Keynes" },
        { text: "Amateurs think about how much money they can make. Professionals think about how much money they could lose.", author: "Jack Schwager" },
        { text: "You don't need to know what is going to happen next in order to make money.", author: "Mark Douglas" },
        { text: "Every battle is won before it is fought.", author: "Sun Tzu" },
        { text: "There is a time to go long, a time to go short, and a time to go fishing.", author: "Jesse Livermore" },
        { text: "Discipline is the bridge between goals and accomplishment.", author: "Jim Rohn" },
        { text: "The elements of good trading are: cutting losses, cutting losses, and cutting losses.", author: "Ed Seykota" },
        { text: "Do not anticipate and move without market confirmation.", author: "Jesse Livermore" },
        { text: "The best time to buy crypto was yesterday. The second best time is after your signal fires.", author: "Crypto Wisdom" },
        { text: "A 100x means nothing if you can't manage a 2x.", author: "Crypto Proverb" },
        { text: "Patience is not the ability to wait, but the ability to keep a good attitude while waiting.", author: "Joyce Meyer" },
        { text: "The hard work in trading comes in the preparation. The actual process of trading should be effortless.", author: "Jack Schwager" }
    ];

    function showQuote() {
        const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        const textEl = document.getElementById('quoteText');
        const authEl = document.getElementById('quoteAuthor');
        textEl.style.opacity = '0';
        authEl.style.opacity = '0';
        setTimeout(() => {
            textEl.textContent = '"' + q.text + '"';
            authEl.textContent = '— ' + q.author;
            textEl.style.opacity = '0.7';
            authEl.style.opacity = '0.6';
            const mfq = document.getElementById('mobileFooterQuote');
            if (mfq) mfq.innerHTML = '"' + q.text + '"<br><span style="font-size:0.7rem;color:var(--text-dim)">' + '— ' + q.author + '</span>';
        }, 300);
    }
    showQuote();

    // ====== ZEN WISDOM ======
    const ZEN_WISDOMS = [
        "The capybara does not chase the candle. The capybara waits.",
        "A green candle is not a reason to buy. A red candle is not a reason to cry.",
        "Position size is self-respect measured in dollars.",
        "The best trade you ever make might be the one you don't.",
        "FOMO is just fear wearing a different hat.",
        "Your stop loss is not a suggestion. It is a promise to yourself.",
        "The market doesn't care about your entry. Trade what you see, not what you hope.",
        "A capybara sits in hot water and remains calm. Be the capybara.",
        "Zoom out. Then zoom out again. Then go touch grass.",
        "Diamond hands are worthless without a diamond plan.",
        "The chart will be there tomorrow. Your capital might not be.",
        "Three red candles do not make a trend. Neither do three green ones.",
        "The capybara trades the plan. The capybara never revenge trades.",
        "If you can't explain why you're in a trade, you shouldn't be in the trade.",
        "Every master was once a disaster. Every whale was once rekt.",
        "Sleep is the most underrated trading indicator.",
    ];

    function showZenWisdom() {
        const textEl = document.getElementById('zenWisdomText');
        const w = ZEN_WISDOMS[Math.floor(Math.random() * ZEN_WISDOMS.length)];
        textEl.style.opacity = '0';
        setTimeout(() => {
            textEl.textContent = '"' + w + '"';
            textEl.style.opacity = '1';
        }, 200);
    }

    document.getElementById('zenCapybara').addEventListener('click', showZenWisdom);

    // ====== INIT ======
    fetchData();

    // ====== SERVICE WORKER ======
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
    }
</script>

</body>
</html>
