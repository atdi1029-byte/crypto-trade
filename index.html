<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Crypto Trade Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #000 !important; }

        :root {
            --bg-deep: #0c1119;
            --bg-dark: #132438;
            --bg-card: #1a2d45;
            --bg-card-hover: #213754;
            --border: #1e3a5f;
            --border-light: #2a4a70;
            --text: #c8d8e8;
            --text-dim: #6a8aaa;
            --text-bright: #e8f0f8;
            --accent: #4a9eff;
            --accent-glow: #6ab4ff;
            --accent-deep: #2a7edf;
            --green-candle: #26a69a;
            --green-bright: #4dd0c4;
            --green-dim: #1a3a36;
            --red-candle: #ef5350;
            --red-bright: #ff6b6b;
            --red-dim: #3a1a1a;
        }

        body {
            font-family: 'Space Mono', 'Noto Serif JP', monospace;
            background: #000;
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Wave background */
        body::before {
            content: '';
            position: fixed;
            top: -100px; left: -20px; right: -20px; bottom: -100px;
            background: url('wave-bg.jpg') center center/cover no-repeat;
            filter: brightness(1.0);
            z-index: 0;
            pointer-events: none;
        }
        /* Dark gradient overlay â€” darkens the light sky at top and bottom */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.6) 100%);
            z-index: 0;
            pointer-events: none;
        }

        /* ============ MAIN CONTENT ============ */
        .content {
            position: relative;
            z-index: 1;
            padding: 1.5rem 2rem 4rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ============ HEADER ============ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            border-image: linear-gradient(90deg, transparent, var(--accent-deep), var(--border), transparent) 1;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-logo {
            width: 180px;
            height: 180px;
            border-radius: 18px;
            border: 2px solid var(--accent-deep);
            box-shadow: 0 0 25px #4a9eff44;
        }
        .header h1 {
            font-family: 'Noto Serif JP', serif;
            font-size: 5rem;
            font-weight: 900;
            color: var(--text-bright);
            letter-spacing: 8px;
            line-height: 1;
        }
        .header h1 span {
            font-family: 'Space Mono', monospace;
            font-size: 4.5rem;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 0 25px #4a9eff44, 0 3px 6px #00000066;
            letter-spacing: 12px;
            display: block;
            margin-top: 4px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .refresh-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--accent-glow);
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: var(--border);
            border-color: var(--accent-deep);
            box-shadow: 0 0 10px #4a9eff22;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--green-candle);
            display: inline-block;
            margin-right: 4px;
            box-shadow: 0 0 6px #26a69a66;
        }
        .status-dot.error { background: var(--red-candle); box-shadow: 0 0 6px #ef535066; }
        .status-dot.loading { background: var(--accent); animation: pulse 1s infinite; box-shadow: 0 0 6px #4a9eff66; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ============ SECTION HEADERS ============ */
        .section-header {
            font-family: 'Noto Serif JP', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-left: 12px;
            border-left: 3px solid var(--accent);
        }
        .section-header .count {
            background: var(--accent-deep);
            color: var(--text-bright);
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 700;
        }

        /* ============ QUOTE BANNER ============ */
        .quote-banner {
            text-align: center;
            padding: 0.8rem 2rem;
            margin-bottom: 1.25rem;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            border-image: linear-gradient(90deg, transparent, var(--border-light), transparent) 1;
            animation: fadeIn 1s ease;
            background: rgba(10, 15, 25, 0.7);
            border-radius: 8px;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .quote-text {
            font-family: 'Noto Serif JP', serif;
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-bright);
            opacity: 0.9;
            line-height: 1.5;
        }
        .quote-author {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--accent);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-top: 0.3rem;
            opacity: 0.6;
        }

        /* ============ COMMAND BAR ============ */
        .command-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            position: relative;
        }
        .command-input {
            flex: 1;
            background: rgba(10, 15, 25, 0.7);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-bright);
            outline: none;
            transition: border-color 0.2s;
        }
        .command-input::placeholder { color: var(--text-dim); }
        .command-input:focus { border-color: var(--accent); }
        .command-result {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-top: 0.4rem;
            display: none;
        }
        .command-result.success { display: block; background: var(--green-dim); color: var(--green-bright); }
        .command-result.error { display: block; background: var(--red-dim); color: var(--red-bright); }

        /* ============ WEEKLY TASKS ============ */
        .weekly-tasks { margin-bottom: 1.25rem; }
        .weekly-tasks-list {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 0.4rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0;
            box-shadow: 0 0 15px rgba(74, 158, 255, 0.15), inset 0 1px 0 rgba(255,255,255,0.03);
        }
        .weekly-task-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.3rem 0.35rem;
            border-bottom: 1px solid rgba(30, 58, 95, 0.4);
            cursor: pointer;
            transition: opacity 0.2s, background 0.2s;
            border-radius: 4px;
        }
        .weekly-task-item:last-child { border-bottom: none; }
        .weekly-task-item:hover { background: rgba(74, 158, 255, 0.08); }
        .weekly-task-item.checked { opacity: 0.35; }
        .weekly-task-item.checked .task-text { text-decoration: line-through; }
        .weekly-task-checkbox {
            width: 20px; height: 20px;
            border: 2px solid var(--accent);
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(74, 158, 255, 0.08);
            transition: all 0.2s;
            box-shadow: 0 0 6px rgba(74, 158, 255, 0.2);
        }
        .weekly-task-item:hover .weekly-task-checkbox {
            box-shadow: 0 0 10px rgba(74, 158, 255, 0.35);
        }
        .weekly-task-item.checked .weekly-task-checkbox {
            background: var(--green-candle);
            border-color: var(--green-candle);
            box-shadow: 0 0 8px rgba(38, 166, 154, 0.4);
        }
        .weekly-task-item.checked .weekly-task-checkbox::after {
            content: '\2713';
            color: var(--text-bright);
            font-size: 1rem;
            font-weight: 700;
        }
        .task-text {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-bright);
            transition: all 0.2s;
            letter-spacing: 0.02em;
        }

        /* ============ QUICK STATS BAR ============ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-deep), transparent);
        }
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-bright);
            line-height: 1.2;
        }
        .stat-value.green { color: var(--green-bright); text-shadow: 0 0 8px rgba(38,166,154,0.5); }
        .stat-value.red { color: var(--red-bright); text-shadow: 0 0 8px rgba(239,83,80,0.5); }
        .stat-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 6px;
        }

        /* ============ TOP PICKS ============ */
        .picks-actions-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .picks-col, .actions-col { min-width: 0; }
        .open-trades-section { margin-bottom: 1.5rem; }
        .open-trades-filter {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .open-trades-filter input {
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            padding: 0.35rem 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-bright);
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
        }
        .open-trades-filter input::placeholder { color: var(--text-dim); }
        .open-trades-filter input:focus { outline: none; border-color: var(--accent); }
        .ot-filter-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 3px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-dim);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .ot-filter-btn:hover { border-color: var(--accent); color: var(--text-bright); }
        .ot-filter-btn.active {
            background: var(--accent-deep);
            border-color: var(--accent);
            color: var(--text-bright);
        }
        .ot-filter-btn.need-2day-btn.has-alerts {
            background: #1a1a2e;
            border: 2px solid var(--red-bright);
            color: var(--red-bright);
            font-weight: 700;
            font-size: 0.7rem;
            padding: 0.4rem 0.8rem;
            animation: flash2day 1s ease-in-out infinite alternate;
        }
        .ot-filter-btn.need-2day-btn.has-alerts.active {
            background: #2a1525;
        }
        @keyframes flash2day {
            from { box-shadow: 0 0 8px rgba(239, 83, 80, 0.4); text-shadow: 0 0 6px rgba(239, 83, 80, 0.5); }
            to { box-shadow: 0 0 20px rgba(239, 83, 80, 0.8), 0 0 40px rgba(239, 83, 80, 0.3); text-shadow: 0 0 12px rgba(239, 83, 80, 0.8); }
        }
        .open-trades-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .open-trade-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--green-candle);
            border-radius: 4px;
            padding: 0.75rem 1rem;
        }
        .open-trade-item.needs-attention {
            border-left-color: var(--red-candle);
            box-shadow: 0 0 8px rgba(239, 83, 80, 0.15);
        }
        .open-trade-item .ticker-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .open-trade-item .ticker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .open-trade-item .ticker-icon-fallback {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-deep);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .open-trade-item .ticker-badge {
            font-family: 'Noto Serif JP', serif;
            font-weight: 900;
            font-size: 1rem;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .open-trade-item .pnl-badge {
            display: none;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 4px;
            margin-left: auto;
            white-space: nowrap;
        }
        .top-picks-section { margin-bottom: 1.5rem; }
        .top-picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }
        .top-pick-card {
            background: var(--bg-card);
            border: 1px solid var(--accent-glow);
            border-radius: 6px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.25s;
            box-shadow: 0 0 12px rgba(74, 158, 255, 0.25), 0 0 30px rgba(74, 158, 255, 0.1);
            animation: pickGlow 2s ease-in-out infinite alternate;
        }
        @keyframes pickGlow {
            from { box-shadow: 0 0 12px rgba(74, 158, 255, 0.2), 0 0 30px rgba(74, 158, 255, 0.08); }
            to { box-shadow: 0 0 18px rgba(74, 158, 255, 0.35), 0 0 40px rgba(74, 158, 255, 0.15); }
        }
        .top-pick-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-deep), var(--accent-glow), var(--accent-deep));
        }
        .top-pick-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 20px #0008, 0 0 20px #4a9eff15;
            transform: translateY(-2px);
        }
        .top-pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
        }
        .top-pick-symbol {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .top-pick-score {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 3px;
            background: var(--accent-deep);
            color: var(--accent-glow);
            border: 1px solid var(--accent);
        }
        .top-pick-direction {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .top-pick-direction.long { background: var(--green-dim); color: var(--green-bright); }
        .top-pick-direction.short { background: rgba(239, 83, 80, 0.2); color: #ff8a80; border: 1px solid rgba(239, 83, 80, 0.4); }
        .top-pick-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.3rem 1rem;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        .top-pick-details dt { color: var(--text-dim); font-size: 0.6rem; }
        .top-pick-details dd { color: var(--text); font-weight: 700; text-align: right; }
        .claude-analysis {
            font-size: 0.75rem;
            color: var(--text-dim);
            padding: 0.4rem 0.6rem;
            background: rgba(74,158,255,0.08);
            border-left: 2px solid var(--accent);
            border-radius: 4px;
            margin: 0.4rem 0;
            line-height: 1.4;
        }
        .claude-rec {
            font-size: 0.7rem;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 0.3rem;
        }
        .top-pick-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
        }
        .no-picks {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1.5rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            font-style: italic;
        }

        /* ============ ACTION NEEDED ============ */
        .action-section { margin-bottom: 1.5rem; }
        .action-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .action-item {
            background: var(--bg-card);
            border: 1px solid var(--accent-deep);
            border-left: 4px solid var(--accent);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-item .ticker-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .action-item .ticker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .action-item .ticker-icon-fallback {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-deep);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .action-item .ticker-badge {
            font-family: 'Noto Serif JP', serif;
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .action-item .signal-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            letter-spacing: 1px;
        }
        .action-item .signal-tag.buy { background: var(--green-dim); color: var(--green-bright); }
        .action-item .signal-tag.sell { background: rgba(239, 83, 80, 0.2); color: #ff8a80; border: 1px solid rgba(239, 83, 80, 0.4); }
        .action-item .score-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            background: rgba(74,158,255,0.15);
            color: var(--accent);
            margin-left: auto;
        }
        .action-item.pick-glow,
        .action-item.pick-glow.action-item {
            border-top: 3px solid var(--accent-glow);
            border-right: 3px solid var(--accent-glow);
            border-bottom: 3px solid var(--accent-glow);
            border-left: 3px solid var(--accent-glow);
            animation: pickGlowLive 2.5s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        .action-item.pick-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(74, 158, 255, 0.7), 0 0 80px rgba(74, 158, 255, 0.3);
        }
        .action-item.pick-glow::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(74, 158, 255, 0.08) 50%, transparent 60%);
            animation: pickShimmer 3s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes pickGlowLive {
            0%, 100% { box-shadow: 0 0 12px rgba(74, 158, 255, 0.3), 0 0 30px rgba(74, 158, 255, 0.12), inset 0 0 10px rgba(74, 158, 255, 0.03); border-color: var(--accent-glow); }
            50% { box-shadow: 0 0 25px rgba(74, 158, 255, 0.5), 0 0 60px rgba(74, 158, 255, 0.2), inset 0 0 20px rgba(74, 158, 255, 0.06); border-color: #8cc8ff; }
        }
        @keyframes pickShimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        .action-item.pick-demo,
        .action-item.pick-demo.action-item {
            border-top: 3px solid var(--accent-glow);
            border-right: 3px solid var(--accent-glow);
            border-bottom: 3px solid var(--accent-glow);
            border-left: 3px solid var(--accent-glow);
            background: var(--bg-card);
            animation: demoPulse 2s ease-in-out infinite alternate;
        }
        .action-item.pick-demo:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(74, 158, 255, 0.7), 0 0 80px rgba(74, 158, 255, 0.3);
        }
        @keyframes demoPulse {
            0% {
                border-top-color: var(--border);
                border-right-color: var(--border);
                border-bottom-color: var(--border);
                border-left-color: var(--border);
                box-shadow: 0 0 5px rgba(74, 158, 255, 0.05);
            }
            100% {
                border-top-color: #ffffff;
                border-right-color: #ffffff;
                border-bottom-color: #ffffff;
                border-left-color: #ffffff;
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 50px rgba(74, 158, 255, 0.6), 0 0 100px rgba(74, 158, 255, 0.3);
            }
        }
        .action-item .message { display: none; }
        .action-item .meta { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem; }
        .tap-copy { cursor: pointer; padding: 1px 4px; border-radius: 3px; -webkit-tap-highlight-color: transparent; }
        .tap-copy:active { background: var(--green-dim); }
        .action-buttons {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }
        .action-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 3px;
            border: 1px solid var(--border);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .action-btn:hover { transform: translateY(-1px); }
        .action-btn.entered {
            background: var(--green-dim);
            color: var(--green-bright);
            border-color: var(--green-candle);
        }
        .action-btn.entered:hover { background: var(--green-candle); color: var(--text-bright); }
        .action-btn.skipped {
            background: var(--bg-dark);
            color: var(--text-dim);
            border-color: var(--border);
        }
        .action-btn.skipped:hover { background: var(--border); color: var(--text); }
        .action-btn.won {
            background: var(--green-dim);
            color: var(--green-bright);
            border-color: var(--green-candle);
        }
        .action-btn.won:hover { background: var(--green-candle); color: var(--text-bright); }
        .action-btn.lost {
            background: var(--red-dim);
            color: var(--red-bright);
            border-color: var(--red-candle);
        }
        .action-btn.lost:hover { background: var(--red-candle); color: var(--text-bright); }
        .action-btn.open-pos {
            background: #4a9eff22;
            color: var(--accent-glow);
            border-color: #4a9eff44;
        }
        .action-btn.open-pos:hover { background: #4a9eff44; color: var(--text-bright); }
        .action-btn.trade-clock {
            background: rgba(30, 58, 95, 0.3);
            color: var(--text-dim);
            border-color: rgba(30, 58, 95, 0.5);
            font-size: 0.55rem;
            cursor: pointer;
        }
        .action-btn.trade-clock:hover { background: rgba(30, 58, 95, 0.5); color: var(--text); }
        .action-btn.trade-clock.warn {
            background: rgba(255, 160, 0, 0.15);
            color: #ffa000;
            border-color: #ffa000;
        }
        .action-btn.trade-clock.overdue {
            background: rgba(255, 80, 80, 0.15);
            color: var(--red-bright);
            border-color: var(--red-candle);
            animation: pickGlowLive 1.5s ease-in-out infinite alternate;
        }
        .action-btn:disabled {
            opacity: 0.4;
            cursor: default;
            transform: none;
        }
        .entry-input {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-bright);
            padding: 4px 8px;
            border-radius: 3px;
            width: 60px;
            text-align: center;
        }
        .entry-input::placeholder { color: var(--text-dim); }
        .entry-input:focus { outline: none; border-color: var(--accent); }
        .no-actions {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1.5rem;
            text-align: center;
            color: var(--green-candle);
            font-size: 0.8rem;
        }

        /* ============ TICKER GRID ============ */
        .ticker-search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        .ticker-search-bar input {
            flex: 1;
            max-width: 300px;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-bright);
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }
        .ticker-search-bar input::placeholder { color: var(--text-dim); }
        .ticker-search-bar input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .ticker-search-bar button {
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ticker-search-bar button:hover { border-color: var(--accent); color: var(--text-bright); }
        .ticker-search-bar button.active {
            background: var(--accent-deep);
            border-color: var(--accent);
            color: var(--text-bright);
        }
        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            max-height: 600px;
            overflow-y: auto;
        }
        .ticker-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }
        .ticker-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 40px;
            background: linear-gradient(transparent, #0a162808);
            pointer-events: none;
        }
        .ticker-card:hover {
            border-color: var(--accent-deep);
            box-shadow: 0 4px 20px #0008, 0 0 15px #4a9eff11;
            transform: translateY(-2px);
        }
        .ticker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .ticker-coin-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .ticker-coin-fallback {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-deep);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-bright);
        }
        .ticker-name {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--text-bright);
            letter-spacing: 1px;
        }
        .ticker-direction {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ticker-direction.long { background: var(--green-dim); color: var(--green-bright); border: 1px solid var(--green-candle); }
        .ticker-direction.short { background: var(--red-dim); color: var(--red-bright); border: 1px solid var(--red-candle); }
        .ticker-direction.idle { background: var(--bg-dark); color: var(--text-dim); border: 1px solid var(--border); }

        .ticker-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.35rem 1rem;
            font-size: 0.75rem;
        }
        .ticker-detail dt { color: var(--text-dim); font-size: 0.65rem; letter-spacing: 0.5px; }
        .ticker-detail dd { color: var(--text); font-weight: 700; text-align: right; }
        .ticker-detail dd.green { color: var(--green-bright); }
        .ticker-detail dd.red { color: var(--red-bright); }
        .ticker-last-signal {
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
            font-size: 0.65rem;
            color: var(--text-dim);
            font-style: italic;
        }
        .ticker-links {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
        }
        .ticker-link {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 3px;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-dim);
        }
        .ticker-link:hover {
            border-color: var(--accent-deep);
            color: var(--text-bright);
            background: var(--border);
        }
        .ticker-link.tv { color: #2196F3; border-color: #2196F322; }
        .ticker-link.tv:hover { background: #2196F322; border-color: #2196F3; color: #64B5F6; }
        .ticker-link.bx { color: var(--accent-glow); border-color: #4a9eff22; }
        .ticker-link.bx:hover { background: #4a9eff22; border-color: var(--accent); color: var(--accent-glow); }

        /* ============ ALL SIGNALS TABLE ============ */
        .signals-section { margin-bottom: 1.5rem; }
        .section-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
        }
        .signals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .signals-table th {
            text-align: left;
            padding: 0.5rem 0.5rem;
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .signals-table td {
            padding: 0.45rem 0.5rem;
            border-bottom: 1px solid #14223644;
            white-space: nowrap;
        }
        .signals-table tr:hover td { background: #1a2d4544; }
        .signal-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .signal-badge.long { background: var(--green-dim); color: var(--green-bright); }
        .signal-badge.short { background: rgba(239, 83, 80, 0.2); color: #ff8a80; border: 1px solid rgba(239, 83, 80, 0.4); }
        .score-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            display: inline-block;
        }
        .score-badge.high { background: #26a69a33; color: var(--green-bright); border: 1px solid var(--green-candle); }
        .score-badge.mid { background: #f9a82533; color: #f9c846; border: 1px solid #f9a825; }
        .score-badge.low { background: #ef535033; color: var(--red-bright); border: 1px solid var(--red-candle); }

        /* ============ PERFORMANCE GRID ============ */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .perf-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }
        .perf-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 0.4rem;
            text-align: center;
        }
        .perf-item .perf-val {
            font-family: 'Space Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-bright);
            line-height: 1.2;
        }
        .perf-item .perf-label {
            font-size: 0.55rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* ============ LOADING / ERROR ============ */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0a1628ee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-banner {
            background: #ef535018;
            border: 1px solid var(--red-candle);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            color: var(--red-bright);
            font-size: 0.8rem;
            display: none;
        }
        .error-banner.show { display: block; }

        /* ============ ZEN FOOTER ============ */
        .zen-footer {
            text-align: center;
            padding: 2rem 0 1rem;
            position: relative;
        }
        .zen-scene {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 2rem;
            margin-bottom: 1rem;
        }
        .zen-capybara {
            font-size: 5rem;
            line-height: 1;
            animation: capyFloat 4s ease-in-out infinite;
            cursor: pointer;
            user-select: none;
            position: relative;
            filter: drop-shadow(0 0 20px rgba(74, 158, 255, 0.6)) drop-shadow(0 0 50px rgba(74, 158, 255, 0.3)) drop-shadow(0 0 80px rgba(74, 158, 255, 0.15));
            transition: filter 0.3s;
        }
        .zen-capybara:hover {
            filter: drop-shadow(0 0 25px rgba(74, 158, 255, 0.8)) drop-shadow(0 0 60px rgba(74, 158, 255, 0.5)) drop-shadow(0 0 100px rgba(74, 158, 255, 0.25));
        }
        .zen-capybara::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 140px; height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(74, 158, 255, 0.15) 0%, rgba(74, 158, 255, 0.05) 40%, transparent 70%);
            animation: auraGlow 3s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes capyFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.03); }
        }
        @keyframes auraGlow {
            0% { width: 140px; height: 140px; opacity: 0.6; }
            100% { width: 180px; height: 180px; opacity: 1; }
        }
        .zen-credit {
            font-size: 0.55rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 1rem;
            text-shadow: 0 1px 4px rgba(0,0,0,0.7);
        }

        /* ============ RESPONSIVE ============ */
        /* ============ LEVEL UP OVERLAY ============ */
        .levelup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: levelupFadeIn 0.5s ease;
        }
        @keyframes levelupFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes levelupPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes levelupGlow {
            0%, 100% { text-shadow: 0 0 20px var(--green-bright), 0 0 40px rgba(77,208,196,0.5), 0 0 80px rgba(77,208,196,0.2); }
            50% { text-shadow: 0 0 30px var(--green-bright), 0 0 60px rgba(77,208,196,0.7), 0 0 100px rgba(77,208,196,0.3); }
        }
        @keyframes pokeBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }
        @keyframes pokeEvolve {
            0% { filter: brightness(1) drop-shadow(0 0 10px var(--accent-glow)); transform: scale(1); }
            40% { filter: brightness(3) drop-shadow(0 0 40px white); transform: scale(1.3); }
            60% { filter: brightness(3) drop-shadow(0 0 40px white); transform: scale(1.3); }
            100% { filter: brightness(1) drop-shadow(0 0 20px var(--accent-glow)); transform: scale(1); }
        }
        .levelup-content {
            text-align: center;
            animation: levelupPulse 2s ease infinite;
        }
        .levelup-pokemon {
            width: 160px; height: 160px;
            image-rendering: pixelated;
            animation: pokeBounce 1.5s ease infinite;
            filter: drop-shadow(0 0 20px var(--accent-glow)) drop-shadow(0 0 40px rgba(106,180,255,0.3));
        }
        .levelup-pokemon.evolving { animation: pokeEvolve 1.5s ease forwards; }
        .levelup-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent-glow);
            letter-spacing: 4px;
            animation: levelupGlow 2s ease infinite;
            margin: 0.5rem 0;
        }
        .levelup-detail {
            font-size: 1rem;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
            line-height: 1.8;
        }
        .levelup-pokename {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-bright);
            letter-spacing: 2px;
            margin-bottom: 0.3rem;
        }
        .levelup-sizes {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--green-bright);
            text-shadow: 0 0 15px var(--green-bright);
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
        }
        .levelup-tap {
            font-size: 0.7rem;
            color: var(--text-dim);
            letter-spacing: 3px;
            text-transform: uppercase;
            animation: levelupFadeIn 1s ease 1s both;
        }

        /* ============ POKEMON SECTION ============ */
        .pokemon-section { margin: 1.5rem 0; }
        .pokemon-box {
            background: rgba(8,12,18,0.9);
            border: 2px solid var(--accent-deep);
            border-image: linear-gradient(135deg, var(--accent-deep), var(--border-light), var(--accent-deep)) 1;
            padding: 1.5rem 2rem;
            box-shadow: 0 0 20px rgba(74,158,255,0.15), inset 0 0 30px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .pokemon-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--location-bg);
            background-size: cover;
            background-position: center;
            image-rendering: pixelated;
            z-index: -2;
            opacity: 0.8;
        }
        .pokemon-box::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, rgba(12,17,25,0.5) 0%, rgba(12,17,25,0.8) 100%);
            z-index: -1;
        }
        .pokemon-header { text-align: center; margin-bottom: 1rem; }
        .pokemon-level-name {
            font-size: 1.5rem; font-weight: 900; color: var(--accent-glow);
            text-shadow: 0 0 15px var(--accent-glow), 0 0 30px rgba(106,180,255,0.5);
            letter-spacing: 2px;
        }
        .pokemon-sprite {
            width: 280px; height: 280px; image-rendering: pixelated;
            filter: drop-shadow(0 0 15px var(--accent-glow));
            margin: -2rem 0 -4rem;
        }
        .pokemon-pnl { font-size: 1.1rem; font-weight: 700; margin-top: 0.3rem; }
        .pokemon-pnl.positive { color: var(--green-bright); text-shadow: 0 0 10px var(--green-bright); }
        .pokemon-pnl.negative { color: var(--red-bright); text-shadow: 0 0 10px var(--red-bright); }
        .pokemon-pnl.zero { color: var(--text-dim); }
        .pokemon-sizes {
            display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        .pokemon-size-chip {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(74,158,255,0.1);
            border: 1px solid var(--accent-deep);
            border-radius: 20px;
            padding: 0.3rem 0.7rem 0.3rem 0.4rem;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .pokeball-svg { width: 32px; height: 32px; flex-shrink: 0; }
        .pokeball-svg .ball-top { fill: #ef5350; }
        .pokeball-svg .ball-bottom { fill: #fff; }
        .pokeball-svg .ball-line { stroke: #333; stroke-width: 1.5; fill: none; }
        .pokeball-svg .ball-center { fill: #fff; stroke: #333; stroke-width: 1.5; }
        .pokeball-svg .ball-outline { fill: none; stroke: #333; stroke-width: 1.5; }
        .pokemon-size-chip.lead { color: var(--accent-glow); border-color: var(--accent-glow); box-shadow: 0 0 8px rgba(106,180,255,0.3); }
        .pokemon-size-chip.mid { color: var(--accent); border-color: var(--accent); }
        .pokemon-size-chip.half { color: var(--accent); border-color: var(--accent); }
        .pokemon-size-chip.used { color: var(--text-dim); border-color: var(--border); opacity: 0.35; }
        .pokemon-size-chip.used .pokeball-svg .ball-top { fill: #666; }
        .pokemon-size-chip.used .pokeball-svg .ball-bottom { fill: #444; }
        .pokemon-size-chip.used .ball-amt { text-decoration: line-through; }
        .pokemon-xp-bar { margin: 0.8rem auto 1rem; max-width: 450px; }
        .pokemon-xp-track {
            height: 14px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 7px; overflow: hidden;
        }
        .pokemon-xp-fill {
            height: 100%; border-radius: 7px;
            background: linear-gradient(90deg, var(--accent-deep), var(--green-bright));
            box-shadow: 0 0 10px var(--green-bright), 0 0 20px rgba(77,208,196,0.3);
            transition: width 0.8s ease;
        }
        .pokemon-xp-labels {
            display: flex; justify-content: space-between;
            margin-top: 0.3rem; font-size: 0.5rem; color: var(--text-dim);
        }
        .pokemon-next-evolve {
            text-align: center; margin-top: 0.8rem; font-size: 0.75rem;
            color: var(--accent-glow); text-shadow: 0 0 8px rgba(106,180,255,0.4);
            font-weight: 700; padding-top: 0.5rem; border-top: 1px solid var(--border);
        }
        .pokemon-scout-info {
            text-align: center; margin-top: 0.5rem; font-size: 0.7rem;
            color: var(--text-dim); letter-spacing: 0.5px;
        }
        .pokemon-scout-info .scout-val { color: var(--green-bright); font-weight: 700; }
        .pokemon-scout-info .scout-warn { color: var(--red-bright); font-weight: 700; }

        /* DCA Mode */
        .dca-controls {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            margin-bottom: 0.8rem; flex-wrap: wrap;
        }
        .dca-toggle-btn {
            background: #0a0f18; border: 2px solid var(--border); color: var(--text-dim);
            padding: 10px 22px; border-radius: 6px; cursor: pointer;
            font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px; transition: all 0.2s;
        }
        .dca-toggle-btn.active {
            background: #0d1a2e; border-color: var(--accent-glow);
            color: #fff; box-shadow: 0 0 20px rgba(74,158,255,0.5), inset 0 0 15px rgba(74,158,255,0.15);
            text-shadow: 0 0 10px var(--accent-glow);
        }
        .dca-levelup-btn {
            background: #0a1a18; border: 2px solid var(--green-bright);
            color: #fff; padding: 10px 22px; border-radius: 6px; cursor: pointer;
            font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
            text-shadow: 0 0 10px var(--green-bright);
            box-shadow: 0 0 15px rgba(38,166,154,0.4);
        }
        .dca-levelup-btn:hover { background: #0f2a25; box-shadow: 0 0 25px rgba(38,166,154,0.6); }
        .dca-levelup-btn:disabled { opacity: 0.4; cursor: default; box-shadow: none; text-shadow: none; }
        .dca-organic-label {
            text-align: center; font-size: 0.65rem; color: var(--text-dim);
            margin-top: 0.3rem; letter-spacing: 0.5px;
        }
        .dca-organic-label img { width: 20px; height: 20px; image-rendering: pixelated; vertical-align: middle; margin: 0 3px; }
        .dca-deposit-total {
            text-align: center; font-size: 0.6rem; color: var(--accent-glow);
            margin-top: 0.2rem; letter-spacing: 0.5px;
        }
        .dca-health {
            text-align: center; margin-top: 0.5rem; padding: 0.5rem 0.8rem;
            background: rgba(12,17,25,0.7); border-radius: 6px;
            border: 1px solid var(--border); font-size: 0.7rem;
        }
        .dca-health .health-status { font-weight: 700; font-size: 0.75rem; }
        .dca-health .health-status.healthy { color: var(--green-bright); text-shadow: 0 0 8px var(--green-bright); }
        .dca-health .health-status.caution { color: #ffa726; text-shadow: 0 0 8px #ffa726; }
        .dca-health .health-status.danger { color: var(--red-bright); text-shadow: 0 0 8px var(--red-bright); }
        .dca-health .health-detail { font-size: 0.6rem; color: var(--text-dim); margin-top: 0.2rem; }
        .dca-health .health-roi { font-size: 0.6rem; margin-top: 0.15rem; }
        .dca-health .health-roi.positive { color: var(--green-bright); }
        .dca-health .health-roi.negative { color: var(--red-bright); }

        @media (max-width: 768px) {
            .content { padding: 0.25rem 1rem 1rem; }
            .header { flex-direction: column; gap: 0.5rem; text-align: center; }
            .header-left { flex-direction: row; align-items: center; justify-content: center; gap: 1rem; }
            .header-logo { display: none; }
            .header h1 { font-size: 2rem; }
            .trade-clock { display: none !important; }
            .need-2day-btn { display: none !important; }
            .header h1 span { font-size: 1.8rem; }
            .picks-actions-row { grid-template-columns: 1fr; }
            .ticker-grid { grid-template-columns: 1fr; }
            .top-picks-grid { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .ticker-grid { max-height: 500px; overflow-y: auto; }
            .command-bar { display: none; }
            body::before { top: 0; left: 0; right: 0; bottom: 0; background: url('wave-bg-mobile.png') center center / cover no-repeat; filter: brightness(0.95); }
            .quote-banner { display: none; }
            .mobile-capybara-top { display: block !important; }
            .zen-capybara { display: none; }
            #zenWisdomText { display: none; }
            .mobile-footer-quote { display: block !important; }
            .open-trade-item .pnl-display { min-width: 50px; }
            .open-trade-item .action-buttons { display: grid !important; grid-template-columns: repeat(4, 1fr); gap: 4px; }
            .open-trade-item .action-buttons .entry-input { grid-column: 1 / -1; width: 55px !important; }
            .open-trade-item .action-buttons .action-btn { padding: 5px 4px; font-size: 0.5rem; }
            .pokemon-section { margin: 1rem 0; }
            .pokemon-box { padding: 1rem 1.2rem; }
            .pokemon-sprite { width: 180px; height: 180px; margin: -1rem 0 -2rem; }
            .pokemon-level-name { font-size: 1.2rem; }
            .pokemon-xp-bar { max-width: 100%; }
            .pokemon-sizes { gap: 0.3rem; overflow-x: auto; -webkit-overflow-scrolling: touch; justify-content: flex-start; padding: 0 0.2rem; }
            .pokemon-size-chip { padding: 0.2rem 0.5rem 0.2rem 0.3rem; font-size: 0.65rem; }
            .pokeball-svg { width: 24px; height: 24px; }
            .weekly-tasks { display: none !important; }
            .two-day-btn { display: none !important; }
        }
    </style>
</head>
<body>

<!-- ============ LOADING ============ -->
<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="color: var(--text-dim); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;">Loading dashboard...</div>
</div>

<!-- Level Up Overlay (Pokemon Evolution) -->
<div class="levelup-overlay" id="levelupOverlay" style="display:none" onclick="dismissLevelUp()">
    <div class="levelup-content">
        <img class="levelup-pokemon" id="levelupSprite" src="" alt="">
        <div class="levelup-title" id="levelupTitle">EVOLUTION!</div>
        <div class="levelup-pokename" id="levelupPokename"></div>
        <div class="levelup-detail" id="levelupDetail"></div>
        <div class="levelup-sizes" id="levelupSizes"></div>
        <div class="levelup-tap">tap to continue</div>
    </div>
</div>

<!-- ============ MAIN CONTENT ============ -->
<div class="content">
    <div class="error-banner" id="errorBanner"></div>

    <div class="header">
        <div class="header-left">
            <img class="header-logo" src="logo.png" alt="Trade">
            <div>
                <h1>ãƒˆãƒ¬ãƒ¼ãƒ‰<span>TRADE!</span></h1>
            </div>
            <div class="mobile-capybara-top" style="display:none">
                <svg viewBox="150 380 550 580" width="70" height="70">
                    <g fill="none" stroke="var(--accent-glow)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M180 750 Q150 650 200 580 Q220 550 250 540 Q280 530 320 540 L340 545"/>
                        <path d="M340 545 Q380 500 420 480 Q480 450 540 460 Q600 470 640 510 Q680 550 690 600 Q695 640 680 680 Q660 720 620 740 Q560 770 480 760 Q400 750 340 720 Q300 700 280 680"/>
                        <path d="M380 480 Q370 440 390 410 Q410 385 440 390 Q460 400 455 430 Q450 455 430 470"/>
                        <path d="M540 455 Q550 420 580 400 Q610 385 635 400 Q655 420 645 455 Q635 480 610 490"/>
                        <circle cx="480" cy="540" r="18" fill="var(--accent-deep)"/>
                        <circle cx="485" cy="535" r="6" fill="var(--accent-glow)"/>
                        <ellipse cx="580" cy="580" rx="25" ry="18" fill="var(--accent-deep)"/>
                        <circle cx="570" cy="575" r="4" fill="var(--accent-glow)"/>
                        <circle cx="590" cy="575" r="4" fill="var(--accent-glow)"/>
                        <path d="M560 610 Q580 625 600 610"/>
                        <path d="M620 570 L680 550"/><path d="M625 590 L690 590"/><path d="M620 610 L680 630"/>
                        <path d="M320 700 Q310 750 320 800 Q325 830 350 840 Q380 845 390 820 Q400 790 395 750"/>
                        <path d="M450 750 Q445 800 455 840 Q465 870 495 870 Q525 865 530 835 Q535 800 520 760"/>
                        <path d="M280 680 Q240 720 220 780 Q200 850 230 900 Q260 940 320 940 Q370 935 380 890 Q390 840 370 800"/>
                    </g>
                </svg>
            </div>
        </div>
        <div class="header-right">
            <span><span class="status-dot loading" id="statusDot"></span><span id="statusText">Connecting...</span></span>
            <span id="lastUpdate"></span>
            <button class="refresh-btn" onclick="fetchData()">Refresh</button>
        </div>
    </div>

    <!-- Quote Banner -->
    <div class="quote-banner" id="quoteBanner">
        <div class="quote-text" id="quoteText"></div>
        <div class="quote-author" id="quoteAuthor"></div>
    </div>

    <!-- Command Bar -->
    <div class="command-bar">
        <input type="text" class="command-input" id="commandInput" placeholder="$ = Bitunix | ! = TradingView" autocomplete="off">
    </div>
    <div class="command-result" id="commandResult"></div>

    <!-- Weekly Tasks -->
    <div class="weekly-tasks" id="weeklyTasks" style="display: none;">
        <div class="section-header">Weekly Tasks <span class="count" id="weeklyTasksCount">0</span></div>
        <div class="weekly-tasks-list" id="weeklyTasksList"></div>
    </div>

    <!-- Quick Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-card">
            <div class="stat-value" id="statOpen">-</div>
            <div class="stat-label">Open Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statWinRate">-</div>
            <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statTotal">-</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statToday">-</div>
            <div class="stat-label">Today's Signals</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statPnL">-</div>
            <div class="stat-label">Total P&L</div>
        </div>
    </div>

    <!-- Top Picks + Action Needed (two columns) -->
    <div class="picks-actions-row">
        <div class="picks-col">
            <div class="section-header">Top Picks <span class="count" id="topPicksCount">0</span></div>
            <div class="top-picks-grid" id="topPicksGrid" style="max-height: 480px; overflow-y: auto;"></div>
        </div>
        <div class="actions-col">
            <div class="section-header">Action Needed <span class="count" id="actionCount">0</span></div>
            <div class="action-list" id="actionList" style="max-height: 480px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Open Trades -->
    <div class="open-trades-section" id="openTradesSection">
        <div class="section-header">Open Trades <span class="count" id="openTradesCount">0</span></div>
        <div class="open-trades-filter">
            <input type="text" id="otSearch" placeholder="Search ticker..." oninput="filterOpenTrades()">
            <button class="ot-filter-btn active" data-filter="all" onclick="setOTFilter(this,'all')">All</button>
            <button class="ot-filter-btn" data-filter="no-0x0" onclick="setOTFilter(this,'no-0x0')">No 0x0</button>
            <button class="ot-filter-btn" data-filter="no-tp" onclick="setOTFilter(this,'no-tp')">No TP</button>
            <button class="ot-filter-btn need-2day-btn" data-filter="need-2day" onclick="setOTFilter(this,'need-2day')" id="need2dayFilter">Need 2 Day</button>
        </div>
        <div class="open-trades-list" id="openTradesList" style="max-height: 480px; overflow-y: auto;"></div>
    </div>

    <!-- Pokemon Trainer Level -->
    <div class="pokemon-section" id="pokemonSection">
        <div class="section-header" style="margin-top:2rem">Trainer Level</div>
        <div class="dca-controls" id="dcaControls">
            <button class="dca-toggle-btn" id="dcaToggleBtn" onclick="toggleDCAMode()">DCA: OFF</button>
            <button class="dca-levelup-btn" id="dcaLevelUpBtn" onclick="dcaLevelUp()" style="display:none">Level Up</button>
        </div>
        <div class="pokemon-box" id="pokemonBox"></div>
    </div>

    <!-- Ticker Grid -->
    <div class="section-header">Tickers</div>
    <div class="ticker-search-bar">
        <input type="text" id="tickerSearch" placeholder="Search tickers..." oninput="filterTickers()">
        <button id="tickerShowAll" onclick="toggleShowAll()">Show All</button>
    </div>
    <div class="ticker-grid" id="tickerGrid"></div>

    <!-- All Signals Table -->
    <div class="signals-section">
        <div class="section-header">All Signals</div>
        <div class="section-box" style="max-height: 250px; overflow-y: auto;">
            <table class="signals-table" id="signalsTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>Entry</th>
                        <th>SL</th>
                        <th>TP1</th>
                        <th>Score</th>
                        <th>MACD</th>
                        <th>Volume</th>
                        <th>RSI</th>
                    </tr>
                </thead>
                <tbody id="signalsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Performance Summary -->
    <div class="bottom-grid">
        <div>
            <div class="section-header">Performance Summary</div>
            <div class="section-box">
                <div class="perf-grid" id="perfGrid"></div>
            </div>
        </div>
    </div>

    <!-- Capybara Footer -->
    <div class="zen-footer">
        <div style="display:flex;align-items:center;justify-content:center;margin-bottom:1rem;">
            <div class="zen-capybara" id="zenCapybara" title="Click me!" style="margin:0;">
                <svg viewBox="150 380 550 580" width="140" height="140">
                    <g fill="none" stroke="var(--accent-glow)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M180 750 Q150 650 200 580 Q220 550 250 540 Q280 530 320 540 L340 545"/>
                        <path d="M340 545 Q380 500 420 480 Q480 450 540 460 Q600 470 640 510 Q680 550 690 600 Q695 640 680 680 Q660 720 620 740 Q560 770 480 760 Q400 750 340 720 Q300 700 280 680"/>
                        <path d="M380 480 Q370 440 390 410 Q410 385 440 390 Q460 400 455 430 Q450 455 430 470"/>
                        <path d="M540 455 Q550 420 580 400 Q610 385 635 400 Q655 420 645 455 Q635 480 610 490"/>
                        <circle cx="480" cy="540" r="18" fill="var(--accent-deep)"/>
                        <circle cx="485" cy="535" r="6" fill="var(--accent-glow)"/>
                        <ellipse cx="580" cy="580" rx="25" ry="18" fill="var(--accent-deep)"/>
                        <circle cx="570" cy="575" r="4" fill="var(--accent-glow)"/>
                        <circle cx="590" cy="575" r="4" fill="var(--accent-glow)"/>
                        <path d="M560 610 Q580 625 600 610"/>
                        <path d="M620 570 L680 550"/>
                        <path d="M625 590 L690 590"/>
                        <path d="M620 610 L680 630"/>
                        <path d="M320 700 Q310 750 320 800 Q325 830 350 840 Q380 845 390 820 Q400 790 395 750"/>
                        <path d="M450 750 Q445 800 455 840 Q465 870 495 870 Q525 865 530 835 Q535 800 520 760"/>
                        <path d="M280 680 Q240 720 220 780 Q200 850 230 900 Q260 940 320 940 Q370 935 380 890 Q390 840 370 800"/>
                        <path d="M350 680 Q360 700 350 720"/>
                        <path d="M380 690 Q390 710 380 730"/>
                        <path d="M410 695 Q420 715 410 735"/>
                    </g>
                </svg>
            </div>
        </div>
        <div id="zenWisdomText" style="font-family:'Noto Serif JP',serif;font-size:0.85rem;font-style:italic;color:white;margin-top:0.5rem;cursor:pointer;max-width:520px;margin-left:auto;margin-right:auto;line-height:1.6;background:rgba(8,12,18,0.92);padding:0.8rem 1.4rem;border-radius:8px;border:1px solid var(--accent-deep);box-shadow:0 0 15px rgba(0,0,0,0.5);transition:opacity 0.3s;text-shadow:0 1px 3px rgba(0,0,0,0.5)" onclick="showZenWisdom()">click the capybara</div>
        <div class="mobile-footer-quote" id="mobileFooterQuote" style="display:none;font-family:'Noto Serif JP',serif;font-size:0.85rem;font-style:italic;color:white;margin-top:0.5rem;max-width:520px;margin-left:auto;margin-right:auto;line-height:1.6;background:rgba(8,12,18,0.92);padding:0.8rem 1.4rem;border-radius:8px;border:1px solid var(--accent-deep);box-shadow:0 0 15px rgba(0,0,0,0.5);text-shadow:0 1px 3px rgba(0,0,0,0.5);text-align:center"></div>
        <div class="zen-credit">Crypto Trade Dashboard</div>
    </div>
</div>

<script>
    // ====== CONFIG ======
    const API_URL = 'https://script.google.com/macros/s/AKfycbywWcasm7wwI14tUc64XpTscePJlgiU3Q7sZ4uY-TmqjqVZzuxJOhf6T8fO2ZpSaKwV/exec?action=dashboard';
    const POST_URL = 'https://script.google.com/macros/s/AKfycbywWcasm7wwI14tUc64XpTscePJlgiU3Q7sZ4uY-TmqjqVZzuxJOhf6T8fO2ZpSaKwV/exec';
    const REFRESH_INTERVAL = 60000;

    // DCA state
    let dcaMode = localStorage.getItem('dca_mode') === 'true';
    let dcaTotal = parseFloat(localStorage.getItem('dca_total')) || 0;

    // GET request that reads response and alerts on error
    async function fireGet(url) {
        try {
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.status === 'error') {
                alert('Update failed: ' + (data.message || 'Unknown error'));
            }
            return data;
        } catch (e) {
            alert('Request failed: ' + e.message);
            return { status: 'error', message: e.message };
        }
    }


    // ====== BACKTEST DATA (Feb 17, 2026 â€” 529 crypto tickers) ======
    const BT_DEFAULTS = { buy: { sl:14.5, tp:15, halfTp:7 }, sell: { sl:20, tp:13, halfTp:7 } };
const BACKTEST = {
  '0GUSDT': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad buy' },
  '1000CATUSDT': { buyWr:null, sellWr:40, reduceWr:0, note:'Bad buy' },
  '1INCHUSDT': { buyWr:26, sellWr:23.1, reduceWr:41.7, note:null },
  '2ZUSDC': { buyWr:0, sellWr:100, reduceWr:null, note:null },
  '4USDT.P': { buyWr:40, sellWr:null, reduceWr:null, note:null },
  'A2ZUSDT': { buyWr:33.3, sellWr:0, reduceWr:null, note:null },
  'AAVEUSDT': { buyWr:21.5, sellWr:35.7, reduceWr:38.5, note:'Strong both' },
  'ACEUSDT.P': { buyWr:25, sellWr:33.3, reduceWr:25, note:null },
  'ACHUSDT': { buyWr:22, sellWr:20, reduceWr:0, note:null },
  'ACTUSDT': { buyWr:null, sellWr:25, reduceWr:50, note:'Bad buy' },
  'ACUUSDT.P': { buyWr:50, sellWr:null, reduceWr:null, note:null },
  'ACXUSD': { buyWr:26.7, sellWr:20, reduceWr:75, note:null },
  'ADAUSDT': { buyWr:null, sellWr:22.2, reduceWr:26.7, note:'Bad buy' },
  'AERGOUSDT': { buyWr:52.3, sellWr:22.2, reduceWr:12.5, note:'Strong buy' },
  'AEROUSD': { buyWr:25.8, sellWr:18.2, reduceWr:42.9, note:null },
  'AEVOUSDT': { buyWr:23.1, sellWr:50, reduceWr:33.3, note:'Strong sell' },
  'AGLDUSDT.P': { buyWr:29.2, sellWr:31.3, reduceWr:55.6, note:'Strong sell' },
  'AIAUSDT': { buyWr:66.7, sellWr:null, reduceWr:0, note:'Never short' },
  'AINUSDT.P': { buyWr:16.7, sellWr:66.7, reduceWr:50, note:'Strong sell' },
  'AIOTUSDT.P': { buyWr:33.3, sellWr:null, reduceWr:100, note:'Never short' },
  'AIOUSDT.P': { buyWr:0, sellWr:50, reduceWr:0, note:null },
  'AIUSDT': { buyWr:27.3, sellWr:21.4, reduceWr:33.3, note:null },
  'AIXBTUSDT.P': { buyWr:22.7, sellWr:20, reduceWr:33.3, note:'Avoid sells' },
  'AKEUSD': { buyWr:16.7, sellWr:0, reduceWr:100, note:null },
  'ALCHUSD': { buyWr:25, sellWr:33.3, reduceWr:100, note:null },
  'ALGOUSDT': { buyWr:23.4, sellWr:30, reduceWr:23.5, note:null },
  'ALICEUSDT': { buyWr:25, sellWr:27.6, reduceWr:26.3, note:null },
  'ALLOUSDT': { buyWr:33.3, sellWr:null, reduceWr:null, note:null },
  'ALPINEUSDT': { buyWr:30, sellWr:0, reduceWr:100, note:null },
  'ALTUSDT': { buyWr:25, sellWr:22.2, reduceWr:20, note:null },
  'ANIMEUSDT': { buyWr:18.2, sellWr:33.3, reduceWr:50, note:null },
  'ANKRUSD': { buyWr:null, sellWr:34.4, reduceWr:50, note:'Bad buy / Strong both' },
  'APEUSDT': { buyWr:20.5, sellWr:33.3, reduceWr:0, note:null },
  'APEXUSDT': { buyWr:35.7, sellWr:45.5, reduceWr:42.9, note:'Strong buy' },
  'API3USDT.P': { buyWr:28.3, sellWr:26.3, reduceWr:40, note:null },
  'APRUSDT.P': { buyWr:0, sellWr:100, reduceWr:null, note:null },
  'APTUSD': { buyWr:31.3, sellWr:20, reduceWr:20, note:null },
  'ARBUSDT': { buyWr:25.9, sellWr:33.3, reduceWr:42.9, note:'Strong sell' },
  'ARIAUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'ARKMUSDT.P': { buyWr:22.6, sellWr:43.8, reduceWr:60, note:'Strong sell' },
  'ARKUSDT': { buyWr:41.7, sellWr:37.5, reduceWr:50, note:'Strong both' },
  'ARPAUSDT': { buyWr:35.8, sellWr:18.8, reduceWr:14.3, note:'Strong both' },
  'ARUSDT': { buyWr:22.2, sellWr:8.3, reduceWr:36.4, note:'Avoid sells' },
  'ASRUSDT.P': { buyWr:50, sellWr:50, reduceWr:100, note:'Strong both' },
  'ASTERUSDT': { buyWr:null, sellWr:0, reduceWr:100, note:'Bad buy' },
  'ASTRUSDT': { buyWr:34.1, sellWr:25, reduceWr:33.3, note:null },
  'ATHUSD': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad both' },
  'ATOMUSDT': { buyWr:31.7, sellWr:20.7, reduceWr:9.1, note:null },
  'ATUSDT.P': { buyWr:100, sellWr:0, reduceWr:null, note:null },
  'AUCTIONUSDT.P': { buyWr:52, sellWr:10, reduceWr:100, note:'Strong buy' },
  'AUSDT': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad buy' },
  'AVAAIUSDT.P': { buyWr:27.3, sellWr:25, reduceWr:25, note:null },
  'AVAUSDT.P': { buyWr:null, sellWr:0, reduceWr:100, note:'Bad buy' },
  'AVAXUSDT': { buyWr:28.1, sellWr:23.1, reduceWr:40, note:null },
  'AVNTUSDT': { buyWr:null, sellWr:0, reduceWr:50, note:'Bad both' },
  'AWEUSDT': { buyWr:50, sellWr:25, reduceWr:100, note:'Strong buy' },
  'AXLUSDT': { buyWr:37, sellWr:28.6, reduceWr:40, note:'Strong buy' },
  'AXSUSDT': { buyWr:32.1, sellWr:30, reduceWr:50, note:'Strong buy' },
  'AZTECUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'B2USD': { buyWr:50, sellWr:100, reduceWr:0, note:'Strong buy' },
  'B3USDT.P': { buyWr:44.4, sellWr:50, reduceWr:0, note:'Strong both' },
  'BABYUSDT': { buyWr:41.7, sellWr:50, reduceWr:33.3, note:'Strong both' },
  'BANANAS31USDT': { buyWr:40, sellWr:0, reduceWr:0, note:'Strong buy' },
  'BANANAUSDT': { buyWr:30.4, sellWr:22.2, reduceWr:50, note:null },
  'BANDUSDT': { buyWr:33.3, sellWr:30.4, reduceWr:35, note:null },
  'BANKUSDT': { buyWr:50, sellWr:null, reduceWr:null, note:null },
  'BANUSDT.P': { buyWr:44.4, sellWr:40, reduceWr:0, note:'Strong buy' },
  'BARDUSDT': { buyWr:75, sellWr:0, reduceWr:null, note:'Strong buy' },
  'BASUSDT.P': { buyWr:25, sellWr:null, reduceWr:0, note:'Never short' },
  'BATUSD': { buyWr:30.6, sellWr:22.2, reduceWr:28.6, note:null },
  'BBUSDT': { buyWr:20, sellWr:25, reduceWr:33.3, note:null },
  'BCHUSDT': { buyWr:26.8, sellWr:15.4, reduceWr:0, note:'Bad sell' },
  'BDXNUSDT': { buyWr:66.7, sellWr:0, reduceWr:null, note:null },
  'BEAMXUSDT': { buyWr:27.3, sellWr:22.2, reduceWr:50, note:null },
  'BEATUSDT.P': { buyWr:50, sellWr:0, reduceWr:null, note:null },
  'BERAUSDT': { buyWr:26.3, sellWr:16.7, reduceWr:50, note:null },
  'BICOUSDT': { buyWr:19, sellWr:26.3, reduceWr:16.7, note:null },
  'BIGTIMEUSDT.P': { buyWr:22.2, sellWr:53.3, reduceWr:25, note:'Strong sell' },
  'BIOUSDT': { buyWr:29.4, sellWr:75, reduceWr:66.7, note:'Strong sell' },
  'BLESSUSDT.P': { buyWr:66.7, sellWr:0, reduceWr:null, note:null },
  'BLUAIUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'BLURUSDT.P': { buyWr:26.9, sellWr:20, reduceWr:40, note:null },
  'BMTUSDT.P': { buyWr:33.3, sellWr:50, reduceWr:0, note:null },
  'BNBUSDT': { buyWr:28.8, sellWr:12.8, reduceWr:44.4, note:'Bad sell' },
  'BNTUSDT': { buyWr:24, sellWr:29.2, reduceWr:44.4, note:null },
  'BOBBOBUSDC': { buyWr:25, sellWr:null, reduceWr:null, note:null },
  'BOMEUSDT.P': { buyWr:31.8, sellWr:33.3, reduceWr:60, note:'Strong sell' },
  'BONKUSDT': { buyWr:37.2, sellWr:20, reduceWr:60, note:'Strong buy' },
  'BRETTUSDT': { buyWr:37, sellWr:40, reduceWr:66.7, note:'Strong both' },
  'BREVUSDT': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'BROCCOLI714USDC': { buyWr:null, sellWr:0, reduceWr:100, note:'Bad both' },
  'BRUSDT.P': { buyWr:40, sellWr:50, reduceWr:0, note:null },
  'BSVUSDT': { buyWr:38.7, sellWr:16.7, reduceWr:33.3, note:'Strong buy' },
  'BTCUSDT': { buyWr:32.4, sellWr:16.7, reduceWr:40, note:'Bad sell' },
  'BTRUSDT.P': { buyWr:37.5, sellWr:null, reduceWr:100, note:'Never short' },
  'BUSDT.P': { buyWr:50, sellWr:75, reduceWr:33.3, note:'Strong both' },
  'C98USDT': { buyWr:30.6, sellWr:33.3, reduceWr:50, note:'Strong sell' },
  'CAKEUSDT': { buyWr:42.2, sellWr:13.3, reduceWr:28.6, note:'Bad sell / Strong both' },
  'CARVEUR': { buyWr:27.3, sellWr:0, reduceWr:0, note:null },
  'CATIUSDC.P': { buyWr:22.2, sellWr:20, reduceWr:0, note:null },
  'CCUSDT': { buyWr:66.7, sellWr:50, reduceWr:100, note:'Strong both' },
  'CELOUSDT': { buyWr:21.2, sellWr:25, reduceWr:33.3, note:null },
  'CELRUSD': { buyWr:24.1, sellWr:21.6, reduceWr:23.1, note:null },
  'CETUSUSDC': { buyWr:25, sellWr:0, reduceWr:0, note:'Bad sell' },
  'CFXUSDT': { buyWr:44, sellWr:24, reduceWr:50, note:'Strong buy' },
  'CGPTUSDC': { buyWr:21.4, sellWr:100, reduceWr:0, note:null },
  'CHEEMSUSDT': { buyWr:33.3, sellWr:20, reduceWr:50, note:null },
  'CHESSUSDT': { buyWr:31.6, sellWr:20, reduceWr:27.3, note:null },
  'CHILLGUYUSDT.P': { buyWr:null, sellWr:0, reduceWr:50, note:'Bad both' },
  'CHRUSDT': { buyWr:27.8, sellWr:33.3, reduceWr:35.7, note:null },
  'CHZUSD': { buyWr:29.6, sellWr:0, reduceWr:16.7, note:'Bad sell' },
  'CKBUSDC': { buyWr:33.3, sellWr:22.2, reduceWr:40, note:null },
  'CLANKERUSDT.P': { buyWr:25, sellWr:33.3, reduceWr:25, note:null },
  'CLOUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:'Never short' },
  'COAIUSDT.P': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad buy' },
  'COLLECTUSDT.P': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'COMMONUSDT': { buyWr:20, sellWr:null, reduceWr:null, note:null },
  'COMPUSD': { buyWr:31.6, sellWr:32.3, reduceWr:35.3, note:null },
  'COOKIEUSD': { buyWr:33.3, sellWr:25, reduceWr:50, note:null },
  'COREUSDT': { buyWr:26.5, sellWr:50, reduceWr:57.1, note:'Strong sell' },
  'COSUSDT.P': { buyWr:25, sellWr:33.3, reduceWr:50, note:null },
  'COTIUSDT': { buyWr:30.3, sellWr:26.2, reduceWr:11.8, note:null },
  'COWUSD': { buyWr:44.4, sellWr:20, reduceWr:0, note:'Strong buy' },
  'CROSSUSDT.P': { buyWr:20, sellWr:0, reduceWr:0, note:null },
  'CRVUSDT': { buyWr:29.5, sellWr:23.5, reduceWr:42.9, note:null },
  'CTKUSDT.P': { buyWr:29.6, sellWr:6.7, reduceWr:28.6, note:'Bad sell' },
  'CTSIUSD': { buyWr:22.6, sellWr:13.3, reduceWr:50, note:'Bad sell' },
  'CUDISUSDT': { buyWr:42.9, sellWr:33.3, reduceWr:0, note:null },
  'CUSDT.P': { buyWr:22.2, sellWr:100, reduceWr:0, note:'Strong sell' },
  'CVCUSD': { buyWr:25, sellWr:23.1, reduceWr:33.3, note:null },
  'CVXUSDT': { buyWr:27.5, sellWr:22.2, reduceWr:100, note:'Strong sell' },
  'CYBERUSDT': { buyWr:28, sellWr:25, reduceWr:57.1, note:null },
  'CYSUSDT': { buyWr:null, sellWr:0, reduceWr:0, note:'Bad both' },
  'DCRUSDT': { buyWr:41.8, sellWr:13, reduceWr:33.3, note:'Strong both' },
  'DEEPUSD': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad both' },
  'DEGOUSDT.P': { buyWr:null, sellWr:0, reduceWr:0, note:'Bad both' },
  'DENTUSDT.P': { buyWr:null, sellWr:36.4, reduceWr:36.4, note:'Bad buy' },
  'DEXEUSDT': { buyWr:36.7, sellWr:20, reduceWr:0, note:'Bad sell' },
  'DIAUSD': { buyWr:40.6, sellWr:12.5, reduceWr:33.3, note:'Strong buy' },
  'DNUSDT': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'DOGEUSDT': { buyWr:20.9, sellWr:29.3, reduceWr:30.8, note:null },
  'DOGSUSDT': { buyWr:null, sellWr:28.6, reduceWr:25, note:'Bad buy' },
  'DOGUSDT': { buyWr:23.3, sellWr:30.8, reduceWr:50, note:'Strong sell' },
  'DOLOUSDT': { buyWr:28.6, sellWr:null, reduceWr:null, note:null },
  'DOODUSDT.P': { buyWr:55.6, sellWr:0, reduceWr:100, note:'Strong buy' },
  'DOTUSDT.P': { buyWr:20.8, sellWr:11.1, reduceWr:60, note:'Strong both' },
  'DRIFTUSD': { buyWr:17.6, sellWr:16.7, reduceWr:50, note:null },
  'DUSKUSDT': { buyWr:37.3, sellWr:12.8, reduceWr:37.5, note:'Strong buy' },
  'DYDXUSDT': { buyWr:25.5, sellWr:21.1, reduceWr:40, note:null },
  'DYMUSDT.P': { buyWr:14.7, sellWr:42.9, reduceWr:40, note:'Strong both' },
  'EDENUSDT': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'EDUUSDT': { buyWr:29.2, sellWr:33.3, reduceWr:50, note:null },
  'EGLDUSDT': { buyWr:30, sellWr:27.6, reduceWr:30.8, note:null },
  'EIGENUSDT': { buyWr:28.6, sellWr:11.1, reduceWr:100, note:'Bad sell' },
  'ELSAUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'ENAUSDT': { buyWr:39.1, sellWr:66.7, reduceWr:62.5, note:'Strong both' },
  'ENJUSDT': { buyWr:24.7, sellWr:26.8, reduceWr:23.1, note:null },
  'ENSOUSDT': { buyWr:100, sellWr:null, reduceWr:0, note:'Never short' },
  'ENSOUSDT.P': { buyWr:100, sellWr:null, reduceWr:0, note:'Never short' },
  'EPICUSDT.P': { buyWr:27.3, sellWr:33.3, reduceWr:0, note:null },
  'EPTUSDT': { buyWr:null, sellWr:16.7, reduceWr:20, note:'Bad overall' },
  'ERAUSDT.P': { buyWr:25, sellWr:100, reduceWr:100, note:'Strong sell' },
  'ESPORTSUSD': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'ESPUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'ETCUSDT': { buyWr:23.1, sellWr:28.3, reduceWr:17.6, note:null },
  'ETHFIUSDT': { buyWr:32.1, sellWr:40, reduceWr:16.7, note:null },
  'ETHUSDT': { buyWr:24.6, sellWr:22, reduceWr:33.3, note:null },
  'ETHWUSDT.P': { buyWr:42.1, sellWr:50, reduceWr:25, note:'Strong both' },
  'EULUSD': { buyWr:null, sellWr:0, reduceWr:100, note:'Bad buy' },
  'EVAAUSDT': { buyWr:40, sellWr:null, reduceWr:null, note:'Never short' },
  'FARTCOINUSDT': { buyWr:30.4, sellWr:18.2, reduceWr:20, note:null },
  'FETUSDT': { buyWr:32.1, sellWr:23.1, reduceWr:25, note:null },
  'FFUSDT': { buyWr:50, sellWr:100, reduceWr:0, note:null },
  'FHEUSDT.P': { buyWr:50, sellWr:33.3, reduceWr:0, note:null },
  'FIDAUSDT.P': { buyWr:29.4, sellWr:14.3, reduceWr:0, note:'Bad sell' },
  'FILUSDT': { buyWr:25.5, sellWr:26.1, reduceWr:45.5, note:null },
  'FIOUSDT': { buyWr:39.1, sellWr:6.3, reduceWr:42.9, note:'Bad sell / Strong both' },
  'FLOCKUSDC': { buyWr:66.7, sellWr:0, reduceWr:0, note:'Strong buy' },
  'FLOKIUSDT': { buyWr:27.8, sellWr:42.9, reduceWr:33.3, note:'Strong sell' },
  'FLOWUSDT': { buyWr:null, sellWr:23.8, reduceWr:37.5, note:'Bad buy' },
  'FLRUSD': { buyWr:20, sellWr:9.1, reduceWr:50, note:'Bad sell' },
  'FLUIDUSDT': { buyWr:58.3, sellWr:25, reduceWr:100, note:'Strong sell' },
  'FOGOUSDT': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'FOLKSUSDT.P': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'FORMUSDT': { buyWr:22.2, sellWr:0, reduceWr:100, note:null },
  'FORTHUSD': { buyWr:27.3, sellWr:16.7, reduceWr:50, note:null },
  'FUNUSDT': { buyWr:27.8, sellWr:null, reduceWr:28.6, note:'Never short' },
  'FUSDT.P': { buyWr:60, sellWr:0, reduceWr:0, note:'Strong buy' },
  'GALAUSDT': { buyWr:31.7, sellWr:23.8, reduceWr:30.8, note:null },
  'GASUSDT': { buyWr:34.6, sellWr:33.3, reduceWr:50, note:null },
  'GHSTUSD': { buyWr:25, sellWr:22.2, reduceWr:40, note:null },
  'GIGGLEUSDT': { buyWr:40, sellWr:100, reduceWr:50, note:'Strong both' },
  'GLMUSDT': { buyWr:29.8, sellWr:18.2, reduceWr:75, note:null },
  'GMTUSDT': { buyWr:24.3, sellWr:30.8, reduceWr:50, note:null },
  'GMXUSDT': { buyWr:30.8, sellWr:33.3, reduceWr:23.1, note:null },
  'GOATUSDT.P': { buyWr:26.7, sellWr:33.3, reduceWr:75, note:'Strong sell' },
  'GPSUSDT': { buyWr:41.2, sellWr:30, reduceWr:0, note:null },
  'GRASSUSDT.P': { buyWr:null, sellWr:0, reduceWr:50, note:'Bad buy' },
  'GRIFFAINUSDT.P': { buyWr:21.1, sellWr:33.3, reduceWr:50, note:null },
  'GRTUSDT': { buyWr:42.9, sellWr:39.1, reduceWr:50, note:'Strong both' },
  'GTCUSDT.P': { buyWr:null, sellWr:18.5, reduceWr:44.4, note:'Bad buy' },
  'GTUSDT.P': { buyWr:null, sellWr:0, reduceWr:50, note:'Flagged' },
  'GUAUSDT': { buyWr:null, sellWr:null, reduceWr:null, note:'Never short' },
  'GUNUSDT': { buyWr:36.4, sellWr:null, reduceWr:0, note:'Never short' },
  'GUSDT.P': { buyWr:33.3, sellWr:0, reduceWr:100, note:null },
  'GWEIUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'HAEDALUSDC': { buyWr:40, sellWr:0, reduceWr:100, note:null },
  'HANAUSDT.P': { buyWr:20, sellWr:null, reduceWr:null, note:null },
  'HBARUSDT': { buyWr:40.5, sellWr:60, reduceWr:56.3, note:null },
  'HEIUSDT': { buyWr:25, sellWr:100, reduceWr:null, note:null },
  'HEMIUSDT.P': { buyWr:33.3, sellWr:100, reduceWr:100, note:null },
  'HFTUSDT.P': { buyWr:46.2, sellWr:61.5, reduceWr:60, note:null },
  'HIGHUSDT': { buyWr:45.9, sellWr:39.1, reduceWr:25, note:null },
  'HIPPOUSDT.P': { buyWr:50, sellWr:71.4, reduceWr:75, note:null },
  'HIVEUSDT': { buyWr:58.1, sellWr:31.8, reduceWr:33.3, note:null },
  'HMSTRUSDC.P': { buyWr:25, sellWr:50, reduceWr:0, note:null },
  'HOLOUSDT': { buyWr:50, sellWr:100, reduceWr:100, note:null },
  'HOMEUSD': { buyWr:50, sellWr:20, reduceWr:100, note:null },
  'HOOKUSDT.P': { buyWr:44, sellWr:69.2, reduceWr:50, note:null },
  'HOTUSDT': { buyWr:37.7, sellWr:44, reduceWr:41.7, note:null },
  'HUMAUSDT': { buyWr:28.6, sellWr:40, reduceWr:66.7, note:null },
  'HUSD': { buyWr:50, sellWr:0, reduceWr:0, note:null },
  'HYPERUSDC': { buyWr:0, sellWr:100, reduceWr:null, note:null },
  'HYPEUSDT.P': { buyWr:66.7, sellWr:100, reduceWr:100, note:null },
  'ICNTUSDT.P': { buyWr:88.9, sellWr:100, reduceWr:null, note:'Strong buy' },
  'ICPUSDT': { buyWr:26.5, sellWr:52, reduceWr:75, note:'Bad buy' },
  'ICXUSDT': { buyWr:44.4, sellWr:44.4, reduceWr:100, note:null },
  'IDOLUSDT.P': { buyWr:42.9, sellWr:100, reduceWr:null, note:null },
  'IDUSDT': { buyWr:39.1, sellWr:58.3, reduceWr:75, note:'Strong both' },
  'ILVUSDT.P': { buyWr:41.7, sellWr:72.7, reduceWr:62.5, note:'Strong both' },
  'INITUSD': { buyWr:42.9, sellWr:75, reduceWr:100, note:null },
  'INITUSDT': { buyWr:60, sellWr:50, reduceWr:100, note:null },
  'INJUSDT': { buyWr:54.5, sellWr:39.4, reduceWr:77.8, note:'Strong sell' },
  'INUSDT.P': { buyWr:50, sellWr:0, reduceWr:0, note:null },
  'INXUSDC.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'IOSTUSDT': { buyWr:42.6, sellWr:43.6, reduceWr:64.7, note:'Strong both' },
  'IOTAUSDT': { buyWr:36.4, sellWr:46.7, reduceWr:66.7, note:null },
  'IOTXUSDT.P': { buyWr:50, sellWr:55.6, reduceWr:45.5, note:'Strong both' },
  'IOUSDT.P': { buyWr:42.9, sellWr:58.3, reduceWr:71.4, note:'Strong sell' },
  'IPUSD': { buyWr:38.5, sellWr:75, reduceWr:100, note:null },
  'IRUSDT.P': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'IRYSUSDC': { buyWr:100, sellWr:0, reduceWr:null, note:null },
  'JASMYUSDT': { buyWr:45.7, sellWr:52.6, reduceWr:60, note:null },
  'JCTUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'JELLYJELLYUSDT.P': { buyWr:50, sellWr:null, reduceWr:0, note:'Never short' },
  'JOEUSDT': { buyWr:55, sellWr:44.4, reduceWr:50, note:'Strong buy' },
  'JSTUSDT': { buyWr:41.9, sellWr:42.9, reduceWr:40, note:null },
  'JTOUSDT': { buyWr:56, sellWr:60, reduceWr:40, note:'Strong both' },
  'JUPUSDT': { buyWr:40, sellWr:58.3, reduceWr:55.6, note:'Strong sell' },
  'KAIAUSDT': { buyWr:45.5, sellWr:null, reduceWr:100, note:'Never short' },
  'KAITOUSDT.P': { buyWr:44.4, sellWr:50, reduceWr:null, note:null },
  'KASUSDT': { buyWr:59, sellWr:63.6, reduceWr:83.3, note:'Strong both' },
  'KAVAUSDT': { buyWr:45.3, sellWr:52, reduceWr:54.5, note:null },
  'KERNELUSDT.P': { buyWr:37.5, sellWr:100, reduceWr:75, note:'Strong sell' },
  'KGENUSDT.P': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad both' },
  'KITEUSDT': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'KITEUSDT.P': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'KMNOUSDC': { buyWr:66.7, sellWr:66.7, reduceWr:0, note:'Strong buy' },
  'KNCUSD': { buyWr:50, sellWr:72, reduceWr:33.3, note:'Strong both' },
  'KOMAUSDT': { buyWr:33.3, sellWr:50, reduceWr:50, note:'Bad buy' },
  'KSMUSDT': { buyWr:50, sellWr:50, reduceWr:60, note:null },
  'LABUSDT.P': { buyWr:33.3, sellWr:0, reduceWr:null, note:null },
  'LAUSD': { buyWr:33.3, sellWr:50, reduceWr:0, note:null },
  'LAYERUSD': { buyWr:33.3, sellWr:null, reduceWr:null, note:null },
  'LDOUSD': { buyWr:63.3, sellWr:58.3, reduceWr:100, note:'Strong both' },
  'LIGHTUSDT.P': { buyWr:100, sellWr:null, reduceWr:null, note:null },
  'LINEAUSDT': { buyWr:57.1, sellWr:0, reduceWr:100, note:null },
  'LINKUSDT': { buyWr:63.5, sellWr:56.3, reduceWr:91.7, note:'Strong both' },
  'LISTAUSDT': { buyWr:41.7, sellWr:75, reduceWr:100, note:null },
  'LITUSDT': { buyWr:50, sellWr:null, reduceWr:null, note:null },
  'LPTUSDT': { buyWr:43.9, sellWr:58.8, reduceWr:66.7, note:null },
  'LQTYUSDT': { buyWr:65, sellWr:53.8, reduceWr:100, note:'Strong sell' },
  'LRCUSDC': { buyWr:39.1, sellWr:54.2, reduceWr:50, note:null },
  'LSKUSDT.P': { buyWr:39.1, sellWr:66.7, reduceWr:100, note:null },
  'LTCUSDT.P': { buyWr:63, sellWr:43.5, reduceWr:33.3, note:'Strong buy' },
  'LUMIAUSDT': { buyWr:40, sellWr:100, reduceWr:100, note:null },
  'LUNA2USD': { buyWr:43.8, sellWr:33.3, reduceWr:75, note:'Bad sell' },
  'LUNAUSDT': { buyWr:44.7, sellWr:43.8, reduceWr:100, note:null },
  'LUNCUSDT': { buyWr:47.6, sellWr:50, reduceWr:100, note:null },
  'LYNUSDT': { buyWr:100, sellWr:50, reduceWr:0, note:null },
  'MAGICUSDT': { buyWr:48.5, sellWr:50, reduceWr:75, note:null },
  'MAGMAUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'MANAUSDT': { buyWr:39, sellWr:68, reduceWr:71.4, note:null },
  'MANTAUSDT': { buyWr:25.9, sellWr:75, reduceWr:100, note:'Bad buy' },
  'MASKUSDT': { buyWr:53.3, sellWr:55.6, reduceWr:33.3, note:null },
  'MAVIAUSDT.P': { buyWr:42.1, sellWr:28.6, reduceWr:66.7, note:null },
  'MAVUSDT': { buyWr:59.3, sellWr:50, reduceWr:40, note:null },
  'MEGAUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'MELANIAUSDT.P': { buyWr:71.4, sellWr:40, reduceWr:100, note:null },
  'MEMEUSDT': { buyWr:54.2, sellWr:36.4, reduceWr:100, note:null },
  'MERLUSDT.P': { buyWr:50, sellWr:100, reduceWr:100, note:null },
  'METISUSDC': { buyWr:46.7, sellWr:77.8, reduceWr:90, note:'Strong sell' },
  'METUSD': { buyWr:100, sellWr:100, reduceWr:0, note:null },
  'MEUSDT': { buyWr:null, sellWr:100, reduceWr:100, note:'Bad buy' },
  'MEWUSDT': { buyWr:54.5, sellWr:75, reduceWr:50, note:null },
  'MINAUSD': { buyWr:56.4, sellWr:55, reduceWr:60, note:'Strong buy' },
  'MIRAUSDT': { buyWr:40, sellWr:0, reduceWr:null, note:null },
  'MITOUSDT': { buyWr:null, sellWr:100, reduceWr:100, note:'Bad buy' },
  'MLNUSDT.P': { buyWr:40, sellWr:100, reduceWr:0, note:null },
  'MMTUSDT.P': { buyWr:66.7, sellWr:0, reduceWr:null, note:null },
  'MOCAUSDT': { buyWr:null, sellWr:81.8, reduceWr:50, note:'Bad buy' },
  'MOGUSDT': { buyWr:59.1, sellWr:57.1, reduceWr:25, note:null },
  'MONUSD': { buyWr:50, sellWr:null, reduceWr:null, note:null },
  'MOODENGUSDT.P': { buyWr:60, sellWr:44.4, reduceWr:50, note:null },
  'MORPHOUSDT': { buyWr:73.3, sellWr:100, reduceWr:60, note:'Strong both' },
  'MOVEUSD': { buyWr:70, sellWr:100, reduceWr:50, note:'Strong both' },
  'MOVRUSDT': { buyWr:37.8, sellWr:70, reduceWr:85.7, note:null },
  'MTLUSDT.P': { buyWr:59.1, sellWr:75, reduceWr:66.7, note:'Strong both' },
  'MUBARAKUSDT': { buyWr:70, sellWr:0, reduceWr:0, note:'Strong buy' },
  'MUSDT': { buyWr:50, sellWr:null, reduceWr:0, note:'Never short' },
  'MYXUSDT.P': { buyWr:100, sellWr:null, reduceWr:null, note:'Never short' },
  'NAORISUSDT.P': { buyWr:0, sellWr:null, reduceWr:100, note:'Never short' },
  'NEARUSDT': { buyWr:41.7, sellWr:64.1, reduceWr:64.7, note:null },
  'NEOUSD': { buyWr:45.2, sellWr:56, reduceWr:80, note:null },
  'NEWTUSD': { buyWr:33.3, sellWr:100, reduceWr:100, note:null },
  'NEXOUSDT': { buyWr:40, sellWr:50, reduceWr:66.7, note:null },
  'NFPUSDT': { buyWr:33.3, sellWr:70, reduceWr:100, note:'Strong sell' },
  'NIGHTUSD': { buyWr:0, sellWr:null, reduceWr:null, note:'Too few signals' },
  'NILUSDC.P': { buyWr:80, sellWr:80, reduceWr:100, note:'Strong both' },
  'NMRUSDC': { buyWr:100, sellWr:100, reduceWr:null, note:'Strong both' },
  'NOMUSDT': { buyWr:66.7, sellWr:null, reduceWr:null, note:null },
  'NOTUSDT': { buyWr:52.6, sellWr:80, reduceWr:100, note:'Strong both' },
  'NTRNUSD': { buyWr:40, sellWr:100, reduceWr:100, note:'Strong sell' },
  'NXPCUSDC': { buyWr:null, sellWr:100, reduceWr:50, note:'Bad buy' },
  'OGNUSD': { buyWr:63.3, sellWr:62.5, reduceWr:100, note:'Strong both' },
  'OGUSDT.P': { buyWr:50, sellWr:100, reduceWr:50, note:null },
  'OKBUSDT': { buyWr:51.1, sellWr:35.3, reduceWr:55.6, note:'Bad sell' },
  'OLUSDT.P': { buyWr:60, sellWr:100, reduceWr:100, note:null },
  'OMUSDT': { buyWr:42.5, sellWr:70, reduceWr:57.1, note:null },
  'ONDOUSDT': { buyWr:36, sellWr:76.9, reduceWr:100, note:'Strong sell' },
  'ONEUSDT': { buyWr:38.5, sellWr:54.1, reduceWr:76.9, note:null },
  'ONGUSDT.P': { buyWr:47.4, sellWr:66.7, reduceWr:0, note:null },
  'ONTUSDT': { buyWr:46.6, sellWr:48.6, reduceWr:53.8, note:null },
  'ONUSDT.P': { buyWr:33.3, sellWr:null, reduceWr:null, note:null },
  'OPENUSD': { buyWr:66.7, sellWr:50, reduceWr:100, note:null },
  'OPUSDT': { buyWr:40, sellWr:61.5, reduceWr:80, note:null },
  'ORCAUSDT': { buyWr:35.7, sellWr:75, reduceWr:100, note:null },
  'ORDERUSD': { buyWr:66.7, sellWr:50, reduceWr:100, note:null },
  'ORDIUSDT': { buyWr:50, sellWr:54.5, reduceWr:85.7, note:'Strong sell' },
  'OREUSDT': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'OXTUSDT.P': { buyWr:52.9, sellWr:85.7, reduceWr:100, note:'Strong both' },
  'PARTIUSD': { buyWr:66.7, sellWr:66.7, reduceWr:50, note:null },
  'PENDLEUSDT': { buyWr:51.4, sellWr:33.3, reduceWr:100, note:null },
  'PENGUINUSDT': { buyWr:0, sellWr:null, reduceWr:null, note:'Too few signals' },
  'PENGUUSDT': { buyWr:null, sellWr:66.7, reduceWr:66.7, note:'Bad buy' },
  'PEOPLEUSDT': { buyWr:45.7, sellWr:48, reduceWr:60, note:null },
  'PEPEUSDT': { buyWr:44, sellWr:66.7, reduceWr:72.7, note:'Strong sell' },
  'PHBUSDT': { buyWr:42.4, sellWr:42.9, reduceWr:33.3, note:null },
  'PIEVERSEUSDT.P': { buyWr:100, sellWr:66.7, reduceWr:0, note:null },
  'PIPPINUSDT.P': { buyWr:50, sellWr:100, reduceWr:100, note:null },
  'PIUSDT': { buyWr:62.5, sellWr:100, reduceWr:0, note:'Strong both' },
  'PIXELUSDT': { buyWr:38.5, sellWr:100, reduceWr:100, note:'Strong sell' },
  'PLUMEUSDT': { buyWr:40, sellWr:100, reduceWr:100, note:null },
  'PNUTUSDT': { buyWr:30.8, sellWr:25, reduceWr:100, note:'Bad both' },
  'POLUSDT': { buyWr:36.4, sellWr:100, reduceWr:100, note:'Strong sell' },
  'POLYXUSDT': { buyWr:41.9, sellWr:77.8, reduceWr:25, note:null },
  'PORTALUSDT': { buyWr:29, sellWr:71.4, reduceWr:75, note:'Bad buy' },
  'POWERUSDT': { buyWr:50, sellWr:100, reduceWr:0, note:null },
  'POWRUSD': { buyWr:68.2, sellWr:60, reduceWr:80, note:'Strong both' },
  'PROMPTUSDT.P': { buyWr:72.7, sellWr:100, reduceWr:66.7, note:'Strong both' },
  'PROMUSDT': { buyWr:69.2, sellWr:25, reduceWr:33.3, note:null },
  'PROVEUSDT': { buyWr:33.3, sellWr:0, reduceWr:0, note:null },
  'PTBUSDT.P': { buyWr:62.5, sellWr:100, reduceWr:100, note:null },
  'PUFFERUSD': { buyWr:null, sellWr:50, reduceWr:33.3, note:'Bad buy' },
  'PUMPBTCUSDT.P': { buyWr:55.6, sellWr:50, reduceWr:100, note:null },
  'PUMPUSDT.P': { buyWr:50, sellWr:50, reduceWr:66.7, note:null },
  'PUNDIXUSDT': { buyWr:55.9, sellWr:33.3, reduceWr:66.7, note:'Strong buy' },
  'PYTHUSDT': { buyWr:44, sellWr:60, reduceWr:100, note:null },
  'QNTUSDT': { buyWr:50, sellWr:40, reduceWr:50, note:null },
  'QTUMUSDT': { buyWr:39.1, sellWr:42.9, reduceWr:64.7, note:null },
  'QUSD': { buyWr:50, sellWr:null, reduceWr:null, note:'Never short' },
  'RATSUSDT': { buyWr:65.2, sellWr:36.4, reduceWr:71.4, note:null },
  'RAYUSDT': { buyWr:55.1, sellWr:40.9, reduceWr:75, note:null },
  'RDNTUSDT.P': { buyWr:51.6, sellWr:80, reduceWr:75, note:'Strong sell' },
  'RECALLUSDT.P': { buyWr:42.9, sellWr:null, reduceWr:null, note:null },
  'REDUSDT': { buyWr:60, sellWr:100, reduceWr:100, note:null },
  'RENDERUSDT': { buyWr:48, sellWr:70, reduceWr:75, note:'Strong sell' },
  'RESOLVUSDT.P': { buyWr:80, sellWr:100, reduceWr:null, note:null },
  'REZUSDC': { buyWr:null, sellWr:100, reduceWr:0, note:'Bad buy' },
  'RIFUSDT': { buyWr:44.4, sellWr:44.4, reduceWr:50, note:null },
  'RIVERUSDT.P': { buyWr:0, sellWr:null, reduceWr:100, note:'Never short' },
  'RLCUSD': { buyWr:57.9, sellWr:55.6, reduceWr:100, note:'Strong sell' },
  'RLSUSD': { buyWr:0, sellWr:100, reduceWr:null, note:null },
  'ROSEUSDT': { buyWr:27.8, sellWr:44, reduceWr:83.3, note:'Bad buy' },
  'RPLUSDT': { buyWr:32.4, sellWr:75, reduceWr:57.1, note:null },
  'RSCUSD': { buyWr:50, sellWr:66.7, reduceWr:100, note:null },
  'RSRUSDT': { buyWr:58.9, sellWr:57.1, reduceWr:73.3, note:'Strong both' },
  'RUNEUSDT': { buyWr:43.3, sellWr:66.7, reduceWr:81.3, note:'Strong sell' },
  'RVNUSDT': { buyWr:40.8, sellWr:41.7, reduceWr:60, note:null },
  'RVVUSDT': { buyWr:66.7, sellWr:100, reduceWr:0, note:null },
  'SAFEUSD': { buyWr:57.1, sellWr:57.1, reduceWr:50, note:null },
  'SAGAUSDT.P': { buyWr:35.7, sellWr:83.3, reduceWr:100, note:null },
  'SAHARAUSDT': { buyWr:50, sellWr:100, reduceWr:100, note:null },
  'SANDUSDT': { buyWr:36.8, sellWr:75, reduceWr:66.7, note:'Strong sell' },
  'SAPIENUSDC': { buyWr:66.7, sellWr:100, reduceWr:100, note:null },
  'SCRUSDT': { buyWr:null, sellWr:66.7, reduceWr:0, note:'Bad buy' },
  'SEIUSDT': { buyWr:36.7, sellWr:60, reduceWr:66.7, note:null },
  'SENTUSD': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'SFPUSDT': { buyWr:41.5, sellWr:36.4, reduceWr:80, note:null },
  'SHELLUSDT': { buyWr:50, sellWr:25, reduceWr:100, note:null },
  'SHIBUSD': { buyWr:56.7, sellWr:59.1, reduceWr:90, note:'Strong both' },
  'SIGNBNB': { buyWr:66.7, sellWr:0, reduceWr:0, note:null },
  'SIRENUSDT.P': { buyWr:83.3, sellWr:100, reduceWr:50, note:'Strong both' },
  'SKLUSDC': { buyWr:80, sellWr:null, reduceWr:null, note:null },
  'SKRUSD': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'SKYAIUSDT.P': { buyWr:55.6, sellWr:100, reduceWr:100, note:null },
  'SKYUSDT': { buyWr:100, sellWr:100, reduceWr:0, note:null },
  'SLPUSDT': { buyWr:43.2, sellWr:58.8, reduceWr:87.5, note:null },
  'SNXUSDT': { buyWr:45, sellWr:55.6, reduceWr:33.3, note:null },
  'SOLUSD': { buyWr:55.6, sellWr:38.9, reduceWr:71.4, note:null },
  'SOLVUSDC': { buyWr:0, sellWr:100, reduceWr:100, note:null },
  'SOMIUSDT': { buyWr:33.3, sellWr:0, reduceWr:100, note:null },
  'SONICUSDT.P': { buyWr:57.1, sellWr:66.7, reduceWr:66.7, note:null },
  'SOONUSD': { buyWr:25, sellWr:0, reduceWr:null, note:null },
  'SOPHUSDT': { buyWr:83.3, sellWr:50, reduceWr:50, note:null },
  'SPACEUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'SPELLUSDC': { buyWr:50, sellWr:66.7, reduceWr:50, note:null },
  'SPKUSDT': { buyWr:37.5, sellWr:100, reduceWr:100, note:null },
  'SPORTFUNUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'SPXUSDT': { buyWr:69.6, sellWr:44.4, reduceWr:75, note:'Strong sell' },
  'SQDUSDT.P': { buyWr:null, sellWr:50, reduceWr:100, note:'Bad buy' },
  'SSVUSDT': { buyWr:60, sellWr:46.7, reduceWr:75, note:null },
  'STABLEUSDT': { buyWr:100, sellWr:100, reduceWr:null, note:null },
  'STBLUSDT.P': { buyWr:75, sellWr:0, reduceWr:100, note:null },
  'STEEMUSDT': { buyWr:54.8, sellWr:88.9, reduceWr:80, note:'Strong both' },
  'STGUSDT': { buyWr:50, sellWr:78.6, reduceWr:60, note:'Strong both' },
  'STORJUSDT': { buyWr:35.4, sellWr:35.3, reduceWr:77.8, note:null },
  'STOUSDT': { buyWr:20, sellWr:100, reduceWr:100, note:null },
  'STRKUSDT': { buyWr:40.7, sellWr:100, reduceWr:100, note:'Strong sell' },
  'STXUSDT': { buyWr:48, sellWr:63.3, reduceWr:81.3, note:'Strong sell' },
  'SUIUSDT': { buyWr:39.1, sellWr:37.5, reduceWr:66.7, note:null },
  'SUNUSDT': { buyWr:41.9, sellWr:69.2, reduceWr:50, note:null },
  'SUPERUSD': { buyWr:57.5, sellWr:54.5, reduceWr:100, note:'Strong both' },
  'SUSDT': { buyWr:41.7, sellWr:60, reduceWr:100, note:null },
  'SUSHIUSDT': { buyWr:46.2, sellWr:53.3, reduceWr:55.6, note:null },
  'SWARMSUSDT.P': { buyWr:33.3, sellWr:100, reduceWr:50, note:null },
  'SXTUSDT': { buyWr:50, sellWr:100, reduceWr:100, note:null },
  'SYNUSDT.P': { buyWr:81, sellWr:null, reduceWr:null, note:'Never short / Strong buy' },
  'SYRUPUSDT': { buyWr:71.4, sellWr:100, reduceWr:100, note:null },
  'TACUSDT.P': { buyWr:83.3, sellWr:null, reduceWr:null, note:null },
  'TAGUSDT.P': { buyWr:25, sellWr:100, reduceWr:100, note:null },
  'TAIKOUSDT.P': { buyWr:37.5, sellWr:50, reduceWr:0, note:null },
  'TAKEUSDT': { buyWr:0, sellWr:0, reduceWr:0, note:null },
  'TAOUSDT': { buyWr:45, sellWr:80, reduceWr:66.7, note:'Strong sell' },
  'TAUSDT.P': { buyWr:37.5, sellWr:null, reduceWr:null, note:'Never short' },
  'THETAUSDT': { buyWr:39.2, sellWr:44.7, reduceWr:80, note:null },
  'THEUSDT': { buyWr:66.7, sellWr:66.7, reduceWr:100, note:'Strong both' },
  'TIAUSD': { buyWr:46.7, sellWr:50, reduceWr:100, note:null },
  'TLMUSDT.P': { buyWr:38.7, sellWr:43.8, reduceWr:75, note:null },
  'TNSRUSDT': { buyWr:34.8, sellWr:33.3, reduceWr:75, note:null },
  'TONUSDT': { buyWr:50, sellWr:50, reduceWr:100, note:null },
  'TOSHIUSD': { buyWr:50, sellWr:60, reduceWr:75, note:null },
  'TOWNSUSDC': { buyWr:40, sellWr:0, reduceWr:100, note:null },
  'TRADOORUSDT.P': { buyWr:50, sellWr:0, reduceWr:0, note:null },
  'TRBUSDT': { buyWr:49, sellWr:53.8, reduceWr:69.2, note:null },
  'TREEUSDC': { buyWr:80, sellWr:100, reduceWr:100, note:null },
  'TRIAUSD': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'TRUMPUSDT': { buyWr:44.4, sellWr:75, reduceWr:100, note:'Strong sell' },
  'TRUSTUSD': { buyWr:20, sellWr:null, reduceWr:null, note:null },
  'TRUTHUSDT.P': { buyWr:null, sellWr:100, reduceWr:null, note:null },
  'TRUUSDT.P': { buyWr:68.8, sellWr:57.1, reduceWr:83.3, note:'Strong both' },
  'TRXUSDT': { buyWr:43.3, sellWr:81.1, reduceWr:53.8, note:'Strong sell' },
  'TSTUSDT': { buyWr:62.5, sellWr:null, reduceWr:0, note:'Never short' },
  'TURBOUSDC': { buyWr:53.3, sellWr:50, reduceWr:100, note:null },
  'TURTLEUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:'Bad buy' },
  'TUSDT': { buyWr:43.5, sellWr:72.7, reduceWr:80, note:'Strong sell' },
  'TUTUSDC': { buyWr:40, sellWr:0, reduceWr:null, note:null },
  'TWTUSDT': { buyWr:41.9, sellWr:66.7, reduceWr:100, note:'Strong sell' },
  'UAIUSDT.P': { buyWr:50, sellWr:null, reduceWr:null, note:null },
  'UBUSDT.P': { buyWr:66.7, sellWr:null, reduceWr:null, note:null },
  'UMAUSD': { buyWr:51, sellWr:65.4, reduceWr:46.2, note:null },
  'UNIUSDT': { buyWr:50, sellWr:56, reduceWr:75, note:'Strong both' },
  'USELESSUSDT': { buyWr:40, sellWr:100, reduceWr:null, note:null },
  'USTCUSDT.P': { buyWr:61.1, sellWr:100, reduceWr:100, note:'Strong sell' },
  'USUALUSDT': { buyWr:52.6, sellWr:83.3, reduceWr:100, note:'Strong sell' },
  'USUSD': { buyWr:null, sellWr:100, reduceWr:100, note:null },
  'VANAUSDC': { buyWr:null, sellWr:0, reduceWr:0, note:'Bad buy' },
  'VANRYUSDT': { buyWr:50, sellWr:70, reduceWr:100, note:'Strong sell' },
  'VELOUSDC': { buyWr:50, sellWr:60, reduceWr:100, note:null },
  'VELVETUSDT.P': { buyWr:33.3, sellWr:null, reduceWr:0, note:'Never short' },
  'VETUSDT': { buyWr:33.3, sellWr:56.8, reduceWr:70.6, note:'Bad buy' },
  'VFYUSDT.P': { buyWr:40, sellWr:100, reduceWr:100, note:null },
  'VICUSDT.P': { buyWr:62.5, sellWr:100, reduceWr:100, note:'Strong both' },
  'VINEUSD': { buyWr:53.3, sellWr:null, reduceWr:100, note:'Never short' },
  'VIRTUALUSDT': { buyWr:44.4, sellWr:100, reduceWr:100, note:'Strong sell' },
  'VTHOUSDT': { buyWr:44.1, sellWr:33.3, reduceWr:60, note:'Bad sell' },
  'VVVUSD': { buyWr:36.4, sellWr:57.1, reduceWr:66.7, note:'Bad buy' },
  'WALUSDT': { buyWr:null, sellWr:0, reduceWr:null, note:'Bad both' },
  'WAXPUSDT.P': { buyWr:26.3, sellWr:100, reduceWr:40, note:'Bad buy / Strong both' },
  'WCTUSDC': { buyWr:50, sellWr:60, reduceWr:0, note:null },
  'WETUSDT.P': { buyWr:null, sellWr:100, reduceWr:null, note:'Bad buy' },
  'WIFUSDT': { buyWr:55, sellWr:66.7, reduceWr:80, note:'Strong both' },
  'WLDUSDT': { buyWr:43.8, sellWr:40, reduceWr:25, note:'Bad sell' },
  'WLFIUSDT': { buyWr:75, sellWr:0, reduceWr:0, note:null },
  'WOOUSDT': { buyWr:47.2, sellWr:57.9, reduceWr:40, note:null },
  'WUSDT': { buyWr:34.5, sellWr:30, reduceWr:100, note:'Bad both' },
  'XAIUSDT': { buyWr:42.3, sellWr:57.1, reduceWr:80, note:null },
  'XANUSD': { buyWr:null, sellWr:100, reduceWr:0, note:'Bad buy' },
  'XAUTUST': { buyWr:0, sellWr:100, reduceWr:0, note:'AVOID' },
  'XDCUSD': { buyWr:25, sellWr:40, reduceWr:0, note:'Bad overall' },
  'XLMUSDT': { buyWr:47.9, sellWr:53.6, reduceWr:16.7, note:null },
  'XNOUSDT': { buyWr:57.8, sellWr:55.6, reduceWr:50, note:'Strong both' },
  'XNYUSDT.P': { buyWr:85.7, sellWr:50, reduceWr:100, note:'Strong buy' },
  'XPINUSDT.P': { buyWr:null, sellWr:100, reduceWr:null, note:'Bad buy' },
  'XPLUSDT': { buyWr:57.1, sellWr:0, reduceWr:100, note:null },
  'XPTUSDT.P': { buyWr:null, sellWr:100, reduceWr:null, note:null },
  'XRPUSDT.P': { buyWr:41.9, sellWr:65.4, reduceWr:66.7, note:'Strong sell' },
  'XTZUSD': { buyWr:50, sellWr:62.5, reduceWr:72.7, note:'Strong both' },
  'XVSUSDT': { buyWr:51.9, sellWr:58.6, reduceWr:66.7, note:'Strong both' },
  'YALAUSDT': { buyWr:null, sellWr:null, reduceWr:0, note:'Never short' },
  'YBUSDT': { buyWr:40, sellWr:0, reduceWr:0, note:null },
  'YFIUSDT': { buyWr:42.4, sellWr:50, reduceWr:50, note:null },
  'YGGUSDT.P': { buyWr:44.2, sellWr:55.6, reduceWr:64.3, note:null },
  'ZAMAUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'ZBCNUSDT': { buyWr:69.6, sellWr:82.4, reduceWr:27.3, note:'Strong both' },
  'ZBTUSDT.P': { buyWr:100, sellWr:null, reduceWr:null, note:null },
  'ZENUSDT': { buyWr:49.1, sellWr:65.4, reduceWr:83.3, note:'Strong sell' },
  'ZEREBROUSDT.P': { buyWr:60, sellWr:50, reduceWr:100, note:null },
  'ZETAUSDT.P': { buyWr:30, sellWr:75, reduceWr:50, note:'Bad buy / Strong both' },
  'ZILUSDT': { buyWr:36.2, sellWr:58.8, reduceWr:66.7, note:'Bad buy' },
  'ZKCUSDT.P': { buyWr:42.9, sellWr:0, reduceWr:null, note:null },
  'ZKJUSDT.P': { buyWr:25, sellWr:0, reduceWr:null, note:'Bad buy' },
  'ZKPUSDT.P': { buyWr:0, sellWr:null, reduceWr:null, note:null },
  'ZKUSD': { buyWr:53.3, sellWr:66.7, reduceWr:75, note:'Strong both' },
  'ZORAUSD': { buyWr:50, sellWr:100, reduceWr:100, note:null },
  'ZROUSDT': { buyWr:58.8, sellWr:33.3, reduceWr:66.7, note:'Bad sell' },
  'ZRXUSD': { buyWr:54.8, sellWr:77.3, reduceWr:71.4, note:'Strong both' },
  'ZTCUSDT.P': { buyWr:null, sellWr:null, reduceWr:null, note:null },
  'DFUSDT': { buyWr:54.3, sellWr:55.6, reduceWr:100, note:'Strong both' }
};

    function getBacktest(ticker, signalType) {
        const t = ticker.toUpperCase();
        const entry = BACKTEST[t];
        if (!entry) return null;
        const st = signalType.toLowerCase();
        let wr, side;
        if (st.includes('reduce') || st.includes('add') || st.includes('double')) {
            side = 'sell'; wr = entry.reduceWr;
        } else if (st.includes('sell') || st.includes('short')) {
            side = 'sell'; wr = entry.sellWr;
        } else {
            side = 'buy'; wr = entry.buyWr;
        }
        if (wr === null) return null;
        const d = BT_DEFAULTS[side];
        return { sl: d.sl, tp: d.tp, halfTp: d.halfTp, wr: wr };
    }

    function recalcLevels(actionId) {
        const input = document.getElementById(actionId + '-entry');
        if (!input) return;
        const card = input.closest('.action-item');
        const levelsEl = card.querySelector('.bt-levels');
        if (!levelsEl) return;
        const p = parseFloat(input.value.replace(/,/g, ''));
        if (!p || p <= 0) return;
        const sl = parseFloat(levelsEl.dataset.sl);
        const tp = parseFloat(levelsEl.dataset.tp);
        const half = parseFloat(levelsEl.dataset.half);
        const isBuy = levelsEl.dataset.side === 'buy';
        const slP = isBuy ? p * (1 - sl / 100) : p * (1 + sl / 100);
        const tpP = isBuy ? p * (1 + tp / 100) : p * (1 - tp / 100);
        const halfP = isBuy ? p * (1 + half / 100) : p * (1 - half / 100);
        const fmt = v => v >= 100 ? v.toFixed(1) : v >= 1 ? v.toFixed(2) : v >= 0.01 ? v.toFixed(4) : v.toPrecision(4);
        levelsEl.querySelector('.bt-sl').textContent = fmt(slP);
        levelsEl.querySelector('.bt-tp').textContent = fmt(tpP);
        levelsEl.querySelector('.bt-half').textContent = fmt(halfP);
    }

    let refreshTimer = null;
    let allTickers = [];
    let allSignals = [];
    let showAllTickers = false;
    const TICKER_LIMIT = 50;

    // ====== PUSH NOTIFICATIONS ======
    const NOTIF_KEY = 'crypto_known_picks';
    function getKnownPicks() {
        try { return JSON.parse(localStorage.getItem(NOTIF_KEY) || '[]'); } catch { return []; }
    }
    function setKnownPicks(picks) {
        localStorage.setItem(NOTIF_KEY, JSON.stringify(picks));
    }
    function checkNewPicks(data) {
        if (Notification.permission !== 'granted') return;
        const picks = (data.claudePicks || []).concat(data.topPicks || []);
        const pickKeys = picks.map(p => (p.symbol || '') + '|' + (p.signal || ''));
        const known = getKnownPicks();
        const newOnes = pickKeys.filter(k => !known.includes(k));
        if (newOnes.length > 0 && known.length > 0) {
            newOnes.forEach(k => {
                const [sym, sig] = k.split('|');
                const pick = picks.find(p => (p.symbol || '') + '|' + (p.signal || '') === k);
                if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(reg => {
                        reg.showNotification('Trade Alert: ' + sym, {
                            body: (sig || '').toUpperCase() + ' | Score: ' + (pick ? pick.score : '?') + '/7',
                            icon: 'icon-192.png',
                            tag: k
                        });
                    });
                } else {
                    new Notification('Trade Alert: ' + sym, {
                        body: (sig || '').toUpperCase() + ' | Score: ' + (pick ? pick.score : '?') + '/7',
                        icon: 'icon-192.png',
                        tag: k
                    });
                }
            });
        }
        setKnownPicks(pickKeys);
    }
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // ====== LOCAL SKIP TRACKING ======
    const ACTED_KEY = 'crypto_acted_items';
    function getActedItems() {
        try { return JSON.parse(localStorage.getItem(ACTED_KEY) || '[]'); } catch { return []; }
    }
    function addActedItem(ticker, signal) {
        const items = getActedItems().filter(i => Date.now() - i.ts < 86400000); // keep 24hr
        items.push({ t: ticker.toUpperCase(), s: signal.toLowerCase(), ts: Date.now() });
        localStorage.setItem(ACTED_KEY, JSON.stringify(items));
    }
    function isActed(ticker, signal) {
        return getActedItems().some(i => i.t === ticker.toUpperCase() && i.s === signal.toLowerCase());
    }

    // ====== WEEKLY TASKS ======
    let _weeklyTasks = [];
    function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff);
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    const WEEKLY_TASKS_KEY_PREFIX = 'weekly_todos_';
    function getWeeklyTaskKey() { return WEEKLY_TASKS_KEY_PREFIX + getMonday(new Date()); }
    function getCheckedTasks() {
        try { return JSON.parse(localStorage.getItem(getWeeklyTaskKey()) || '[]'); } catch { return []; }
    }
    function setCheckedTasks(checked) {
        localStorage.setItem(getWeeklyTaskKey(), JSON.stringify(checked));
    }

    async function fetchWeeklyTasks() {
        try {
            const resp = await fetch(POST_URL + '?action=tasks');
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data.tasks || data.tasks.length === 0) {
                document.getElementById('weeklyTasks').style.display = 'none';
                return;
            }
            _weeklyTasks = data.tasks;
            renderWeeklyTasks();
        } catch (e) { /* tasks are non-critical */ }
    }

    function renderWeeklyTasks() {
        const tasks = _weeklyTasks;
        if (!tasks || tasks.length === 0) return;
        const container = document.getElementById('weeklyTasks');
        const list = document.getElementById('weeklyTasksList');
        const countEl = document.getElementById('weeklyTasksCount');
        const checked = getCheckedTasks();

        if (checked.length >= tasks.length && tasks.every((_, i) => checked.includes(i))) {
            container.style.display = 'none';
            return;
        }

        list.innerHTML = '';
        let doneCount = 0;
        tasks.forEach((text, idx) => {
            const isDone = checked.includes(idx);
            if (isDone) doneCount++;
            const item = document.createElement('div');
            item.className = 'weekly-task-item' + (isDone ? ' checked' : '');
            item.innerHTML = '<div class="weekly-task-checkbox"></div><div class="task-text">' + text + '</div>';
            item.addEventListener('click', () => {
                const c = getCheckedTasks();
                const pos = c.indexOf(idx);
                if (pos === -1) c.push(idx); else c.splice(pos, 1);
                setCheckedTasks(c);
                renderWeeklyTasks();
            });
            list.appendChild(item);
        });
        countEl.textContent = doneCount + '/' + tasks.length;
        container.style.display = '';
    }

    // ====== SCORING LOGIC ======
    function scoreSignal(s) {
        let score = 0;
        if (s.macd === 'rising' || s.macd === 'falling') score += 2;
        if (Number(s.cross) >= 0 && Number(s.cross) <= 5) score += 2;
        if (s.in_zone === true || s.in_zone === 'true') score += 1;
        if (s.volume === 'above') score += 1;
        return score;
    }

    function getScoreClass(score) {
        if (score >= 5) return 'high';
        if (score >= 3) return 'mid';
        return 'low';
    }

    // ====== FETCH DATA ======
    async function fetchData() {
        const dot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        dot.className = 'status-dot loading';
        statusText.textContent = 'Fetching...';

        try {
            const resp = await fetch(API_URL);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            if (data.status !== 'ok') throw new Error(data.message || 'Bad response');

            renderDashboard(data);
            checkNewPicks(data);

            dot.className = 'status-dot';
            statusText.textContent = 'Live';
            document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
            document.getElementById('errorBanner').className = 'error-banner';
            document.getElementById('loading').className = 'loading-overlay hidden';
        } catch (err) {
            renderDashboard(EMPTY_DATA);
            dot.className = 'status-dot';
            statusText.textContent = 'Error';
            document.getElementById('lastUpdate').textContent = 'No data';
            const banner = document.getElementById('errorBanner');
            banner.textContent = 'Fetch failed: ' + err.message;
            banner.className = 'error-banner show';
            document.getElementById('loading').className = 'loading-overlay hidden';
        }

        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(fetchData, REFRESH_INTERVAL);
    }

    // ====== RENDER ======
    function renderDashboard(data) {
        const { tickers, recentSignals, actionNeeded, stats, claudePicks } = data;

        // Sync pokeball state from API â†’ localStorage cache
        if (data.pokeballUsed) {
            localStorage.setItem('pokeball_used', JSON.stringify(data.pokeballUsed));
        }

        // Sync DCA state from API
        if (data.dcaMode !== undefined) {
            dcaMode = data.dcaMode;
            localStorage.setItem('dca_mode', dcaMode ? 'true' : 'false');
        }
        if (data.dcaTotal !== undefined && data.dcaTotal > 0) {
            dcaTotal = data.dcaTotal;
            localStorage.setItem('dca_total', dcaTotal.toString());
        }
        updateDCAControls();

        // Score all signals
        const scoredSignals = (recentSignals || []).map(s => {
            s._score = Math.max(scoreSignal(s), s.score || 0);
            return s;
        });
        allSignals = scoredSignals;

        // --- Quick Stats ---
        document.getElementById('statOpen').textContent = stats.openPositions || 0;

        const wrEl = document.getElementById('statWinRate');
        wrEl.textContent = stats.winRate || '0%';
        wrEl.className = 'stat-value' + (parseFloat(stats.winRate) >= 50 ? ' green' : parseFloat(stats.winRate) > 0 ? ' red' : '');

        document.getElementById('statTotal').textContent = stats.totalTrades || 0;
        document.getElementById('statToday').textContent = stats.todaySignals || 0;

        const pnlEl = document.getElementById('statPnL');
        const pnl = parseFloat(stats.netPnl) || 0;
        pnlEl.textContent = typeof pnl === 'number' ? (pnl >= 0 ? '+$' + pnl : '-$' + Math.abs(pnl)) : pnl;
        pnlEl.className = 'stat-value' + (typeof pnl === 'number' && pnl > 0 ? ' green' : typeof pnl === 'number' && pnl < 0 ? ' red' : '');

        // Won/Lost now rendered in perfGrid via renderPerformance()

        // --- Top Picks (Claude's recommendations) ---
        renderTopPicks(claudePicks || [], scoredSignals, actionNeeded || []);

        // --- Split actions: new signals vs open trades ---
        const allActions = actionNeeded || [];
        const newSignals = allActions.filter(a => a.type === 'mark_action');
        const openTrades = allActions.filter(a => a.type === 'mark_outcome');
        renderActions(newSignals, scoredSignals);
        renderOpenTrades(openTrades);

        // --- Ticker Grid (sorted by most recent signal first) ---
        // Sort tickers by most recent signal (use lastSignalTime from API, fall back to signals data)
        const latestByTicker = {};
        (scoredSignals || []).forEach((s, i) => {
            const sym = (s.symbol || s.ticker || '').toUpperCase();
            if (!sym) return;
            const t = s.timestamp ? new Date(s.timestamp).getTime() : 0;
            if (!latestByTicker[sym] || t > latestByTicker[sym]) {
                latestByTicker[sym] = t || (i + 1);
            }
        });
        allTickers = (tickers || []).slice().sort((a, b) => {
            const aKey = (a.ticker || '').toUpperCase();
            const bKey = (b.ticker || '').toUpperCase();
            const aTime = (a.lastSignalTime ? new Date(a.lastSignalTime).getTime() : 0) || latestByTicker[aKey] || 0;
            const bTime = (b.lastSignalTime ? new Date(b.lastSignalTime).getTime() : 0) || latestByTicker[bKey] || 0;
            return bTime - aTime;
        });
        renderTickerGrid();

        // --- All Signals Table ---
        renderSignalsTable(scoredSignals);

        // --- Performance Summary ---
        renderPerformance(stats);

        // --- Pokemon Trainer Level ---
        renderPokemon(stats);
    }

    // ====== TOP PICKS (Claude's Recommendations) ======
    function renderTopPicks(claudePicks, signals, actionNeeded) {
        const grid = document.getElementById('topPicksGrid');
        const countEl = document.getElementById('topPicksCount');

        // Build set of symbols still needing action (from Google Sheet)
        const pendingSet = new Set();
        (actionNeeded || []).filter(a => a.type === 'mark_action').forEach(a => {
            pendingSet.add((a.symbol || a.ticker || '').toUpperCase() + '|' + (a.signal || '').toLowerCase());
        });

        // Use Claude picks if available, otherwise fall back to auto-scored
        const hasClaude = claudePicks && claudePicks.length > 0;
        const allPicks = hasClaude ? claudePicks : signals.filter(s => (s.score || s._score) >= 5);
        const picks = allPicks.filter(s => {
            const sym = (s.symbol || s.ticker || '').toUpperCase();
            const sig = (s.signal || s.direction || '').toLowerCase();
            const key = sym + '|' + sig;
            // Hide if acted locally OR if not in pending actions from sheet
            return !isActed(sym, sig) && pendingSet.has(key);
        });
        countEl.textContent = picks.length;

        if (picks.length === 0) {
            grid.innerHTML = '<div class="no-picks">No top picks right now â€” waiting for high-score signals</div>';
            return;
        }

        grid.innerHTML = picks.map((s, i) => renderPickCard(s, i, false)).join('');
    }

    function signalLabel(s) {
        const u = s.toUpperCase();
        if (u === 'REDUCE') return 'DOUBLE TAP';
        return u;
    }

    function renderPickCard(s, i, isDemo) {
            const tkr = s.symbol || s.ticker || '';
            const prc = s.entry || s.price || 0;
            const sym = getCoinSymbol(tkr);
            const iconUrl = sym ? `https://assets.coincap.io/assets/icons/${sym}@2x.png` : '';
            const fallbackText = sym ? sym.slice(0,2).toUpperCase() : '?';
            const geckoFallback = sym ? `fetchCoinGeckoIcon('${esc(tkr)}',this,this.nextElementSibling)` : '';
            const onerrorAttr = `this.style.display='none';this.nextElementSibling.style.display='flex';${geckoFallback}`;
            const dir = (s.signal || s.direction || '').toLowerCase();
            const signalClass = dir === 'short' || dir === 'sell' || dir === 'reduce' ? 'sell' : 'buy';
            const score = s.score || s._score || 0;
            const analysis = s.analysis || '';
            const pickId = 'pick-' + i;

            // Backtest lookup
            const isBuy = signalClass === 'buy';
            const bt = getBacktest(tkr, dir || 'buy');
            const btEntry = BACKTEST[tkr.toUpperCase()];
            const btNote = btEntry ? btEntry.note : null;
            const p = Number(String(prc).replace(/,/g, ''));
            const noteHtml = btNote ? `<span style="color:#ffa726;font-weight:700">${esc(btNote)}</span>` : '';
            const wrHtml = bt ? `<span style="color:var(--accent);font-weight:700">WR ${bt.wr}%</span>` : '';
            const btSide = isBuy ? 'buy' : 'sell';
            const btDataAttr = bt ? `data-sl="${bt.sl}" data-tp="${bt.tp}" data-half="${bt.halfTp}" data-side="${btSide}"` : '';
            let btHtml = '';
            if (bt && p > 0) {
                const slPrice = isBuy ? p * (1 - bt.sl / 100) : p * (1 + bt.sl / 100);
                const tpPrice = isBuy ? p * (1 + bt.tp / 100) : p * (1 - bt.tp / 100);
                const halfPrice = isBuy ? p * (1 + bt.halfTp / 100) : p * (1 - bt.halfTp / 100);
                const fmt = v => v >= 100 ? v.toFixed(1) : v >= 1 ? v.toFixed(2) : v >= 0.01 ? v.toFixed(4) : v.toPrecision(4);
                btHtml = `<div class="meta" style="margin-top:0.2rem"><span class="bt-levels" ${btDataAttr}><span style="color:var(--red-bright)">SL <span class="bt-sl tap-copy" onclick="copyVal(this)">${fmt(slPrice)}</span> <span style="opacity:0.6;font-size:0.55rem">(${bt.sl}%)</span></span> &middot; <span style="color:var(--green-bright)">TP <span class="bt-tp tap-copy" onclick="copyVal(this)">${fmt(tpPrice)}</span> <span style="opacity:0.6;font-size:0.55rem">(${bt.tp}%)</span></span> &middot; <span style="color:var(--text-dim)">Half <span class="bt-half tap-copy" onclick="copyVal(this)">${fmt(halfPrice)}</span></span></span></div>`;
            }

            return `
                <div class="action-item ${isDemo ? 'pick-demo' : 'pick-glow'}" id="${pickId}">
                    <div>
                        <div class="ticker-header">
                            <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                            <div class="ticker-icon-fallback">${fallbackText}</div>
                            <span class="ticker-badge">${esc(tkr)}</span>
                            <span class="signal-tag ${signalClass}">${signalLabel(dir) || 'BUY'}</span>
                            <span class="score-tag">Score: ${score}/7</span>
                            ${wrHtml}
                        </div>
                        ${noteHtml ? `<div class="meta" style="margin-top:0.15rem">${noteHtml}</div>` : ''}
                        ${analysis ? `<div class="meta" style="margin-top:0.3rem;color:var(--text)">${esc(analysis)}</div>` : ''}
                        <div class="meta">@ $${prc}</div>
                        ${btHtml}
                        <div class="action-buttons">
                            <input type="text" class="entry-input" placeholder="Size $" id="${pickId}-size" onkeydown="if(event.key==='Enter'){navigator.clipboard.writeText(this.value);openBitunix('${esc(tkr)}')}">
                            ${bt ? `<input type="text" class="entry-input" placeholder="Entry $" id="${pickId}-entry" value="${p}" style="width:80px" oninput="recalcLevels('${pickId}')">` : ''}
                            <button class="action-btn entered" onclick="markPickAction('${esc(tkr)}','${esc(s.signal || s.direction)}',${prc},'Entered','${pickId}')">Entered</button>
                            <button class="action-btn skipped" onclick="markPickAction('${esc(tkr)}','${esc(s.signal || s.direction)}',${prc},'Skipped','${pickId}')">Skipped</button>
                        </div>
                    </div>
                </div>
            `;
    }

    // ====== ACTION NEEDED ======
    function renderActions(actionNeeded, allSignals) {
        const actionList = document.getElementById('actionList');
        const actionCount = document.getElementById('actionCount');
        actionNeeded = actionNeeded.filter(a => !isActed(a.ticker || a.symbol || '', a.signal || ''));
        actionCount.textContent = actionNeeded.length;

        if (actionNeeded.length === 0) {
            actionList.innerHTML = '<div class="no-actions">All caught up - no actions needed</div>';
            return;
        }

        actionList.innerHTML = actionNeeded.map((a, i) => {
            const id = 'action-' + i;
            const tkr = a.ticker || a.symbol || '';
            const prc = a.price || a.entry || 0;
            const sym = getCoinSymbol(tkr);
            const iconUrl = sym ? `https://assets.coincap.io/assets/icons/${sym}@2x.png` : '';
            const fallbackText = sym ? sym.slice(0,2).toUpperCase() : '?';

            const geckoFallback = sym ? `fetchCoinGeckoIcon('${esc(tkr)}',this,this.nextElementSibling)` : '';
            const onerrorAttr = `this.style.display='none';this.nextElementSibling.style.display='flex';${geckoFallback}`;

            const signalType = (a.signal || 'buy').toLowerCase();
            const signalClass = signalType.includes('sell') || signalType.includes('short') || signalType.includes('reduce') ? 'sell' : 'buy';
            const isDCA = signalType.includes('reduce') || signalType.includes('add');
            const score = a.score || a._score || '-';

            // Use RSI/MACD/Vol from action item directly (from Apps Script), fall back to signal match
            const matched = (allSignals || []).find(s => (s.symbol || s.ticker || '').toUpperCase() === tkr.toUpperCase() && Math.abs(Number(s.entry || s.price || 0) - prc) < 0.001)
                || (allSignals || []).find(s => (s.symbol || s.ticker || '').toUpperCase() === tkr.toUpperCase());
            const rsi = a.rsi || (matched ? matched.rsi : '');
            const macd = a.macd || (matched ? matched.macd : '');
            const vol = a.volume || (matched ? matched.volume : '');
            const sl = matched ? matched.sl : '';
            const tp1 = matched ? matched.tp1 : '';

            const detailParts = [];
            if (rsi) detailParts.push('RSI: ' + Number(rsi).toFixed(1));
            if (macd) detailParts.push('MACD: ' + macd);
            if (vol) detailParts.push('Vol: ' + vol);
            const detailStr = detailParts.join(' Â· ');
            const fmtLvl = v => { v = Number(v); return v >= 100 ? v.toFixed(1) : v >= 1 ? v.toFixed(2) : v >= 0.01 ? v.toFixed(4) : v.toPrecision(4); };
            const tp2 = matched ? matched.tp2 : '';
            const levelsStr = (sl ? '<span style="color:var(--red-bright)">SL <span class="tap-copy" onclick="copyVal(this)">' + fmtLvl(sl) + '</span></span>' : '') + (tp1 ? ' Â· <span style="color:var(--green-bright)">TP <span class="tap-copy" onclick="copyVal(this)">' + fmtLvl(tp1) + '</span></span>' : '') + (tp2 ? ' Â· <span style="color:var(--green-bright)">TP2 <span class="tap-copy" onclick="copyVal(this)">' + fmtLvl(tp2) + '</span></span>' : '');

            if (a.type === 'mark_action') {
                // Backtest lookup
                const isBuy = signalClass === 'buy';
                const bt = getBacktest(tkr, signalType);
                const btEntry = BACKTEST[tkr.toUpperCase()];
                const btNote = btEntry ? btEntry.note : null;
                const p = Number(String(prc).replace(/,/g, ''));
                const noteHtml = btNote ? `<span style="color:#ffa726;font-weight:700">${esc(btNote)}</span>` : '';
                const wrHtml = bt ? `<span style="color:var(--accent);font-weight:700">WR ${bt.wr}%</span>` : '';
                const btSide = isBuy ? 'buy' : 'sell';
                const btDataAttr = bt ? `data-sl="${bt.sl}" data-tp="${bt.tp}" data-half="${bt.halfTp}" data-side="${btSide}"` : '';
                let btHtml = '';
                if (bt && p > 0) {
                    const slPrice = isBuy ? p * (1 - bt.sl / 100) : p * (1 + bt.sl / 100);
                    const tpPrice = isBuy ? p * (1 + bt.tp / 100) : p * (1 - bt.tp / 100);
                    const halfPrice = isBuy ? p * (1 + bt.halfTp / 100) : p * (1 - bt.halfTp / 100);
                    const fmt = v => v >= 100 ? v.toFixed(1) : v >= 1 ? v.toFixed(2) : v >= 0.01 ? v.toFixed(4) : v.toPrecision(4);
                    btHtml = `<div class="meta" style="margin-top:0.2rem"><span class="bt-levels" ${btDataAttr}><span style="color:var(--red-bright)">SL <span class="bt-sl tap-copy" onclick="copyVal(this)">${fmt(slPrice)}</span> <span style="opacity:0.6;font-size:0.55rem">(${bt.sl}%)</span></span> &middot; <span style="color:var(--green-bright)">TP <span class="bt-tp tap-copy" onclick="copyVal(this)">${fmt(tpPrice)}</span> <span style="opacity:0.6;font-size:0.55rem">(${bt.tp}%)</span></span> &middot; <span style="color:var(--text-dim)">Half <span class="bt-half tap-copy" onclick="copyVal(this)">${fmt(halfPrice)}</span></span></span></div>`;
                }
                return `
                    <div class="action-item" id="${id}">
                        <div style="display:flex;justify-content:space-between;gap:1rem;width:100%">
                            <div style="flex:1">
                                <div class="ticker-header">
                                    <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                                    <div class="ticker-icon-fallback">${fallbackText}</div>
                                    <span class="ticker-badge">${esc(tkr)}</span>
                                    <span class="signal-tag ${signalClass}">${signalLabel(signalType)}</span>
                                    ${isDCA ? '' : `<span class="score-tag">Score: ${score}</span>`}
                                    ${wrHtml}
                                </div>
                                ${noteHtml ? `<div class="meta" style="margin-top:0.15rem">${noteHtml}</div>` : ''}
                                <div class="meta">@ $${prc}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                                ${!bt && levelsStr ? `<div class="meta" style="margin-top:0.15rem;font-size:0.7rem">${levelsStr}</div>` : ''}
                                ${btHtml}
                                <div class="action-buttons">
                                    <input type="text" class="entry-input" placeholder="Size $" id="${id}-size" onkeydown="if(event.key==='Enter'){navigator.clipboard.writeText(this.value);openBitunix('${esc(tkr)}')}">
                                    ${bt ? `<input type="text" class="entry-input" placeholder="Entry $" id="${id}-entry" value="${p}" style="width:80px" oninput="recalcLevels('${id}')">` : ''}
                                    <button class="action-btn entered" onclick="markAction('${esc(tkr)}','${esc(a.signal)}',${prc},'Entered','${id}')">Entered</button>
                                    <button class="action-btn skipped" onclick="markAction('${esc(tkr)}','${esc(a.signal)}',${prc},'Skipped','${id}')">Skipped</button>
                                </div>
                            </div>
                            <div style="text-align:right;font-size:0.75rem;color:var(--text-dim);display:flex;flex-direction:column;align-items:flex-end;justify-content:center;gap:0.3rem">
                                ${rsi ? '<div>RSI: <span style="color:' + (rsi < 30 ? 'var(--green-bright)' : rsi > 70 ? 'var(--red-bright)' : 'var(--text)') + '">' + Number(rsi).toFixed(1) + '</span></div>' : ''}
                                ${macd ? '<div>MACD: <span style="color:' + (macd === 'rising' ? 'var(--green-bright)' : 'var(--red-bright)') + '">' + macd + '</span></div>' : ''}
                                ${vol ? '<div>Vol: <span style="color:' + (vol === 'above' ? 'var(--green-bright)' : 'var(--text-dim)') + '">' + vol + '</span></div>' : ''}
                                <canvas class="sparkline" data-ticker="${esc(tkr)}" width="100" height="30" style="margin-top:0.2rem"></canvas>
                            </div>
                        </div>
                    </div>`;
            } else {
                return `
                    <div class="action-item" id="${id}">
                        <div>
                            <div class="ticker-header">
                                <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                                <div class="ticker-icon-fallback">${fallbackText}</div>
                                <span class="ticker-badge">${esc(tkr)}</span>
                                <span class="signal-tag ${signalClass}">${signalLabel(signalType)}</span>
                                ${isDCA ? '' : `<span class="score-tag">Score: ${score}</span>`}
                            </div>
                            <div class="meta">@ $${prc}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                            <div class="action-buttons">
                                <input type="text" class="entry-input" placeholder="Profit $" id="${id}-profit">
                                <button class="action-btn won" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Won','${id}')">Won</button>
                                <button class="action-btn lost" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Lost','${id}')">Lost</button>
                                <button class="action-btn open-pos" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Open','${id}')">Open</button>
                            </div>
                        </div>
                    </div>`;
            }
        }).join('');
    }

    // ====== OPEN TRADES ======
    function renderOpenTrades(trades) {
        const list = document.getElementById('openTradesList');
        const countEl = document.getElementById('openTradesCount');

        // Save any typed P&L input values before re-render
        const savedInputs = {};
        list.querySelectorAll('.open-trade-item').forEach(el => {
            const ticker = (el.dataset.ticker || '').toUpperCase();
            const input = el.querySelector('.entry-input');
            if (input && input.value.trim()) {
                savedInputs[ticker] = input.value;
            }
        });

        // Deduplicate by ticker â€” keep most recent entry per ticker
        const seen = {};
        const deduped = [];
        for (const t of trades) {
            const key = (t.ticker || t.symbol || '').toUpperCase();
            if (!seen[key]) {
                seen[key] = true;
                deduped.push(t);
            }
        }

        countEl.textContent = deduped.length;

        if (deduped.length === 0) {
            list.innerHTML = '<div class="no-actions">No open trades</div>';
            return;
        }

        list.innerHTML = deduped.map((a, i) => renderOpenTradeCard(a, i)).join('');
        setTimeout(() => {
            restoreOpenTradeStates();
            updateTradeClocks();
            // Restore saved P&L input values after re-render
            list.querySelectorAll('.open-trade-item').forEach(el => {
                const ticker = (el.dataset.ticker || '').toUpperCase();
                if (savedInputs[ticker]) {
                    const input = el.querySelector('.entry-input');
                    if (input) input.value = savedInputs[ticker];
                }
            });
        }, 50);
    }

    function renderOpenTradeCard(a, i) {
            const id = 'open-' + i;
            const tkr = a.ticker || a.symbol || '';
            const prc = a.price || a.entry || 0;
            const apiPnl = a.realizedPnl || 0;
            const sym = getCoinSymbol(tkr);
            const iconUrl = sym ? `https://assets.coincap.io/assets/icons/${sym}@2x.png` : '';
            const fallbackText = sym ? sym.slice(0,2).toUpperCase() : '?';
            const geckoFallback = sym ? `fetchCoinGeckoIcon('${esc(tkr)}',this,this.nextElementSibling)` : '';
            const onerrorAttr = `this.style.display='none';this.nextElementSibling.style.display='flex';${geckoFallback}`;
            const signalType = (a.signal || 'buy').toLowerCase();
            const signalClass = signalType.includes('sell') || signalType.includes('short') || signalType.includes('reduce') ? 'sell' : 'buy';

            return `
                <div class="open-trade-item needs-attention" id="${id}" data-status="${apiPnl ? 'has-pnl' : 'active'}" data-ticker="${esc(tkr).toUpperCase()}" data-pnl="${apiPnl}" data-trade-status="${a.tradeStatus || ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
                        <div style="flex:1">
                            <div class="ticker-header">
                                <img class="ticker-icon" src="${iconUrl}" alt="" onerror="${onerrorAttr}">
                                <div class="ticker-icon-fallback">${fallbackText}</div>
                                <span class="ticker-badge">${esc(tkr)}</span>
                                <span class="signal-tag ${signalClass}">${signalLabel(signalType)}</span>
                            </div>
                            <div class="meta" style="font-size:0.6rem">@ $${prc}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                            <div class="action-buttons">
                                <input type="text" class="entry-input" placeholder="P&L $" id="${id}-profit" style="width:55px">
                                <button class="action-btn entered" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'0x0','${id}')">0x0</button>
                                <button class="action-btn won" onclick="markOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Won','${id}')">Hit TP</button>
                                <button class="action-btn lost" onclick="confirmOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Lost','${id}','Stopped Out')">Stopped Out</button>
                                <button class="action-btn skipped" onclick="confirmOutcome('${esc(tkr)}','${esc(a.signal)}',${prc},'Closed','${id}','Close')">Closed</button>
                                <button class="action-btn trade-clock" id="${id}-clock" data-entered="${a.timestamp || ''}" onclick="dismissTradeClock('${id}')"></button>
                            </div>
                        </div>
                        <div class="pnl-display" id="${id}-pnl-display" style="text-align:right;min-width:70px">
                            <div style="font-size:0.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">P&L</div>
                            <div class="pnl-amount" style="font-family:'Space Mono',monospace;font-size:1.2rem;font-weight:700;color:var(--text-dim)">$0</div>
                        </div>
                    </div>
                </div>`;
    }

    // ====== TRADE CLOCKS ======
    const TWO_DAY_MS = 48 * 60 * 60 * 1000;
    function updateTradeClocks() {
        let overdueCount = 0;
        document.querySelectorAll('.trade-clock').forEach(el => {
            const card = el.closest('.open-trade-item');
            const ticker = card ? (card.dataset.ticker || '') : '';
            const signal = card ? (card.querySelector('.signal-tag')?.textContent?.toLowerCase() || '') : '';
            const resetKey = 'clock_' + ticker + '_' + signal;
            const resetTs = Number(localStorage.getItem(resetKey) || 0);
            const entered = el.dataset.entered;
            if (!entered && !resetTs) { el.textContent = '--'; return; }
            const baseTime = resetTs || new Date(entered).getTime();
            if (isNaN(baseTime)) { el.textContent = '--'; return; }
            const elapsed = Date.now() - baseTime;
            const hours = Math.floor(elapsed / (60 * 60 * 1000));
            const days = Math.floor(hours / 24);
            const remainHours = hours % 24;
            if (days > 0) {
                el.textContent = days + 'd ' + remainHours + 'h';
            } else {
                el.textContent = hours + 'h';
            }
            el.classList.remove('warn', 'overdue');
            if (elapsed >= TWO_DAY_MS) {
                el.classList.add('overdue');
                overdueCount++;
            } else if (elapsed >= TWO_DAY_MS * 0.75) {
                el.classList.add('warn');
            }
        });
        const filterBtn = document.getElementById('need2dayFilter');
        if (filterBtn) {
            if (overdueCount > 0) {
                filterBtn.classList.add('has-alerts');
                filterBtn.textContent = 'Need 2 Day (' + overdueCount + ')';
            } else {
                filterBtn.classList.remove('has-alerts');
                filterBtn.textContent = 'Need 2 Day';
            }
        }
    }
    setInterval(updateTradeClocks, 60000);

    function dismissTradeClock(id) {
        const clock = document.getElementById(id + '-clock');
        if (!clock) return;
        const ticker = document.getElementById(id)?.dataset.ticker || '';
        const signal = document.getElementById(id)?.querySelector('.signal-tag')?.textContent?.toLowerCase() || '';
        // Save reset time to localStorage
        localStorage.setItem('clock_' + ticker + '_' + signal, String(Date.now()));
        clock.classList.remove('warn', 'overdue');
        clock.textContent = '0h';
        updateTradeClocks();
    }

    // ====== OPEN TRADE LOCAL STATE (survives refresh) ======
    function tradeStateKey(ticker, signal) { return 'trade_' + ticker.toUpperCase() + '_' + signal.toLowerCase(); }
    function saveTradeState(ticker, signal, state) {
        localStorage.setItem(tradeStateKey(ticker, signal), JSON.stringify(state));
    }
    function getTradeState(ticker, signal) {
        try { return JSON.parse(localStorage.getItem(tradeStateKey(ticker, signal))) || null; } catch(e) { return null; }
    }
    function clearTradeState(ticker, signal) {
        localStorage.removeItem(tradeStateKey(ticker, signal));
    }

    // ====== POKEBALL TOGGLE (click to mark used/available) ======
    function togglePokeball(idx) {
        const used = JSON.parse(localStorage.getItem('pokeball_used') || '[false,false,false,false,false]');
        used[idx] = !used[idx];
        localStorage.setItem('pokeball_used', JSON.stringify(used));
        // Re-render the pokemon section
        const pokemonEl = document.getElementById('pokemonSection');
        if (pokemonEl && window._lastStats) renderPokemon(window._lastStats);
        // Sync to Google Sheet (fire and forget)
        fireGet(POST_URL + '?action=update_pokeballs&state=' + encodeURIComponent(JSON.stringify(used)));
    }

    // ====== DCA MODE ======
    function toggleDCAMode() {
        dcaMode = !dcaMode;
        localStorage.setItem('dca_mode', dcaMode ? 'true' : 'false');
        updateDCAControls();
        if (window._lastStats) renderPokemon(window._lastStats);
        fireGet(POST_URL + '?action=toggle_dca&mode=' + dcaMode);
    }

    function updateDCAControls() {
        const btn = document.getElementById('dcaToggleBtn');
        const lvlBtn = document.getElementById('dcaLevelUpBtn');
        if (btn) {
            btn.textContent = 'DCA: ' + (dcaMode ? 'ON' : 'OFF');
            btn.classList.toggle('active', dcaMode);
        }
        if (lvlBtn) {
            lvlBtn.style.display = dcaMode ? '' : 'none';
            if (dcaMode && window._lastStats) {
                const pnl = parseFloat(window._lastStats.netPnl) || 0;
                const boostedPnl = pnl + dcaTotal;
                const currentDCALevel = getPokemonLevel(boostedPnl);
                const nextDCALevel = getNextPokemonLevel(currentDCALevel);
                if (nextDCALevel) {
                    const gap = Math.max(0, nextDCALevel.min - boostedPnl);
                    const nextIdx = POKEMON_LEVELS.indexOf(nextDCALevel) + 1;
                    lvlBtn.textContent = 'Level Up \u2192 Lv.' + nextIdx + ' ' + nextDCALevel.pokemon + ' (+$' + gap.toFixed(2) + ')';
                    lvlBtn.disabled = false;
                } else {
                    lvlBtn.textContent = 'MAX LEVEL';
                    lvlBtn.disabled = true;
                }
            }
        }
    }

    function dcaLevelUp() {
        if (!dcaMode || !window._lastStats) return;
        const pnl = parseFloat(window._lastStats.netPnl) || 0;
        const boostedPnl = pnl + dcaTotal;
        const currentDCALevel = getPokemonLevel(boostedPnl);
        const nextDCALevel = getNextPokemonLevel(currentDCALevel);
        if (!nextDCALevel) return;
        const gap = Math.max(0.01, nextDCALevel.min - boostedPnl);
        const nextIdx = POKEMON_LEVELS.indexOf(nextDCALevel) + 1;
        if (!confirm('Add $' + gap.toFixed(2) + ' DCA to reach Lv.' + nextIdx + ' ' + nextDCALevel.pokemon + '?')) return;
        dcaTotal += gap;
        localStorage.setItem('dca_total', dcaTotal.toString());
        updateDCAControls();
        renderPokemon(window._lastStats);
        fireGet(POST_URL + '?action=update_dca&amount=' + gap.toFixed(2));
    }

    // Restore saved state after rendering open trade cards
    function restoreOpenTradeStates() {
        document.querySelectorAll('.open-trade-item').forEach(el => {
            const ticker = el.dataset.ticker;
            const signal = el.querySelector('.signal-tag')?.textContent?.toLowerCase() || '';
            // Check localStorage first, then fall back to API data
            let state = getTradeState(ticker, signal);
            let status = '', pnl = 0;
            if (state) {
                status = state.status || 'active';
                pnl = state.pnl || 0;
            } else {
                const apiPnl = Number(el.dataset.pnl) || 0;
                const apiStatus = (el.dataset.tradeStatus || '').toLowerCase();
                if (apiStatus === '0x0' || apiStatus === 'tp') {
                    status = apiStatus;
                    pnl = apiPnl;
                } else if (apiPnl !== 0) {
                    status = 'has-pnl';
                    pnl = apiPnl;
                } else {
                    return;
                }
            }
            el.dataset.pnl = pnl;
            el.dataset.status = status;
            el.classList.remove('needs-attention');
            // Border + header badge
            if (status === 'tp') {
                el.style.borderLeftColor = 'var(--green-candle)';
                const header = el.querySelector('.ticker-header');
                if (header) header.insertAdjacentHTML('beforeend', `<span class="pnl-badge" style="background:var(--green-dim);color:var(--green-bright)">TP ${pnl >= 0 ? '+$' + Number(pnl).toFixed(2) : '-$' + Math.abs(pnl).toFixed(2)}</span>`);
            } else if (status === '0x0') {
                el.style.borderLeftColor = 'var(--accent)';
                const header = el.querySelector('.ticker-header');
                if (header) header.insertAdjacentHTML('beforeend', '<span class="pnl-badge" style="background:#4a9eff22;color:var(--accent-glow)">0x0</span>');
            } else {
                el.style.borderLeftColor = 'var(--green-candle)';
                const header = el.querySelector('.ticker-header');
                const pStr = pnl >= 0 ? '+$' + Number(pnl).toFixed(2) : '-$' + Math.abs(pnl).toFixed(2);
                if (header) header.insertAdjacentHTML('beforeend', `<span class="pnl-badge" style="background:rgba(74,158,255,0.13);color:var(--accent-glow)">P&L ${pStr}</span>`);
            }
            // Update right-side P&L display: amount + status on same line
            const p = Number(pnl);
            const pnlDisplay = el.querySelector('.pnl-amount');
            if (pnlDisplay) {
                const amountStr = p !== 0 ? ((p >= 0 ? '+$' : '-$') + Math.abs(p).toFixed(2)) : '$0';
                const amountColor = p >= 0 ? 'var(--green-bright)' : 'var(--red-bright)';
                if (status === '0x0' || status === 'tp') {
                    const statusColor = status === '0x0' ? 'var(--accent-glow)' : 'var(--green-bright)';
                    const statusText = status === '0x0' ? '0x0' : 'TP';
                    pnlDisplay.style.cssText = 'font-family:Space Mono,monospace;font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:20px;justify-content:flex-end';
                    pnlDisplay.innerHTML = `<span style="color:${statusColor}">${statusText}</span><span style="color:${amountColor}">${amountStr}</span>`;
                } else if (p !== 0) {
                    pnlDisplay.textContent = amountStr;
                    pnlDisplay.style.color = amountColor;
                }
            }
        });
    }

    // ====== OPEN TRADES FILTER ======
    let otFilterMode = 'all';
    function setOTFilter(btn, mode) {
        otFilterMode = mode;
        document.querySelectorAll('.ot-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterOpenTrades();
    }
    function filterOpenTrades() {
        const search = (document.getElementById('otSearch').value || '').toUpperCase().trim();
        document.querySelectorAll('.open-trade-item').forEach(card => {
            const ticker = (card.dataset.ticker || '').toUpperCase();
            const status = card.dataset.status || 'active';
            const matchSearch = !search || ticker.includes(search);
            let matchFilter = true;
            if (otFilterMode === 'no-0x0') matchFilter = status !== '0x0';
            else if (otFilterMode === 'no-tp') matchFilter = status !== 'tp';
            else if (otFilterMode === 'done') matchFilter = status === '0x0' || status === 'tp';
            else if (otFilterMode === 'need-2day') {
                const clock = card.querySelector('.trade-clock');
                matchFilter = clock && clock.classList.contains('overdue');
            }
            card.style.display = (matchSearch && matchFilter) ? '' : 'none';
        });
    }

    // ====== SIGNALS TABLE ======
    function renderSignalsTable(signals) {
        // signalCount removed from UI
        const tbody = document.getElementById('signalsBody');
        tbody.innerHTML = signals.map(s => {
            const dir = (s.direction || s.signal || '').toLowerCase();
            const dirClass = dir === 'short' ? 'short' : 'long';
            const scoreClass = getScoreClass(s._score);
            const entry = Number(s.entry || s.price || 0);
            const sl = Number(s.sl || 0);
            const tp1 = Number(s.tp1 || 0);

            return `
                <tr>
                    <td>${esc(s.timestamp || '-')}</td>
                    <td style="font-weight:700;color:var(--text-bright)">${esc(s.symbol || s.ticker || '-')}</td>
                    <td><span class="signal-badge ${dirClass}">${dirClass.toUpperCase()}</span></td>
                    <td>${entry ? '$' + entry.toFixed(2) : '-'}</td>
                    <td>${sl ? '$' + sl.toFixed(2) : '-'}</td>
                    <td>${tp1 ? '$' + tp1.toFixed(2) : '-'}</td>
                    <td><span class="score-badge ${scoreClass}">${s._score}/7</span></td>
                    <td>${esc(s.macd || '-')}</td>
                    <td>${esc(s.volume || '-')}</td>
                    <td>${s.rsi != null ? Number(s.rsi).toFixed(1) : '-'}</td>
                </tr>
            `;
        }).join('');
    }

    // ====== PERFORMANCE ======
    function renderPerformance(stats) {
        const perfGrid = document.getElementById('perfGrid');

        // Calculate win rate by score range from available data
        const wrByScore = stats.winRateByScore || {};

        const streak = stats.currentStreak || '0';
        const streakNum = parseInt(streak);
        const streakColor = streak.includes('W') ? 'var(--green-bright)' : streak.includes('L') ? 'var(--red-bright)' : '';

        const wins = parseInt(stats.wins) || 0;
        const losses = parseInt(stats.losses) || 0;
        const gw = parseFloat(stats.grossWin) || 0;
        const gl = parseFloat(stats.grossLoss) || 0;

        const trend = stats.trend;
        const fmtPnl = (v) => v >= 0 ? '+$' + v.toFixed(2) : '-$' + Math.abs(v).toFixed(2);
        const fmtAvg = (v) => v >= 0 ? '+$' + v.toFixed(3) : '-$' + Math.abs(v).toFixed(3);
        const avgColor = (v) => v > 0 ? 'var(--green-bright)' : v < 0 ? 'var(--red-bright)' : '';
        const dirIcon = trend ? (trend.direction === 'improving' ? '&#9650;' : trend.direction === 'declining' ? '&#9660;' : '&#9654;') : '';
        const dirColor = trend ? (trend.direction === 'improving' ? 'var(--green-bright)' : trend.direction === 'declining' ? 'var(--red-bright)' : 'var(--accent)') : '';
        let trendPct = '';
        if (trend && trend.allTime.avgPerTrade !== 0) {
            const pctDiff = ((trend.avg14d.avgPerTrade - trend.allTime.avgPerTrade) / Math.abs(trend.allTime.avgPerTrade) * 100);
            trendPct = (pctDiff >= 0 ? '+' : '') + pctDiff.toFixed(0) + '%';
        } else if (trend) {
            trendPct = trend.direction.toUpperCase();
        }

        perfGrid.innerHTML = `
            <div class="perf-item">
                <div class="perf-val" style="color:var(--green-bright);text-shadow:0 0 15px var(--green-bright),0 0 30px rgba(0,255,136,0.4)">${wins} <span style="font-size:0.7rem;font-weight:400">Won</span></div>
                <div class="perf-label" style="color:var(--green-bright)">+$${gw.toFixed(2)}</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--red-bright);text-shadow:0 0 15px var(--red-bright),0 0 30px rgba(255,68,68,0.4)">${losses} <span style="font-size:0.7rem;font-weight:400">Lost</span></div>
                <div class="perf-label" style="color:var(--red-bright)">-$${Math.abs(gl).toFixed(2)}</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--green-bright)">${wrByScore.high || '-'}</div>
                <div class="perf-label">WR Score 5-7</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:#f9c846">${wrByScore.mid || '-'}</div>
                <div class="perf-label">WR Score 3-4</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--red-bright)">${wrByScore.low || '-'}</div>
                <div class="perf-label">WR Score 0-2</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:${dirColor}">${trend ? dirIcon + ' ' + trendPct : '-'}</div>
                <div class="perf-label">14d vs All-Time</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--green-bright)">+$${stats.bestTradePnl || '0'}</div>
                <div class="perf-label">Best Trade</div>
                <div style="font-size:0.55rem;color:var(--green-bright);margin-top:2px">${stats.bestTrade || '-'}</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:var(--red-bright)">${parseFloat(stats.worstTradePnl || 0) < 0 ? '-$' + Math.abs(parseFloat(stats.worstTradePnl)).toFixed(2) : '$' + (stats.worstTradePnl || '0')}</div>
                <div class="perf-label">Worst Trade</div>
                <div style="font-size:0.55rem;color:var(--red-bright);margin-top:2px">${stats.worstTrade || '-'}</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:#f9c846">${stats.bestWinStreak || 0} Wins</div>
                <div class="perf-label">Best Streak</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:${trend ? (trend.avg14d.pnl >= 0 ? '#64b5f6' : 'var(--red-bright)') : ''}">${trend ? fmtPnl(trend.avg14d.pnl) : '-'}</div>
                <div class="perf-label">14d P&L${trend ? ' (' + trend.avg14d.trades + ')' : ''}</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:${trend ? (trend.avg30d.pnl >= 0 ? '#b39ddb' : 'var(--red-bright)') : ''}">${trend ? fmtPnl(trend.avg30d.pnl) : '-'}</div>
                <div class="perf-label">30d P&L${trend ? ' (' + trend.avg30d.trades + ')' : ''}</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:${trend ? (trend.allTime.avgPerTrade >= 0 ? '#ffb74d' : 'var(--red-bright)') : ''}">${trend ? fmtAvg(trend.allTime.avgPerTrade) : '-'}</div>
                <div class="perf-label">Avg $/Trade</div>
            </div>
        `;
    }

    // ====== TICKER GRID ======
    function getCoinSymbol(ticker) {
        if (!ticker) return '';
        let t = ticker.toUpperCase();
        // Strip .P suffix (Bitunix perpetual contracts)
        if (t.endsWith('.P')) t = t.slice(0, -2);
        if (t.endsWith('USDT')) return t.slice(0, -4).toLowerCase();
        if (t.endsWith('USDC')) return t.slice(0, -4).toLowerCase();
        if (t.endsWith('USD')) return t.slice(0, -3).toLowerCase();
        if (t.endsWith('BTC')) return t.slice(0, -3).toLowerCase();
        return t.toLowerCase();
    }

    const coinIconCache = {};

    function getCoinIconUrl(ticker) {
        const sym = getCoinSymbol(ticker);
        if (coinIconCache[sym]) return coinIconCache[sym];
        return `https://assets.coincap.io/assets/icons/${sym}@2x.png`;
    }

    async function fetchCoinGeckoIcon(ticker, imgEl, fallbackEl) {
        const sym = getCoinSymbol(ticker);
        if (coinIconCache[sym]) {
            imgEl.src = coinIconCache[sym];
            imgEl.style.display = '';
            fallbackEl.style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`https://api.coingecko.com/api/v3/search?query=${sym}`);
            const data = await res.json();
            const match = data.coins?.find(c => c.symbol.toLowerCase() === sym);
            if (match && match.large) {
                coinIconCache[sym] = match.large;
                imgEl.src = match.large;
                imgEl.style.display = '';
                fallbackEl.style.display = 'none';
            }
        } catch(e) {}
    }

    function renderTickerCard(t, i) {
        const dir = (t.lastDirection || t.lastSignal || 'idle').toLowerCase();
        const dirClass = (dir === 'short' || dir === 'sell') ? 'short' : (dir === 'long' || dir === 'buy') ? 'long' : 'idle';
        const wrClass = (parseFloat(t.winRate) || 0) >= 50 ? 'green' : (parseFloat(t.winRate) || 0) > 0 ? 'red' : '';
        const tid = 'ticker-' + i;

        return `
            <div class="ticker-card" id="${tid}">
                <div class="ticker-card-header">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <img class="ticker-coin-icon" src="${getCoinIconUrl(t.ticker)}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';fetchCoinGeckoIcon('${esc(t.ticker)}',this,this.nextElementSibling)">
                        <div class="ticker-coin-fallback">${getCoinSymbol(t.ticker).slice(0,2).toUpperCase()}</div>
                        <span class="ticker-name">${esc(t.ticker)}</span>
                        <span class="ticker-direction ${dirClass}">${dirClass.toUpperCase()}</span>
                    </div>
                </div>
                <dl class="ticker-detail">
                    <dt>Win Rate</dt><dd class="${wrClass}">${t.winRate || '0%'}</dd>
                    <dt>Total Trades</dt><dd>${t.totalTrades || 0}</dd>
                    <dt>Total P&L</dt><dd class="${(t.totalPnl || 0) > 0 ? 'green' : (t.totalPnl || 0) < 0 ? 'red' : ''}">${(t.totalPnl || 0) !== 0 ? '$' + Number(t.totalPnl).toFixed(2) : '-'}</dd>
                    <dt>Last Signal</dt><dd>${esc((t.lastSignal || '-').toUpperCase())}</dd>
                    <dt>Direction</dt><dd>${esc((t.lastDirection || '-').toUpperCase())}</dd>
                    <dt>Avg Score</dt><dd>${t.avgScore || '-'}</dd>
                </dl>
                <div class="ticker-last-signal">${(t.lastTimestamp || t.lastSignalTime) ? 'Last: ' + esc(t.lastTimestamp || t.lastSignalTime) : 'No signals yet'}</div>
                <div class="ticker-links">
                    <a class="ticker-link tv" href="${getTickerLink(t.ticker, 'tv')}" target="_blank">TradingView</a>
                    <button class="ticker-link bx" onclick="openBitunix('${esc(t.ticker)}')">Bitunix</button>
                    <button class="ticker-link" onclick="editLinks('${esc(t.ticker)}')" title="Edit links">&#9998;</button>
                </div>
            </div>
        `;
    }

    function renderTickerGrid(filtered) {
        const grid = document.getElementById('tickerGrid');
        const btn = document.getElementById('tickerShowAll');
        const search = document.getElementById('tickerSearch').value.trim().toUpperCase();
        let tickers = filtered || allTickers;

        if (search) {
            tickers = allTickers.filter(t => t.ticker.toUpperCase().includes(search));
            btn.textContent = `${tickers.length} match${tickers.length !== 1 ? 'es' : ''}`;
        } else if (!showAllTickers && tickers.length > TICKER_LIMIT) {
            tickers = tickers.slice(0, TICKER_LIMIT);
            btn.textContent = 'Show All (' + allTickers.length + ')';
        } else {
            btn.textContent = tickers.length + ' tickers';
        }

        grid.innerHTML = tickers.map((t, i) => renderTickerCard(t, i)).join('');
    }

    function filterTickers() {
        renderTickerGrid();
    }

    function toggleShowAll() {
        const search = document.getElementById('tickerSearch');
        if (search.value.trim()) {
            search.value = '';
        }
        showAllTickers = !showAllTickers;
        renderTickerGrid();
    }

    // ====== HELPERS ======
    function copyVal(el) {
        const v = el.textContent.trim();
        navigator.clipboard.writeText(v).then(() => {
            const orig = el.style.cssText;
            el.style.cssText += 'background:var(--green-dim);border-radius:4px;transition:background 0.2s';
            const lbl = el.parentElement;
            const tag = document.createElement('span');
            tag.textContent = ' Copied!';
            tag.style.cssText = 'color:var(--green-bright);font-size:0.6rem;opacity:1;transition:opacity 0.3s';
            lbl.appendChild(tag);
            setTimeout(() => { tag.style.opacity = '0'; }, 600);
            setTimeout(() => { el.style.cssText = orig; tag.remove(); }, 900);
        });
    }

    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    // ====== TICKER LINKS ======
    const TV_EXCHANGE_MAP = {
        '0G':'BINANCE','1000CAT':'BINANCE','1INCH':'BINANCE','2Z':'BINANCE','4':'BINANCE',
        'A':'OKX','A2Z':'BINANCE','AAVE':'BINANCE','ACE':'BINANCE','ACH':'BINANCE',
        'ACT':'BINANCE','ACU':'BINANCE','ACX':'COINBASE','ADA':'BINANCE','AERGO':'OKX',
        'AERO':'COINBASE','AEVO':'BINANCE','AGLD':'OKX','AI':'HTX','AIA':'MEXC',
        'AIN':'BINANCE','AIO':'BINANCE','AIOT':'BINANCE','AIOZ':'BYBIT','AIXBT':'BINANCE',
        'AKE':'KRAKEN','AKT':'KRAKEN','ALCH':'KRAKEN','ALEO':'GATE','ALGO':'BINANCE',
        'ALICE':'BINANCE','ALLO':'BINANCE','ALPINE':'BINGX','ALT':'BINANCE','AMP':'COINBASE',
        'ANIME':'BINANCE','ANKR':'CAPITALCOM','APE':'BINANCE','APEX':'BYBIT','API3':'BINANCE',
        'APR':'BINANCE','APT':'COINBASE','AR':'BINANCE','ARB':'BINANCE','ARIA':'BYBIT',
        'ARK':'BINANCE','ARKM':'BINANCE','ARPA':'BINANCE','ASR':'BINANCE','ASTER':'BINANCE',
        'ASTR':'BINANCE','AT':'OKX','ATH':'COINBASE','ATOM':'BINANCE','AUCTION':'BINANCE',
        'AVA':'BINANCE','AVAAI':'BINANCE','AVAX':'BINANCE','AVNT':'BINANCE','AWE':'BINANCE',
        'AXL':'BINANCE','AXS':'BINANCE','B':'BINANCE','B2':'KRAKEN','B3':'BINANCE',
        'BABY':'OKX','BAN':'BINANCE','BANANA':'BINANCE','BANANAS31':'BINANCE','BAND':'BINANCE',
        'BANK':'BINANCE','BARD':'BINANCE','BAS':'BINANCE','BAT':'KRAKEN','BB':'BINANCE',
        'BCH':'BINANCE','BDXN':'BYBIT','BEAMX':'BINANCE','BEAT':'BINANCE','BERA':'BINANCE',
        'BIANRENSHENG':'BINANCE','BICO':'BINANCE','BIGTIME':'BINANCE','BIO':'BINANCE',
        'BLESS':'BINGX','BLUAI':'BINANCE','BLUR':'BINANCE','BMT':'BINANCE','BNB':'BINANCE',
        'BNT':'BINANCE','BOBBOB':'COINBASE','BOME':'BINANCE','BONK':'BINANCE','BR':'BINANCE',
        'BRETT':'BYBIT','BREV':'OKX','BROCCOLI714':'BINANCE','BSV':'MEXC','BTC':'OKX',
        'BTR':'BINANCE','BTT':'KRAKEN','C':'BINANCE','C98':'BINANCE','CAKE':'BINANCE',
        'CARV':'KRAKEN','CATI':'COINBASE','CC':'KUCOIN','CELO':'BINANCE','CELR':'CAPITALCOM',
        'CETUS':'BINANCE','CFX':'BINANCE','CGPT':'BINANCE','CHEEMS':'BITGET','CHESS':'BINANCE',
        'CHILLGUY':'BINANCE','CHR':'BINANCE','CHZ':'GEMINI','CKB':'BINANCE','CLANKER':'BYBIT',
        'CLO':'BINANCE','COAI':'MEXC','COLLECT':'BINANCE','COMMON':'BITUNIX','COMP':'COINBASE',
        'COOKIE':'COINBASE','CORE':'OKX','COS':'BINANCE','COTI':'BINANCE','COW':'COINBASE',
        'CRO':'COINBASE','CROSS':'BINANCE','CRV':'BINANCE','CSPR':'BYBIT','CTC':'BYBIT',
        'CTK':'BINANCE','CTSI':'CAPITALCOM','CUDIS':'MEXC','CVC':'CAPITALCOM','CVX':'BINANCE',
        'CYBER':'BINANCE','CYS':'MEXC','DASH':'BINANCE','DBR':'BYBIT','DCR':'BINANCE',
        'DEEP':'KRAKEN','DEGO':'BINANCE','DENT':'BINANCE','DEXE':'BINANCE','DF':'BINANCE',
        'DGB':'BINANCE','DIA':'COINBASE','DN':'MEXC','DOG':'GATE','DOGE':'BINANCE',
        'DOGS':'BINANCE','DOLO':'BINANCE','DOOD':'BINANCE','DOT':'BINANCE','DRIFT':'KRAKEN',
        'DUSK':'BINANCE','DYDX':'BINANCE','DYM':'BINANCE','EDEN':'BINANCE','EDU':'BINANCE',
        'EGLD':'BINANCE','EIGEN':'BINANCE','ELSA':'BINANCE','ENA':'BINANCE','ENJ':'BINANCE',
        'ENS':'BINANCE','ENSO':'BINANCE','EPIC':'BINANCE','EPT':'MEXC','ERA':'BINANCE',
        'ESPORTS':'KRAKEN','ETC':'BINANCE','ETH':'BINANCE','ETHFI':'BINANCE','ETHW':'BINANCE',
        'EUL':'COINBASE','EVAA':'MEXC','F':'BINANCE','FARTCOIN':'MEXC','FET':'BINANCE',
        'FF':'BINANCE','FHE':'BYBIT','FIDA':'BINANCE','FIL':'BINANCE','FIO':'BINANCE',
        'FLOCK':'COINBASE','FLOKI':'BINANCE','FLOW':'BINANCE','FLR':'KRAKEN','FLUID':'OKX',
        'FOGO':'BINANCE','FOLKS':'BINANCE','FORM':'BINANCE','FORTH':'CAPITALCOM','FUN':'BINANCE',
        'G':'BINANCE','GALA':'BINANCE','GAS':'BINANCE','GHST':'COINBASE','GIGGLE':'BINANCE',
        'GLM':'OKX','GMT':'BINANCE','GMX':'BINANCE','GNO':'BINANCE','GOAT':'BINANCE',
        'GPS':'KUCOIN','GRASS':'BINANCE','GRIFFAIN':'BINANCE','GRT':'BINANCE','GT':'GATE',
        'GTC':'BINANCE','GUA':'GATE','GUN':'BINANCE','GWEI':'MEXC','H':'KRAKEN',
        'HAEDAL':'BINANCE','HANA':'BINANCE','HBAR':'BINANCE','HEI':'BINANCE','HEMI':'BINANCE',
        'HFT':'BINANCE','HIGH':'BINANCE','HIPPO':'BINANCE','HIVE':'BINANCE','HMSTR':'COINBASE',
        'HNT':'BYBIT','HOLO':'BINANCE','HOME':'COINBASE','HOOK':'BINANCE','HOT':'BINANCE',
        'HUMA':'BINANCE','HYPE':'BINANCE','HYPER':'COINBASE','ICNT':'BINANCE','ICP':'BINANCE',
        'ICX':'BINANCEUS','ID':'BINANCE','IDOL':'BINANCE','ILV':'BINANCE','IMX':'BINANCE',
        'IN':'BINANCE','INI':'MEXC','INIT':'KRAKEN','INJ':'BINANCE','INX':'COINBASE',
        'IO':'BINANCE','IOST':'BINANCE','IOTA':'BINANCE','IOTX':'BYBIT','IP':'COINBASE',
        'IR':'BINANCE','IRYS':'COINBASE','JASMY':'BINANCE','JCT':'BINANCE','JELLYJELLY':'OKX',
        'JOE':'BINANCE','JST':'BINANCE','JTO':'BINANCE','JUP':'BINANCE','KAIA':'BINANCE',
        'KAITO':'BINANCE','KAS':'MEXC','KAVA':'BINANCE','KERNEL':'BINANCE','KGEN':'BINANCE',
        'KITE':'BINANCE','KMNO':'BINANCE','KNC':'CAPITALCOM','KOMA':'MEXC','KSM':'BINANCE',
        'LA':'COINBASE','LAB':'BINGX','LAYER':'COINBASE','LDO':'COINBASE','LIGHT':'MEXC',
        'LINEA':'BINANCE','LINK':'BINANCE','LISTA':'BINANCE','LIT':'MEXC','LPT':'BINANCE',
        'LQTY':'BINANCE','LRC':'COINBASE','LSK':'BYBIT','LTC':'BYBIT','LUMIA':'BINANCE',
        'LUNA':'BYBIT','LUNA2':'KRAKEN','LUNC':'BINANCE','LYN':'KUCOIN','M':'MEXC',
        'MAGIC':'BINANCE','MAGMA':'BYBIT','MANA':'BINANCE','MANTA':'BINANCE','MASK':'BINANCE',
        'MAV':'BINANCE','MAVIA':'BINANCE','ME':'BINANCE','MELANIA':'BINANCE','MEME':'BINANCE',
        'MERL':'BINANCE','MET':'COINBASE','METIS':'COINBASE','MEW':'BYBIT','MINA':'KRAKEN',
        'MIRA':'BINANCE','MITO':'BINANCE','MLN':'BINANCE','MMT':'OKX','MNT':'BYBIT',
        'MOCA':'HTX','MOG':'BYBIT','MON':'COINBASE','MOODENG':'BINANCE','MORPHO':'OKX',
        'MOSS':'KCEX','MOVE':'KRAKEN','MOVR':'BINANCE','MTL':'BYBIT','MUBARAK':'BINANCE',
        'MYX':'BINANCE','NANO':'KRAKEN','NAORIS':'BYBIT','NEAR':'BINANCE','NEIRO':'BINANCE',
        'NEO':'BITFINEX','NEWT':'COINBASE','NEXO':'BINANCE','NFP':'BINANCE','NIGHT':'KRAKEN',
        'NIL':'COINBASE','NKN':'BINANCE','NMR':'BINANCE','NOM':'BINANCE','NOT':'BINANCE',
        'NPC':'BITGET','NTRN':'CRYPTOCOM','NXPC':'BINANCE','OG':'BINANCE','OGN':'KRAKEN',
        'OKB':'OKX','OL':'BINANCE','OM':'BINANCE','ON':'MEXC','ONDO':'BYBIT','ONE':'BINANCE',
        'ONG':'BINANCE','ONT':'BINANCE','OP':'BINANCE','OPEN':'KRAKEN','ORBS':'OKX',
        'ORCA':'BINANCE','ORDER':'KRAKEN','ORDI':'BINANCE','ORE':'MEXC','OXT':'BYBIT',
        'PARTI':'OKX','PEAQ':'GATE','PENDLE':'BINANCE','PENGU':'BINANCE','PENGUIN':'MEXC',
        'PEOPLE':'BINANCE','PEPE':'BINANCE','PHB':'BINANCE','PI':'OKX','PIEVERSE':'BYBIT',
        'PIPPIN':'BINANCE','PIXEL':'BINANCE','PLUME':'BYBIT','PNUT':'BINANCE','POL':'BINANCE',
        'POLYX':'BINANCE','POPCAT':'BYBIT','PORTAL':'BINANCE','POWER':'MEXC','POWR':'KRAKEN',
        'PROM':'BINANCE','PROMPT':'BYBIT','PROVE':'BINANCE','PTB':'BINANCE','PUFFER':'KRAKEN',
        'PUMP':'BINANCE','PUMPBTC':'BINANCE','PUNDIX':'BINANCE','PYTH':'BINANCE','Q':'KRAKEN',
        'QNT':'BINANCE','QTUM':'BINANCE','QUBIC':'GATE','RARE':'COINBASE','RATS':'HTX',
        'RAVE':'KRAKEN','RAY':'BINANCE','RDNT':'BINANCE','RECALL':'BINANCE','RED':'BINANCE',
        'RENDER':'BINANCE','REQ':'COINBASE','RESOLV':'BINANCE','REZ':'BINANCE','RIF':'BINANCE',
        'RIVER':'BINANCE','RLC':'KRAKEN','RLS':'COINBASE','RONIN':'COINBASE','ROSE':'BINANCE',
        'RPL':'BINANCE','RSC':'COINBASE','RSR':'BINANCE','RUNE':'BINANCE','RVN':'BINANCE',
        'RVV':'BINANCE','S':'BINANCE','SAFE':'COINBASE','SAGA':'BINANCE','SAHARA':'BINANCE',
        'SAND':'BINANCE','SAPIEN':'COINBASE','SC':'BINANCE','SCR':'OKX','SEI':'BINANCE',
        'SENT':'COINBASE','SFP':'BINANCE','SHELL':'BINANCE','SHIB':'COINBASE','SIGN':'BINANCE',
        'SIREN':'BINANCE','SKL':'BINANCE','SKR':'COINBASE','SKY':'BINANCE','SKYAI':'BINANCE',
        'SLP':'BINANCE','SNX':'BINANCE','SOL':'COINBASE','SOLV':'BINANCE','SOMI':'BINANCE',
        'SONIC':'BYBIT','SOON':'KRAKEN','SOPH':'OKX','SPACE':'BINANCE','SPELL':'COINBASE',
        'SPK':'BINANCE','SPORTFUN':'BINANCE','SPX':'MEXC','SQD':'BINANCE','SSV':'BINANCE',
        'STABLE':'BITGET','STBL':'BINANCE','STEEM':'BINANCE','STG':'BINANCE','STO':'BINANCE',
        'STORJ':'BINANCE','STRK':'BINANCE','STX':'BINANCE','SUI':'BINANCE','SUN':'BINANCE',
        'SUPER':'COINBASE','SUSHI':'BINANCE','SWARMS':'BINANCE','SXT':'BINANCE','SYN':'BINANCE',
        'SYRUP':'BINANCE','T':'BINANCE','TA':'BINANCE','TAC':'MEXC','TAG':'BINANCE',
        'TAIKO':'BINANCE','TAKE':'BITMART','TAO':'BINANCE','TEL':'BINGX','TFUEL':'MEXC',
        'THE':'BINANCE','THETA':'BINANCE','TIA':'COINBASE','TIBBIR':'LBANK','TLM':'BINANCE',
        'TNSR':'BINANCE','TON':'BINANCE','TOSHI':'COINBASE','TOWNS':'COINBASE','TRAC':'COINBASE',
        'TRADOOR':'BINANCE','TRB':'OKX','TREE':'BINANCE','TRIA':'COINBASE','TRU':'BINANCE',
        'TRUMP':'BINANCE','TRUST':'KRAKEN','TRUTH':'OKX','TRX':'BINANCE','TST':'BINANCE',
        'TURBO':'COINBASE','TURTLE':'BINANCE','TUT':'BINANCE','TWT':'BINANCE','UAI':'BINANCE',
        'UB':'BYBIT','ULTIMA':'HTX','UMA':'CAPITALCOM','UNI':'BINANCE','USELESS':'MEXC',
        'USTC':'BINANCE','USUAL':'BINANCE','US':'KRAKEN','VANA':'BINANCE','VANRY':'BINANCE',
        'VELO':'COINBASE','VELVET':'BINANCE','VET':'BINANCE','VFY':'BINANCE','VIC':'BINANCE',
        'VINE':'KRAKEN','VIRTUAL':'BINANCE','VTHO':'BINANCE','VVV':'COINBASE','W':'BINANCE',
        'WAL':'BINANCE','WAVES':'HTX','WAXP':'BINANCE','WCT':'BINANCE','WET':'BINANCE',
        'WHITEWHALE':'BYBIT','WIF':'BINANCE','WLD':'BINANCE','WLFI':'BINANCE','WMTX':'KRAKEN',
        'WOO':'BINANCE','XAI':'BYBIT','XAN':'KRAKEN','XAUT':'BITFINEX','XCH':'BYBIT',
        'XCN':'MEXC','XDC':'BITSTAMP','XEC':'MEXC','XLM':'BINANCE','XMR':'BYBIT',
        'XNO':'BINANCE','XNY':'BINANCE','XPIN':'BINANCE','XPL':'BINANCE','XPR':'MEXC',
        'XPT':'XTCOM','XRP':'BINANCE','XTZ':'BITFINEX','XVG':'BYBIT','XVS':'BINANCE',
        'YALA':'BINANCE','YB':'BYBIT','YFI':'BINANCE','YGG':'OKX','YZY':'BYBIT',
        'ZAMA':'BINANCE','ZBCN':'HTX','ZBT':'BINANCE','ZEC':'MEXC','ZEN':'BINANCE',
        'ZEREBRO':'BINANCE','ZETA':'BINANCE','ZIL':'BINANCE','ZK':'COINBASE','ZKC':'BINANCE',
        'ZKJ':'BINANCE','ZKP':'BINANCE','ZORA':'COINBASE','ZRO':'BINANCE','ZRX':'KRAKEN',
        'ZTC':'MEXC'
    };

    const DEFAULT_TV = ticker => {
        const upper = ticker.toUpperCase();
        // Handle .P (perpetual) suffix â€” strip for lookup, preserve for URL
        const hasPerp = upper.endsWith('.P');
        const clean = hasPerp ? upper.slice(0, -2) : upper;
        const sym = clean.replace(/USDT$|USD$|USDC$/,'');
        const exchange = TV_EXCHANGE_MAP[sym];
        const prefix = exchange ? exchange + ':' : '';
        const hasSuffix = /USDT$|USD$|USDC$/.test(clean);
        const pair = hasSuffix ? clean : sym + 'USDT';
        return `https://www.tradingview.com/chart/xF34dN3g/?symbol=${prefix}${encodeURIComponent(pair)}${hasPerp ? '.P' : ''}`;
    };
    const isAndroid = /Android/i.test(navigator.userAgent);
    const DEFAULT_BX = ticker => {
        const pair = ticker.toUpperCase().replace(/\.P$/,'').replace(/USDT$|USD$|USDC$/,'') + 'USDT';
        if (isAndroid) {
            return `https://www.unixcrypto.net/contract-trade/${pair}`;
        }
        return `https://www.bitunix.com/contract-trade/${pair}`;
    };

    function getTickerLinks() {
        try { return JSON.parse(localStorage.getItem('crypto_ticker_links') || '{}'); }
        catch { return {}; }
    }

    function saveTickerLinks(links) {
        localStorage.setItem('crypto_ticker_links', JSON.stringify(links));
    }

    function getTickerLink(ticker, platform) {
        const links = getTickerLinks();
        const key = ticker.toUpperCase();
        if (links[key] && links[key][platform]) return links[key][platform];
        return platform === 'tv' ? DEFAULT_TV(ticker) : DEFAULT_BX(ticker);
    }

    function openBitunix(ticker) {
        const pair = ticker.toUpperCase().replace(/USDT$|USD$|USDC$/,'') + 'USDT';
        navigator.clipboard.writeText(pair).catch(() => {});
        setTimeout(() => {
            window.open(getTickerLink(ticker, 'bx'), '_blank');
        }, 300);
    }

    function editLinks(ticker) {
        const key = ticker.toUpperCase();
        const links = getTickerLinks();
        const current = links[key] || {};

        const tvUrl = prompt(
            `TradingView URL for ${key}:\n(Leave empty for default)`,
            current.tv || DEFAULT_TV(ticker)
        );
        if (tvUrl === null) return;

        const bxUrl = prompt(
            `Bitunix URL for ${key}:\n(Leave empty for default)`,
            current.bx || DEFAULT_BX(ticker)
        );
        if (bxUrl === null) return;

        if (!links[key]) links[key] = {};
        links[key].tv = tvUrl || '';
        links[key].bx = bxUrl || '';

        if (!links[key].tv) delete links[key].tv;
        if (!links[key].bx) delete links[key].bx;
        if (Object.keys(links[key]).length === 0) delete links[key];

        saveTickerLinks(links);
        renderTickerGrid();
    }

    // ====== API WRITE FUNCTIONS ======
    async function markAction(ticker, signal, price, value, elemId) {
        const sizeInput = document.getElementById(elemId + '-size');
        const entrySize = sizeInput ? sizeInput.value : '';
        const el = document.getElementById(elemId);
        addActedItem(ticker, signal);
        // If Entered, open Bitunix and copy ticker pair
        if (value === 'Entered') {
            const pair = ticker.toUpperCase().replace(/\.P$/,'').replace(/USDT$|USD$|USDC$/,'') + 'USDT';
            navigator.clipboard.writeText(pair);
            window.open(DEFAULT_BX(ticker), '_blank');
            // Set clock start to now (not signal time)
            localStorage.setItem('clock_' + ticker.toUpperCase() + '_' + signal.toLowerCase(), String(Date.now()));
        }
        // Hide immediately
        el.style.transition = 'opacity 0.3s';
        el.style.opacity = '0';
        setTimeout(() => el.style.display = 'none', 300);
        // Send to server via GET (avoids CORS issues with POST)
        const params = new URLSearchParams({
            action: 'update', ticker, signal, price, field: 'action', value
        });
        fireGet(POST_URL + '?' + params).then(() => setTimeout(fetchData, 3000));
    }

    function confirmOutcome(ticker, signal, price, value, elemId, label) {
        if (confirm(label + ' ' + ticker + '?')) {
            markOutcome(ticker, signal, price, value, elemId);
        }
    }

    async function markOutcome(ticker, signal, price, value, elemId) {
        const profitInput = document.getElementById(elemId + '-profit');
        const inputVal = parseFloat(profitInput ? profitInput.value : '') || 0;
        const el = document.getElementById(elemId);

        // Running P&L total stored on the element
        const prevTotal = parseFloat(el.dataset.pnl || '0');

        if (value === 'Won') {
            // Hit TP â€” add to running total, keep card open
            const newTotal = prevTotal + inputVal;
            el.dataset.pnl = newTotal;
            el.dataset.status = 'tp';
            el.style.borderLeftColor = 'var(--green-candle)';

            // Update or create the P&L badge
            let badge = el.querySelector('.pnl-badge');
            if (!badge) {
                const header = el.querySelector('.ticker-header');
                if (header) {
                    header.insertAdjacentHTML('beforeend', '<span class="pnl-badge" style="background:var(--green-dim);color:var(--green-bright)"></span>');
                    badge = el.querySelector('.pnl-badge');
                }
            }
            if (badge) badge.textContent = 'TP ' + (newTotal >= 0 ? '+$' + newTotal.toFixed(2) : '-$' + Math.abs(newTotal).toFixed(2));

            // Update right-side P&L display: TP + amount on same line
            const pnlDisplay = el.querySelector('.pnl-amount');
            if (pnlDisplay) {
                const amtStr = (newTotal >= 0 ? '+$' : '-$') + Math.abs(newTotal).toFixed(2);
                const amtColor = newTotal >= 0 ? 'var(--green-bright)' : 'var(--red-bright)';
                pnlDisplay.style.cssText = 'font-family:Space Mono,monospace;font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:20px;justify-content:flex-end';
                pnlDisplay.innerHTML = `<span style="color:var(--green-bright)">TP</span><span style="color:${amtColor}">${amtStr}</span>`;
            }

            // Save to localStorage + sheet
            saveTradeState(ticker, signal, { status: 'tp', pnl: newTotal });
            const tpParams = new URLSearchParams({ action: 'update', ticker, signal, price, field: 'pnl', profitLocked: newTotal.toFixed(2), tradeStatus: 'tp' });
            fireGet(POST_URL + '?' + tpParams);
            if (profitInput) profitInput.value = '';
            return;

        } else if (value === '0x0') {
            // Breakeven â€” add any input P&L, keep card open
            const newTotal = prevTotal + inputVal;
            el.dataset.pnl = newTotal;
            el.dataset.status = '0x0';
            el.style.borderLeftColor = 'var(--accent)';

            let badge = el.querySelector('.pnl-badge');
            if (!badge) {
                const header = el.querySelector('.ticker-header');
                if (header) {
                    header.insertAdjacentHTML('beforeend', '<span class="pnl-badge" style="background:#4a9eff22;color:var(--accent-glow)"></span>');
                    badge = el.querySelector('.pnl-badge');
                }
            }
            if (badge) badge.textContent = '0x0' + (newTotal !== 0 ? ' $' + newTotal.toFixed(2) : '');

            // Update right-side P&L display: 0x0 + amount on same line
            const pnlDisplay = el.querySelector('.pnl-amount');
            if (pnlDisplay) {
                const amtStr = (newTotal >= 0 ? '+$' : '-$') + Math.abs(newTotal).toFixed(2);
                const amtColor = newTotal > 0 ? 'var(--green-bright)' : newTotal < 0 ? 'var(--red-bright)' : 'var(--accent-glow)';
                pnlDisplay.style.cssText = 'font-family:Space Mono,monospace;font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:20px;justify-content:flex-end';
                pnlDisplay.innerHTML = `<span style="color:var(--accent-glow)">0x0</span><span style="color:${amtColor}">${amtStr}</span>`;
            }

            // Save to localStorage + sheet
            saveTradeState(ticker, signal, { status: '0x0', pnl: newTotal });
            const zParams = new URLSearchParams({ action: 'update', ticker, signal, price, field: 'pnl', profitLocked: newTotal.toFixed(2), tradeStatus: '0x0' });
            fireGet(POST_URL + '?' + zParams);
            if (profitInput) profitInput.value = '';
            return;

        } else {
            // Closed or Stopped Out â€” finalize and send total to sheet
            // Auto-negate positive input for losses (user enters 0.34, we record -0.34)
            const adjustedInput = (value === 'Lost' && inputVal > 0) ? -inputVal : inputVal;
            let grandTotal = prevTotal + adjustedInput;
            // Safety net: if P&L is $0, prompt user to enter it
            if (grandTotal === 0) {
                const entered = prompt('P&L for ' + ticker + '? (negative for loss, blank to skip)');
                if (entered === null) return; // cancelled
                let manualVal = parseFloat(entered) || 0;
                if (value === 'Lost' && manualVal > 0) manualVal = -manualVal;
                grandTotal = prevTotal + manualVal;
            }
            const finalValue = value === 'Lost' ? 'Lost' : 'Closed';
            clearTradeState(ticker, signal);

            el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);

            try {
                const params = new URLSearchParams({
                    action: 'update', ticker, signal, price,
                    field: 'outcome', value: finalValue,
                    profitLocked: grandTotal.toFixed(2)
                });
                await fireGet(POST_URL + '?' + params);

                // Flash the total before fading
                const header = el.querySelector('.ticker-header');
                let badge = el.querySelector('.pnl-badge');
                if (!badge && header) {
                    header.insertAdjacentHTML('beforeend', '<span class="pnl-badge"></span>');
                    badge = el.querySelector('.pnl-badge');
                }
                if (badge) {
                    badge.style.background = grandTotal >= 0 ? 'var(--green-dim)' : 'var(--red-dim)';
                    badge.style.color = grandTotal >= 0 ? 'var(--green-bright)' : 'var(--red-bright)';
                    badge.textContent = grandTotal >= 0 ? '+$' + grandTotal.toFixed(2) : '-$' + Math.abs(grandTotal).toFixed(2);
                }

                // Fade out after a brief moment
                setTimeout(() => {
                    el.style.transition = 'opacity 0.5s, max-height 0.5s';
                    el.style.opacity = '0';
                    el.style.maxHeight = '0';
                    el.style.overflow = 'hidden';
                    el.style.padding = '0';
                    el.style.margin = '0';
                    setTimeout(() => el.remove(), 600);
                }, 1200);

                setTimeout(fetchData, 3000);
            } catch (err) {
                el.querySelectorAll('.action-btn').forEach(b => b.disabled = false);
                alert('Failed to update: ' + err.message);
            }
        }
    }

    async function markPickAction(ticker, signal, price, value, elemId) {
        const el = document.getElementById(elemId);
        const sizeInput = document.getElementById(elemId + '-size');
        const entrySize = sizeInput ? sizeInput.value : '';
        addActedItem(ticker, signal);
        // If Entered, open Bitunix and copy ticker pair
        if (value === 'Entered') {
            const pair = ticker.toUpperCase().replace(/\.P$/,'').replace(/USDT$|USD$|USDC$/,'') + 'USDT';
            navigator.clipboard.writeText(pair);
            window.open(DEFAULT_BX(ticker), '_blank');
            // Set clock start to now (not signal time)
            localStorage.setItem('clock_' + ticker.toUpperCase() + '_' + signal.toLowerCase(), String(Date.now()));
        }
        // Hide immediately
        el.style.transition = 'opacity 0.3s';
        el.style.opacity = '0';
        setTimeout(() => el.style.display = 'none', 300);
        // Send to server via GET (avoids CORS issues with POST)
        const params2 = new URLSearchParams({
            action: 'update', ticker, signal, price, field: 'action', value
        });
        fireGet(POST_URL + '?' + params2).then(() => setTimeout(fetchData, 3000));
    }

    // ====== EMPTY FALLBACK ======
    const EMPTY_DATA = {
        status: 'ok',
        tickers: [],
        recentSignals: [],
        claudePicks: [],
        actionNeeded: [],
        stats: {
            totalTrades: 0, wins: 0, losses: 0, winRate: '0%',
            openPositions: 0, todaySignals: 0, bestWinStreak: 0,
            worstLossStreak: 0, currentStreak: '0',
            bestTicker: 'N/A', worstTicker: 'N/A',
            winRateByScore: {}
        }
    };

    // ====== COMMAND BAR ======
    // Common name â†’ ticker symbol mapping
    const COIN_NAMES = {
        'bitcoin':'BTC','btc':'BTC','ethereum':'ETH','eth':'ETH','solana':'SOL','sol':'SOL',
        'cardano':'ADA','ada':'ADA','dogecoin':'DOGE','doge':'DOGE','ripple':'XRP','xrp':'XRP',
        'polkadot':'DOT','dot':'DOT','chainlink':'LINK','link':'LINK','avalanche':'AVAX','avax':'AVAX',
        'polygon':'POL','pol':'POL','matic':'POL','litecoin':'LTC','ltc':'LTC',
        'uniswap':'UNI','uni':'UNI','aave':'AAVE','pepe':'PEPE',
        'layerzero':'ZRO','zro':'ZRO','stargate':'STG','stg':'STG',
        'aether':'GHST','ghst':'GHST','baby':'BABY','babydoge':'BABY',
        'home':'HOME','shiba':'SHIB','shib':'SHIB','bonk':'BONK',
        'sui':'SUI','sei':'SEI','apt':'APT','aptos':'APT','arb':'ARB','arbitrum':'ARB',
        'op':'OP','optimism':'OP','near':'NEAR','ton':'TON','toncoin':'TON',
        'render':'RENDER','fet':'FET','fetchai':'FET','wif':'WIF','floki':'FLOKI',
        'injective':'INJ','inj':'INJ','jup':'JUP','jupiter':'JUP',
    };

    // Also match any raw symbol from TV_EXCHANGE_MAP
    Object.keys(TV_EXCHANGE_MAP).forEach(sym => {
        COIN_NAMES[sym.toLowerCase()] = sym;
    });

    function parseCommand(input) {
        const text = input.trim().toLowerCase();
        if (!text) return null;

        // Extract dollar amount
        const amountMatch = text.match(/\$\s*(\d+(?:\.\d+)?)/);
        const amount = amountMatch ? amountMatch[1] : null;

        // Detect action
        const isChart = /\bchart\b|\bview\b|\blook\b|\bcheck\b|^!/.test(text);

        // Find ticker - try each word/phrase against COIN_NAMES
        const cmdWords = new Set(['chart','view','look','check','buy','sell','open']);
        const words = text.replace(/\$\s*\d+(?:\.\d+)?/g, '').replace(/[^a-z0-9\s]/g, '').trim().split(/\s+/).filter(w => !cmdWords.has(w));
        let ticker = null;

        // Try multi-word matches first (e.g. "baby doge")
        for (let i = 0; i < words.length; i++) {
            for (let j = Math.min(words.length, i + 3); j > i; j--) {
                const phrase = words.slice(i, j).join('');
                if (COIN_NAMES[phrase]) {
                    ticker = COIN_NAMES[phrase];
                    break;
                }
            }
            if (ticker) break;
            // Try single word
            if (COIN_NAMES[words[i]]) {
                ticker = COIN_NAMES[words[i]];
                break;
            }
        }

        // Fallback: strip common suffixes (.P â†’ p, USDT, USD, USDC) and try again
        if (!ticker) {
            for (let w = 0; w < words.length; w++) {
                let word = words[w];
                if (!(/(?:usdt?|usdc)p?$/.test(word))) continue; // only try words with USD-like suffix
                let base = word.replace(/(?:usdt?|usdc)p?$/, '');
                if (base && base.length >= 2) {
                    // Preserve original suffix (USD vs USDT) for TradingView
                    ticker = word.toUpperCase().replace(/P$/, '');
                    break;
                }
            }
        }

        // Fallback: assume raw word is a coin symbol, append USDT
        if (!ticker) {
            for (let w = 0; w < words.length; w++) {
                if (words[w].length >= 2 && words[w].length <= 10) {
                    ticker = words[w].toUpperCase() + 'USDT';
                    break;
                }
            }
        }

        if (!ticker) return null;
        return { ticker, amount, isChart };
    }

    function executeCommand(input) {
        const result = document.getElementById('commandResult');
        const raw = input.trim();

        // ! command â†’ pass exact symbol to TradingView
        if (raw.startsWith('!')) {
            const sym = raw.substring(1).trim();
            if (!sym) return;
            const url = `https://www.tradingview.com/chart/xF34dN3g/?symbol=${encodeURIComponent(sym)}`;
            window.open(url, '_blank');
            result.className = 'command-result success';
            result.textContent = `Opening ${sym} chart on TradingView`;
            setTimeout(() => result.className = 'command-result', 4000);
            return;
        }

        const cmd = parseCommand(input);

        if (!cmd) {
            result.className = 'command-result error';
            result.textContent = "Couldn't find a ticker. Try something like \"$5 ZRO\" or \"!ACUUSDT.P\"";
            setTimeout(() => result.className = 'command-result', 3000);
            return;
        }

        if (cmd.amount) {
            // Has dollar amount â†’ open Bitunix to trade
            navigator.clipboard.writeText(cmd.amount).then(() => {
                result.className = 'command-result success';
                result.textContent = `Opening ${cmd.ticker} on Bitunix â€” $${cmd.amount} copied to clipboard`;
            });
            setTimeout(() => {
                window.open(DEFAULT_BX(cmd.ticker), '_blank');
            }, 300);
        } else {
            // Just a ticker â†’ open TradingView chart
            window.open(DEFAULT_TV(cmd.ticker), '_blank');
            result.className = 'command-result success';
            result.textContent = `Opening ${cmd.ticker} chart on TradingView`;
        }

        setTimeout(() => result.className = 'command-result', 4000);
    }

    document.getElementById('commandInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            executeCommand(this.value);
            this.value = '';
        }
    });


    // ====== QUOTES ======
    const QUOTES = [
        { text: "The trend is your friend until the end when it bends.", author: "Ed Seykota" },
        { text: "In crypto, the impossible happens about twice a week.", author: "Crypto Wisdom" },
        { text: "Not your keys, not your coins. Not your plan, not your profits.", author: "Crypto Proverb" },
        { text: "The market is never wrong -- opinions often are.", author: "Jesse Livermore" },
        { text: "Cut your losses short and let your profits run.", author: "Jesse Livermore" },
        { text: "Plan your trade and trade your plan.", author: "Richard Dennis" },
        { text: "Risk comes from not knowing what you are doing.", author: "Warren Buffett" },
        { text: "The goal of a successful trader is to make the best trades. Money is secondary.", author: "Alexander Elder" },
        { text: "Markets can remain irrational longer than you can remain solvent.", author: "John Maynard Keynes" },
        { text: "Amateurs think about how much money they can make. Professionals think about how much money they could lose.", author: "Jack Schwager" },
        { text: "You don't need to know what is going to happen next in order to make money.", author: "Mark Douglas" },
        { text: "Every battle is won before it is fought.", author: "Sun Tzu" },
        { text: "There is a time to go long, a time to go short, and a time to go fishing.", author: "Jesse Livermore" },
        { text: "Discipline is the bridge between goals and accomplishment.", author: "Jim Rohn" },
        { text: "The elements of good trading are: cutting losses, cutting losses, and cutting losses.", author: "Ed Seykota" },
        { text: "Do not anticipate and move without market confirmation.", author: "Jesse Livermore" },
        { text: "The best time to buy crypto was yesterday. The second best time is after your signal fires.", author: "Crypto Wisdom" },
        { text: "A 100x means nothing if you can't manage a 2x.", author: "Crypto Proverb" },
        { text: "Patience is not the ability to wait, but the ability to keep a good attitude while waiting.", author: "Joyce Meyer" },
        { text: "The hard work in trading comes in the preparation. The actual process of trading should be effortless.", author: "Jack Schwager" }
    ];

    function showQuote() {
        const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        const textEl = document.getElementById('quoteText');
        const authEl = document.getElementById('quoteAuthor');
        textEl.style.opacity = '0';
        authEl.style.opacity = '0';
        setTimeout(() => {
            textEl.textContent = '"' + q.text + '"';
            authEl.textContent = 'â€” ' + q.author;
            textEl.style.opacity = '0.7';
            authEl.style.opacity = '0.6';
            const mfq = document.getElementById('mobileFooterQuote');
            if (mfq) mfq.innerHTML = '"' + q.text + '"<br><span style="font-size:0.7rem;color:var(--text-dim)">' + 'â€” ' + q.author + '</span>';
        }, 300);
    }
    showQuote();

    // ====== ZEN WISDOM ======
    const ZEN_WISDOMS = [
        "The capybara does not chase the candle. The capybara waits.",
        "A green candle is not a reason to buy. A red candle is not a reason to cry.",
        "Position size is self-respect measured in dollars.",
        "The best trade you ever make might be the one you don't.",
        "FOMO is just fear wearing a different hat.",
        "Your stop loss is not a suggestion. It is a promise to yourself.",
        "The market doesn't care about your entry. Trade what you see, not what you hope.",
        "A capybara sits in hot water and remains calm. Be the capybara.",
        "Zoom out. Then zoom out again. Then go touch grass.",
        "Diamond hands are worthless without a diamond plan.",
        "The chart will be there tomorrow. Your capital might not be.",
        "Three red candles do not make a trend. Neither do three green ones.",
        "The capybara trades the plan. The capybara never revenge trades.",
        "If you can't explain why you're in a trade, you shouldn't be in the trade.",
        "Every master was once a disaster. Every whale was once rekt.",
        "Sleep is the most underrated trading indicator.",
    ];

    function showZenWisdom() {
        const textEl = document.getElementById('zenWisdomText');
        const w = ZEN_WISDOMS[Math.floor(Math.random() * ZEN_WISDOMS.length)];
        textEl.style.opacity = '0';
        setTimeout(() => {
            textEl.textContent = '"' + w + '"';
            textEl.style.opacity = '1';
        }, 200);
    }

    document.getElementById('zenCapybara').addEventListener('click', showZenWisdom);

    // ====== POKEMON SCALING ======
    const POKE_SPRITE = id => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

    const LOCATION_BG = {
        pallet:   'https://archives.bulbagarden.net/media/upload/7/77/Pallet_Town_FRLG.png',
        pewter:   'https://archives.bulbagarden.net/media/upload/c/cf/Pewter_City_FRLG.png',
        cerulean: 'https://archives.bulbagarden.net/media/upload/0/0b/Cerulean_City_FRLG.png',
        vermilion:'https://archives.bulbagarden.net/media/upload/8/8d/Vermilion_City_FRLG.png',
        celadon:  'https://archives.bulbagarden.net/media/upload/e/ee/Celadon_City_FRLG.png',
        fuchsia:  'https://archives.bulbagarden.net/media/upload/d/d0/Fuchsia_City_FRLG.png',
        cinnabar: 'https://archives.bulbagarden.net/media/upload/6/65/Cinnabar_Island_FRLG.png',
        indigo:   'https://archives.bulbagarden.net/media/upload/2/26/Indigo_Plateau_FRLG.png'
    };

    const POKEMON_LEVELS = [
        { min:     0, pokemon: 'Bulbasaur',   pokeId:   1, location: 'pallet' },
        { min:     4, pokemon: 'Ivysaur',     pokeId:   2, location: 'pallet' },
        { min:     7, pokemon: 'Venusaur',    pokeId:   3, location: 'pallet' },
        { min:    11, pokemon: 'Charmander',  pokeId:   4, location: 'pallet' },
        { min:    14, pokemon: 'Charmeleon',  pokeId:   5, location: 'pallet' },
        { min:    20, pokemon: 'Charizard',   pokeId:   6, location: 'pallet' },
        { min:    27, pokemon: 'Squirtle',    pokeId:   7, location: 'pallet' },
        { min:    35, pokemon: 'Wartortle',   pokeId:   8, location: 'pallet' },
        { min:    45, pokemon: 'Blastoise',   pokeId:   9, location: 'pallet' },
        { min:    57, pokemon: 'Caterpie',    pokeId:  10, location: 'pewter' },
        { min:    69, pokemon: 'Metapod',     pokeId:  11, location: 'pewter' },
        { min:    78, pokemon: 'Butterfree',  pokeId:  12, location: 'pewter' },
        { min:    96, pokemon: 'Weedle',      pokeId:  13, location: 'pewter' },
        { min:   106, pokemon: 'Kakuna',      pokeId:  14, location: 'pewter' },
        { min:   128, pokemon: 'Beedrill',    pokeId:  15, location: 'pewter' },
        { min:   142, pokemon: 'Pidgey',      pokeId:  16, location: 'pewter' },
        { min:   156, pokemon: 'Pidgeotto',   pokeId:  17, location: 'pewter' },
        { min:   186, pokemon: 'Pidgeot',     pokeId:  18, location: 'pewter' },
        { min:   204, pokemon: 'Rattata',     pokeId:  19, location: 'pewter' },
        { min:   234, pokemon: 'Raticate',    pokeId:  20, location: 'pewter' },
        { min:   252, pokemon: 'Spearow',     pokeId:  21, location: 'pewter' },
        { min:   278, pokemon: 'Fearow',      pokeId:  22, location: 'pewter' },
        { min:   318, pokemon: 'Ekans',       pokeId:  23, location: 'pewter' },
        { min:   344, pokemon: 'Arbok',       pokeId:  24, location: 'pewter' },
        { min:   379, pokemon: 'Pikachu',     pokeId:  25, location: 'pewter' },
        { min:   419, pokemon: 'Raichu',      pokeId:  26, location: 'pewter' },
        { min:   459, pokemon: 'Sandshrew',   pokeId:  27, location: 'pewter' },
        { min:   485, pokemon: 'Sandslash',   pokeId:  28, location: 'pewter' },
        { min:   513, pokemon: 'Nidoran\u2640', pokeId: 29, location: 'pewter' },
        { min:   548, pokemon: 'Nidorina',    pokeId:  30, location: 'pewter' },
        { min:   598, pokemon: 'Nidoqueen',   pokeId:  31, location: 'pewter' },
        { min:   628, pokemon: 'Nidoran\u2642', pokeId: 32, location: 'pewter' },
        { min:   673, pokemon: 'Nidorino',    pokeId:  33, location: 'pewter' },
        { min:   738, pokemon: 'Nidoking',    pokeId:  34, location: 'pewter' },
        { min:   773, pokemon: 'Clefairy',    pokeId:  35, location: 'cerulean' },
        { min:   853, pokemon: 'Clefable',    pokeId:  36, location: 'cerulean' },
        { min:   893, pokemon: 'Vulpix',      pokeId:  37, location: 'cerulean' },
        { min:   943, pokemon: 'Ninetales',   pokeId:  38, location: 'cerulean' },
        { min:  1028, pokemon: 'Jigglypuff',  pokeId:  39, location: 'cerulean' },
        { min:  1073, pokemon: 'Wigglytuff',  pokeId:  40, location: 'cerulean' },
        { min:  1143, pokemon: 'Zubat',       pokeId:  41, location: 'vermilion' },
        { min:  1203, pokemon: 'Golbat',      pokeId:  42, location: 'vermilion' },
        { min:  1278, pokemon: 'Oddish',      pokeId:  43, location: 'vermilion' },
        { min:  1353, pokemon: 'Gloom',       pokeId:  44, location: 'vermilion' },
        { min:  1443, pokemon: 'Vileplume',   pokeId:  45, location: 'vermilion' },
        { min:  1533, pokemon: 'Paras',       pokeId:  46, location: 'vermilion' },
        { min:  1613, pokemon: 'Parasect',    pokeId:  47, location: 'vermilion' },
        { min:  1678, pokemon: 'Venonat',     pokeId:  48, location: 'vermilion' },
        { min:  1773, pokemon: 'Venomoth',    pokeId:  49, location: 'vermilion' },
        { min:  1828, pokemon: 'Diglett',     pokeId:  50, location: 'vermilion' },
        { min:  1918, pokemon: 'Dugtrio',     pokeId:  51, location: 'vermilion' },
        { min:  1973, pokemon: 'Meowth',      pokeId:  52, location: 'vermilion' },
        { min:  2053, pokemon: 'Persian',     pokeId:  53, location: 'vermilion' },
        { min:  2183, pokemon: 'Psyduck',     pokeId:  54, location: 'vermilion' },
        { min:  2258, pokemon: 'Golduck',     pokeId:  55, location: 'vermilion' },
        { min:  2323, pokemon: 'Mankey',      pokeId:  56, location: 'vermilion' },
        { min:  2423, pokemon: 'Primeape',    pokeId:  57, location: 'vermilion' },
        { min:  2523, pokemon: 'Growlithe',   pokeId:  58, location: 'vermilion' },
        { min:  2663, pokemon: 'Arcanine',    pokeId:  59, location: 'vermilion' },
        { min:  2783, pokemon: 'Poliwag',     pokeId:  60, location: 'vermilion' },
        { min:  2923, pokemon: 'Poliwhirl',   pokeId:  61, location: 'vermilion' },
        { min:  3008, pokemon: 'Poliwrath',   pokeId:  62, location: 'vermilion' },
        { min:  3158, pokemon: 'Abra',        pokeId:  63, location: 'vermilion' },
        { min:  3298, pokemon: 'Kadabra',     pokeId:  64, location: 'vermilion' },
        { min:  3448, pokemon: 'Alakazam',    pokeId:  65, location: 'vermilion' },
        { min:  3618, pokemon: 'Machop',      pokeId:  66, location: 'celadon' },
        { min:  3768, pokemon: 'Machoke',     pokeId:  67, location: 'celadon' },
        { min:  3863, pokemon: 'Machamp',     pokeId:  68, location: 'celadon' },
        { min:  4003, pokemon: 'Bellsprout',  pokeId:  69, location: 'celadon' },
        { min:  4183, pokemon: 'Weepinbell',  pokeId:  70, location: 'celadon' },
        { min:  4353, pokemon: 'Victreebel',  pokeId:  71, location: 'celadon' },
        { min:  4543, pokemon: 'Tentacool',   pokeId:  72, location: 'celadon' },
        { min:  4633, pokemon: 'Tentacruel',  pokeId:  73, location: 'celadon' },
        { min:  4743, pokemon: 'Geodude',     pokeId:  74, location: 'celadon' },
        { min:  4923, pokemon: 'Graveler',    pokeId:  75, location: 'celadon' },
        { min:  5053, pokemon: 'Golem',       pokeId:  76, location: 'celadon' },
        { min:  5233, pokemon: 'Ponyta',      pokeId:  77, location: 'celadon' },
        { min:  5443, pokemon: 'Rapidash',    pokeId:  78, location: 'celadon' },
        { min:  5653, pokemon: 'Slowpoke',    pokeId:  79, location: 'celadon' },
        { min:  5793, pokemon: 'Slowbro',     pokeId:  80, location: 'celadon' },
        { min:  6013, pokemon: 'Magnemite',   pokeId:  81, location: 'fuchsia' },
        { min:  6233, pokemon: 'Magneton',    pokeId:  82, location: 'fuchsia' },
        { min:  6473, pokemon: "Farfetch\u2019d", pokeId: 83, location: 'fuchsia' },
        { min:  6583, pokemon: 'Doduo',       pokeId:  84, location: 'fuchsia' },
        { min:  6693, pokemon: 'Dodrio',      pokeId:  85, location: 'fuchsia' },
        { min:  6913, pokemon: 'Seel',        pokeId:  86, location: 'fuchsia' },
        { min:  7163, pokemon: 'Dewgong',     pokeId:  87, location: 'fuchsia' },
        { min:  7383, pokemon: 'Grimer',      pokeId:  88, location: 'fuchsia' },
        { min:  7503, pokemon: 'Muk',         pokeId:  89, location: 'fuchsia' },
        { min:  7733, pokemon: 'Shellder',    pokeId:  90, location: 'fuchsia' },
        { min:  7923, pokemon: 'Cloyster',    pokeId:  91, location: 'fuchsia' },
        { min:  8083, pokemon: 'Gastly',      pokeId:  92, location: 'fuchsia' },
        { min:  8323, pokemon: 'Haunter',     pokeId:  93, location: 'fuchsia' },
        { min:  8603, pokemon: 'Gengar',      pokeId:  94, location: 'fuchsia' },
        { min:  8833, pokemon: 'Onix',        pokeId:  95, location: 'fuchsia' },
        { min:  8993, pokemon: 'Drowzee',     pokeId:  96, location: 'fuchsia' },
        { min:  9263, pokemon: 'Hypno',       pokeId:  97, location: 'fuchsia' },
        { min:  9483, pokemon: 'Krabby',      pokeId:  98, location: 'fuchsia' },
        { min:  9653, pokemon: 'Kingler',     pokeId:  99, location: 'fuchsia' },
        { min:  9943, pokemon: 'Voltorb',     pokeId: 100, location: 'cinnabar' },
        { min: 10103, pokemon: 'Electrode',   pokeId: 101, location: 'cinnabar' },
        { min: 10373, pokemon: 'Exeggcute',   pokeId: 102, location: 'cinnabar' },
        { min: 10523, pokemon: 'Exeggutor',   pokeId: 103, location: 'cinnabar' },
        { min: 10773, pokemon: 'Cubone',      pokeId: 104, location: 'cinnabar' },
        { min: 10993, pokemon: 'Marowak',     pokeId: 105, location: 'cinnabar' },
        { min: 11203, pokemon: 'Hitmonlee',   pokeId: 106, location: 'cinnabar' },
        { min: 11413, pokemon: 'Hitmonchan',  pokeId: 107, location: 'cinnabar' },
        { min: 11713, pokemon: 'Lickitung',   pokeId: 108, location: 'cinnabar' },
        { min: 11973, pokemon: 'Koffing',     pokeId: 109, location: 'cinnabar' },
        { min: 12183, pokemon: 'Weezing',     pokeId: 110, location: 'cinnabar' },
        { min: 12353, pokemon: 'Rhyhorn',     pokeId: 111, location: 'cinnabar' },
        { min: 12533, pokemon: 'Rhydon',      pokeId: 112, location: 'cinnabar' },
        { min: 12883, pokemon: 'Chansey',     pokeId: 113, location: 'cinnabar' },
        { min: 13073, pokemon: 'Tangela',     pokeId: 114, location: 'cinnabar' },
        { min: 13343, pokemon: 'Kangaskhan',  pokeId: 115, location: 'cinnabar' },
        { min: 13613, pokemon: 'Horsea',      pokeId: 116, location: 'cinnabar' },
        { min: 13893, pokemon: 'Seadra',      pokeId: 117, location: 'cinnabar' },
        { min: 14123, pokemon: 'Goldeen',     pokeId: 118, location: 'cinnabar' },
        { min: 14373, pokemon: 'Seaking',     pokeId: 119, location: 'cinnabar' },
        { min: 14723, pokemon: 'Staryu',      pokeId: 120, location: 'cinnabar' },
        { min: 14903, pokemon: 'Starmie',     pokeId: 121, location: 'cinnabar' },
        { min: 15278, pokemon: 'Mr. Mime',    pokeId: 122, location: 'cinnabar' },
        { min: 15468, pokemon: 'Scyther',     pokeId: 123, location: 'cinnabar' },
        { min: 15728, pokemon: 'Jynx',        pokeId: 124, location: 'cinnabar' },
        { min: 15998, pokemon: 'Electabuzz',  pokeId: 125, location: 'cinnabar' },
        { min: 16268, pokemon: 'Magmar',      pokeId: 126, location: 'cinnabar' },
        { min: 16668, pokemon: 'Pinsir',      pokeId: 127, location: 'cinnabar' },
        { min: 17043, pokemon: 'Tauros',      pokeId: 128, location: 'cinnabar' },
        { min: 17343, pokemon: 'Magikarp',    pokeId: 129, location: 'cinnabar' },
        { min: 17743, pokemon: 'Gyarados',    pokeId: 130, location: 'cinnabar' },
        { min: 18193, pokemon: 'Lapras',      pokeId: 131, location: 'indigo' },
        { min: 18523, pokemon: 'Ditto',       pokeId: 132, location: 'indigo' },
        { min: 18787, pokemon: 'Eevee',       pokeId: 133, location: 'indigo' },
        { min: 19227, pokemon: 'Vaporeon',    pokeId: 134, location: 'indigo' },
        { min: 19694, pokemon: 'Jolteon',     pokeId: 135, location: 'indigo' },
        { min: 20002, pokemon: 'Flareon',     pokeId: 136, location: 'indigo' },
        { min: 20310, pokemon: 'Porygon',     pokeId: 137, location: 'indigo' },
        { min: 20596, pokemon: 'Omanyte',     pokeId: 138, location: 'indigo' },
        { min: 20827, pokemon: 'Omastar',     pokeId: 139, location: 'indigo' },
        { min: 21212, pokemon: 'Kabuto',      pokeId: 140, location: 'indigo' },
        { min: 21679, pokemon: 'Kabutops',    pokeId: 141, location: 'indigo' },
        { min: 22009, pokemon: 'Aerodactyl',  pokeId: 142, location: 'indigo' },
        { min: 22421, pokemon: 'Snorlax',     pokeId: 143, location: 'indigo' },
        { min: 22696, pokemon: 'Articuno',    pokeId: 144, location: 'indigo' },
        { min: 23219, pokemon: 'Zapdos',      pokeId: 145, location: 'indigo' },
        { min: 23460, pokemon: 'Moltres',     pokeId: 146, location: 'indigo' },
        { min: 23873, pokemon: 'Dratini',     pokeId: 147, location: 'indigo' },
        { min: 24285, pokemon: 'Dragonair',   pokeId: 148, location: 'indigo' },
        { min: 24643, pokemon: 'Dragonite',   pokeId: 149, location: 'indigo' },
        { min: 25000, pokemon: 'Mewtwo',      pokeId: 150, location: 'indigo' },
        { min: 30000, pokemon: 'Mew',         pokeId: 151, location: 'indigo' }
    ];

    function getPokemonLevel(pnl) {
        let level = POKEMON_LEVELS[0];
        for (const l of POKEMON_LEVELS) {
            if (pnl >= l.min) level = l;
        }
        return level;
    }

    function getNextPokemonLevel(currentLevel) {
        const idx = POKEMON_LEVELS.indexOf(currentLevel);
        if (idx >= 0 && idx < POKEMON_LEVELS.length - 1) return POKEMON_LEVELS[idx + 1];
        return null;
    }

    // Compute 5 trade sizes for any profit level
    function getCryptoSizes(profit) {
        const p = Math.max(0, profit);
        // $0-$125: early progression lookup table
        const SIZE_TABLE = [
            [0,[1,1,1,1,1]], [4,[2,1,1,1,1]], [8,[2,2,1,1,1]], [12,[2,2,2,1,1]],
            [16,[2,2,2,2,1]], [20,[2,2,2,2,2]], [28,[3,2,2,2,2]], [35,[3,3,2,2,2]],
            [45,[3,3,3,2,2]], [55,[3,3,3,3,2]], [65,[3,3,3,3,3]], [72,[4,3,3,3,3]],
            [78,[4,4,3,3,3]], [84,[4,4,4,3,3]], [92,[4,4,4,4,3]], [100,[4,4,4,4,4]],
            [105,[5,4,4,4,4]], [110,[5,5,4,4,4]], [115,[5,5,5,4,4]], [120,[5,5,5,5,4]],
            [125,[5,5,5,5,5]]
        ];
        if (p <= 125) {
            let sizes = SIZE_TABLE[0][1];
            for (const [min, s] of SIZE_TABLE) { if (p >= min) sizes = s; }
            return sizes.slice();
        }
        // $125+: smooth power curve, scales with P&L growth
        const base = Math.round(5 + Math.pow((p - 125) / 47, 0.87));
        const spread = Math.max(1, Math.round(base * 0.05));
        const t1 = base + spread;
        const t2 = base;
        const t3 = base;
        const t4 = Math.max(1, base - spread);
        const t5 = Math.max(1, Math.ceil(base / 2));
        return [t1, t2, t3, t4, t5];
    }

    // Scout trade size â€” power curve: $1 early, $3-5 mid, $14-16 at Mewtwo/Mew
    function getScoutSize(profit) {
        if (profit <= 0) return 1;
        return Math.max(1, Math.floor(1 + Math.pow(profit / 1200, 0.85)));
    }

    function renderPokemon(stats) {
        window._lastStats = stats;
        const box = document.getElementById('pokemonBox');
        if (!box) return;
        const pnl = parseFloat(stats.netPnl) || 0;
        const openCount = parseInt(stats.openPositions) || 0;

        // Determine active P&L (organic or DCA-boosted)
        const activePnl = dcaMode ? pnl + dcaTotal : pnl;
        const organicLevel = getPokemonLevel(pnl);
        const organicIdx = POKEMON_LEVELS.indexOf(organicLevel) + 1;

        const level = getPokemonLevel(activePnl);
        const nextLevel = getNextPokemonLevel(level);
        const levelIdx = POKEMON_LEVELS.indexOf(level) + 1;
        const sizes = getCryptoSizes(level.min);
        const totalRisk = sizes.reduce((a, b) => a + b, 0);

        const pnlStr = pnl >= 0 ? '+$' + pnl.toFixed(2) : '-$' + Math.abs(pnl).toFixed(2);
        const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'zero';

        const xpFrom = level.min;
        const xpTo = nextLevel ? nextLevel.min : level.min;
        const xpRange = xpTo - xpFrom;
        const xpProgress = xpRange > 0 ? Math.max(0, Math.min(100, ((activePnl - xpFrom) / xpRange) * 100)) : 100;

        // Build size chips with pokeball icons â€” click to toggle used/available
        const pokeballSvg = `<svg class="pokeball-svg" viewBox="0 0 20 20"><circle class="ball-outline" cx="10" cy="10" r="9"/><path class="ball-top" d="M1.3,10 A8.7,8.7 0 0 1 18.7,10 Z"/><path class="ball-bottom" d="M1.3,10 A8.7,8.7 0 0 0 18.7,10 Z"/><line class="ball-line" x1="1" y1="10" x2="19" y2="10"/><circle class="ball-center" cx="10" cy="10" r="3"/></svg>`;
        let sizeChips = '';
        const usedSlots = JSON.parse(localStorage.getItem('pokeball_used') || '[false,false,false,false,false]');
        for (let i = 0; i < 5; i++) {
            const cls = usedSlots[i] ? 'used' : i === 0 ? 'lead' : i === 4 ? 'half' : 'mid';
            sizeChips += `<span class="pokemon-size-chip ${cls}" onclick="togglePokeball(${i})" style="cursor:pointer">${pokeballSvg}<span class="ball-amt">$${sizes[i]}</span></span>`;
        }

        const needStr = nextLevel ? '$' + (nextLevel.min - activePnl).toFixed(2) + ' to Evolve' : '';

        let html = `<div class="pokemon-header">
            <div class="pokemon-level-name">${dcaMode ? 'DCA ' : ''}Lv.${levelIdx} \u2014 ${level.pokemon}</div>
            <img class="pokemon-sprite" src="${POKE_SPRITE(level.pokeId)}" alt="${level.pokemon}">
            <div class="pokemon-pnl ${pnlClass}">P&L: ${pnlStr}${needStr ? ' <span style="color:var(--accent-glow);font-size:0.85rem">&middot; ' + needStr + '</span>' : ''}</div>
            <div class="pokemon-sizes">${sizeChips}</div>
        </div>`;

        // Show DCA health when DCA is on
        if (dcaMode && dcaTotal > 0) {
            const trend = stats.trend || {};
            const pnl7d = trend.avg7d ? trend.avg7d.pnl : 0;
            const pnl14d = trend.avg14d ? trend.avg14d.pnl : 0;
            const roiPct = dcaTotal > 0 ? (pnl / dcaTotal * 100) : 0;
            const roiStr = roiPct >= 0 ? '+' + roiPct.toFixed(0) + '%' : roiPct.toFixed(0) + '%';

            let healthLabel, healthClass;
            if (pnl7d >= 0 && pnl >= 0) {
                healthLabel = 'HEALTHY';
                healthClass = 'healthy';
            } else if (pnl7d < 0 && pnl14d >= 0) {
                healthLabel = 'CAUTION';
                healthClass = 'caution';
            } else {
                healthLabel = 'DANGER';
                healthClass = 'danger';
            }

            html += `<div class="dca-health">`;
            html += `<div><span class="health-status ${healthClass}">${healthLabel}</span></div>`;
            html += `<div class="health-detail">Deposited: $${dcaTotal.toFixed(2)} &middot; Trading P&L: ${pnlStr} &middot; 7d: ${pnl7d >= 0 ? '+' : ''}$${pnl7d.toFixed(2)}</div>`;
            html += `<div class="health-roi ${roiPct >= 0 ? 'positive' : 'negative'}">ROI: ${roiStr} of deposits earned back</div>`;
            html += `</div>`;

            // Organic level + deposit info
            if (organicIdx !== levelIdx) {
                html += `<div class="dca-organic-label"><img src="${POKE_SPRITE(organicLevel.pokeId)}" alt="${organicLevel.pokemon}"> Organic: Lv.${organicIdx} ${organicLevel.pokemon} ($${pnl.toFixed(2)} P&L)</div>`;
            }
        } else if (dcaMode) {
            html += `<div class="dca-deposit-total">DCA active â€” tap Level Up to start</div>`;
        }

        html += `<div class="pokemon-xp-bar">
            <div class="pokemon-xp-track">
                <div class="pokemon-xp-fill" style="width:${xpProgress}%"></div>
            </div>
            <div class="pokemon-xp-labels">
                <span>$${xpFrom.toLocaleString()}</span>
                <span>${xpProgress.toFixed(0)}%</span>
                <span>${nextLevel ? '$' + xpTo.toLocaleString() : 'MAX'}</span>
            </div>
        </div>`;

        if (nextLevel) {
            html += `<div class="pokemon-next-evolve">${level.pokemon} evolves at $${nextLevel.min.toLocaleString()} profit \u2014 Total risk: $${totalRisk}</div>`;
        } else {
            html += `<div class="pokemon-next-evolve">MAX LEVEL \u2014 You are the very best!</div>`;
        }

        // Scout trade info (uses active P&L for budget)
        const scoutSz = getScoutSize(activePnl);
        const exposureBudget = Math.floor(activePnl * 0.25);
        const mainExposure = sizes.slice(0, Math.min(openCount, 5)).reduce((a, b) => a + b, 0);
        const scoutBudget = Math.max(0, exposureBudget - mainExposure);
        const scoutsAvail = scoutSz > 0 ? Math.floor(scoutBudget / scoutSz) : 0;
        const scoutClass = scoutsAvail <= 0 ? 'scout-warn' : 'scout-val';
        if (activePnl > 0) {
            html += `<div class="pokemon-scout-info">Scout: <span class="scout-val">$${scoutSz}</span> &middot; Budget: <span class="scout-val">$${exposureBudget}</span> (25%) &middot; <span class="${scoutClass}">${scoutsAvail} scouts</span> available</div>`;
        }

        if (level.location && LOCATION_BG[level.location]) {
            box.style.setProperty('--location-bg', `url('${LOCATION_BG[level.location]}')`);
        }
        box.innerHTML = html;
        updateDCAControls();
        checkPokemonLevelUp(activePnl);
    }

    // ====== POKEMON LEVEL UP ======
    const POKE_LEVEL_KEY = 'crypto_pokemon_level';
    function getUnlockedPokeLevel() { return parseFloat(localStorage.getItem(POKE_LEVEL_KEY) || '0'); }
    function setUnlockedPokeLevel(val) { localStorage.setItem(POKE_LEVEL_KEY, String(val)); }

    function checkPokemonLevelUp(pnl) {
        const current = getPokemonLevel(pnl);
        const unlocked = getUnlockedPokeLevel();
        if (current.min > unlocked && unlocked >= 0) {
            showPokemonLevelUp(current);
            setUnlockedPokeLevel(current.min);
        }
    }

    function showPokemonLevelUp(level) {
        const overlay = document.getElementById('levelupOverlay');
        const sprite = document.getElementById('levelupSprite');
        const detail = document.getElementById('levelupDetail');
        const pokename = document.getElementById('levelupPokename');
        const sizesEl = document.getElementById('levelupSizes');
        const levelIdx = POKEMON_LEVELS.indexOf(level) + 1;
        const sizes = getCryptoSizes(level.min);

        sprite.src = POKE_SPRITE(level.pokeId);
        sprite.className = 'levelup-pokemon evolving';
        pokename.textContent = level.pokemon;
        detail.innerHTML = `Lv.${levelIdx} \u2014 Profit hit <span style="color:var(--green-bright);font-weight:700">$${level.min.toLocaleString()}</span>`;
        sizesEl.textContent = sizes.map(s => '$' + s).join(' / ');
        overlay.style.display = 'flex';
        setTimeout(() => { sprite.className = 'levelup-pokemon'; }, 1500);
    }

    function dismissLevelUp() {
        const overlay = document.getElementById('levelupOverlay');
        overlay.style.transition = 'opacity 0.4s';
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.style.opacity = '';
            overlay.style.transition = '';
        }, 400);
    }

    // ====== INIT ======
    fetchData();
    fetchWeeklyTasks();

    // ====== SERVICE WORKER ======
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
    }
</script>

</body>
</html>
